<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Central Public School â€” Management System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style></style>

<!-- ADD LOADER STYLES -->
<style>
.loader{position:fixed;inset:0;background:rgba(255,255,255,.95);display:none;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px}
.loader.show{display:flex}
.spinner{width:50px;height:50px;border:4px solid var(--border);border-top-color:var(--royal);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
:root{--navy:#0f1b2d;--deep:#1a2d4a;--royal:#1e3f6e;--gold:#c9a84c;--gold-light:#e8c96a;--cream:#faf8f3;--white:#fff;--success:#2d9b5a;--danger:#c0392b;--warning:#e67e22;--info:#2471a3;--text-dark:#0f1b2d;--text-mid:#3d5a80;--text-light:#6b8cae;--border:#dde4ed;--shadow:0 4px 24px rgba(15,27,45,.10);--shadow-lg:0 12px 48px rgba(15,27,45,.18)}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--text-dark);min-height:100vh}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-box{background:#fff;border-radius:16px;padding:40px;max-width:420px;width:100%;box-shadow:var(--shadow-lg)}
.login-box h1{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:800;color:var(--navy);text-align:center;margin-bottom:8px}
.login-box p{text-align:center;color:var(--text-light);font-size:.9rem;margin-bottom:30px}
.hdr{background:var(--navy);color:#fff;padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:68px;box-shadow:0 2px 16px rgba(15,27,45,.3);position:sticky;top:0;z-index:200}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:44px;height:44px;background:var(--gold);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo h1{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:800;line-height:1.1}
.logo span{font-size:.68rem;color:var(--gold-light);font-weight:400;letter-spacing:1.5px;text-transform:uppercase;display:block}
.sess-tag{background:rgba(201,168,76,.18);border:1px solid var(--gold);color:var(--gold-light);padding:5px 12px;border-radius:20px;font-size:.75rem;font-weight:500;letter-spacing:.5px}
.app{display:grid;grid-template-columns:210px 1fr;min-height:calc(100vh - 68px)}
.sidebar{background:var(--navy);padding:20px 0;border-right:1px solid rgba(255,255,255,.06)}
.nav-lbl{font-size:.62rem;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text-light);padding:0 18px;margin:14px 0 6px}
.ni{display:flex;align-items:center;gap:10px;padding:11px 18px;cursor:pointer;color:#7a9abf;font-size:.87rem;font-weight:500;border-left:3px solid transparent;transition:all .18s;user-select:none}
.ni:hover{background:rgba(255,255,255,.05);color:#fff}
.ni.active{color:var(--gold-light);background:rgba(201,168,76,.1);border-left-color:var(--gold)}
.ni-ic{font-size:1rem;width:20px;text-align:center}
.mc{padding:28px;overflow-y:auto;max-height:calc(100vh - 68px)}
.page{display:none}.page.active{display:block}
.ph{margin-bottom:24px}
.ph h2{font-family:'Playfair Display',serif;font-size:1.75rem;font-weight:800;color:var(--navy)}
.ph p{color:var(--text-light);font-size:.87rem;margin-top:3px}
.card{background:#fff;border-radius:12px;padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:18px}
.ct{font-size:.95rem;font-weight:600;color:var(--navy);margin-bottom:16px;display:flex;align-items:center;gap:7px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.fg{margin-bottom:16px}
.fg label{display:block;margin-bottom:5px;font-size:.75rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:.9rem;font-family:'DM Sans',sans-serif;color:var(--text-dark);background:#fff;transition:all .2s;outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--royal);box-shadow:0 0 0 3px rgba(30,63,110,.08)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border:none;border-radius:8px;cursor:pointer;font-size:.85rem;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .18s}
.btn-p{background:var(--royal);color:#fff}.btn-p:hover{background:var(--deep);transform:translateY(-1px);box-shadow:0 4px 12px rgba(30,63,110,.3)}
.btn-g{background:var(--gold);color:var(--navy)}.btn-g:hover{background:var(--gold-light);transform:translateY(-1px)}
.btn-s{background:var(--success);color:#fff}.btn-s:hover{background:#23844a;transform:translateY(-1px)}
.btn-d{background:var(--danger);color:#fff}.btn-d:hover{background:#a93226;transform:translateY(-1px)}
.btn-i{background:var(--info);color:#fff}.btn-i:hover{background:#1a5f88;transform:translateY(-1px)}
.btn-o{background:transparent;border:1.5px solid var(--border);color:var(--text-mid)}.btn-o:hover{border-color:var(--royal);color:var(--royal)}
.btn-sm{padding:6px 12px;font-size:.78rem;border-radius:7px}
.btn-xs{padding:4px 10px;font-size:.73rem;border-radius:6px}
.srow{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.sbox{background:#fff;border-radius:12px;padding:18px 20px;border:1px solid var(--border);box-shadow:var(--shadow)}
.snum{font-family:'Playfair Display',serif;font-size:2rem;font-weight:800;color:var(--navy);line-height:1}
.slbl{font-size:.75rem;color:var(--text-light);margin-top:3px;font-weight:500}
.sic{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;margin-bottom:10px}
.si-b{background:rgba(30,63,110,.1)}.si-g{background:rgba(45,155,90,.1)}.si-r{background:rgba(192,57,43,.1)}.si-gold{background:rgba(201,168,76,.15)}
.sgrid{display:grid;gap:12px}
.sc{background:#fff;border-radius:11px;border:1px solid var(--border);padding:16px 18px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow);transition:all .18s}
.sc:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.av{width:46px;height:46px;border-radius:11px;background:linear-gradient(135deg,var(--royal),var(--deep));display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;font-weight:700;font-family:'Playfair Display',serif;flex-shrink:0}
.sm{flex:1;min-width:0}
.sm h3{font-size:.93rem;font-weight:700;color:var(--navy)}
.sm .sub{font-size:.77rem;color:var(--text-light);margin-top:3px;display:flex;gap:12px;flex-wrap:wrap}
.bdg{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:.7rem;font-weight:600}
.bdg-c{background:rgba(30,63,110,.1);color:var(--royal)}
.bdg-s{background:rgba(201,168,76,.15);color:#9a6f00}
.bdg-paid{background:rgba(45,155,90,.1);color:var(--success)}
.sa{display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0}
.fbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:flex-end}
.fbar .fg{margin-bottom:0;min-width:140px;flex:1}
.sb{position:relative;flex:2}
.sb input{padding-left:38px!important}
.si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-light);pointer-events:none}
.modal{position:fixed;inset:0;background:rgba(10,18,30,.75);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter:blur(4px)}
.modal.open{display:flex}
.mbox{background:#fff;border-radius:16px;padding:28px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(10,18,30,.35);animation:mIn .2s ease}
.mbox.mw{max-width:860px}
@keyframes mIn{from{opacity:0;transform:scale(.96) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.mhdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.mhdr h3{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:800;color:var(--navy)}
.mcl{width:34px;height:34px;border-radius:7px;background:var(--cream);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text-light);transition:all .2s}
.mcl:hover{background:#ffe0dd;color:var(--danger)}
.sin-w{position:relative;margin:18px 0}
.sin-w input{width:100%;padding:14px 18px;font-size:1.05rem;font-family:'DM Mono',monospace;border:2.5px solid var(--royal);border-radius:11px;outline:none;color:var(--navy);transition:all .2s}
.sin-w input:focus{box-shadow:0 0 0 4px rgba(30,63,110,.12)}
.sfeed{padding:12px 16px;border-radius:9px;margin-top:14px;font-size:.92rem;font-weight:500;min-height:54px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:4px}
.sfeed.suc{background:rgba(45,155,90,.1);color:var(--success);border:1px solid rgba(45,155,90,.25)}
.sfeed.err{background:rgba(192,57,43,.1);color:var(--danger);border:1px solid rgba(192,57,43,.2)}
.sfeed.wrn{background:rgba(230,126,34,.1);color:var(--warning);border:1px solid rgba(230,126,34,.2)}
.agrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px}
.ac{padding:11px 14px;border-radius:9px;border:1px solid;display:flex;flex-direction:column;gap:3px}
.ac.pres{background:rgba(45,155,90,.07);border-color:rgba(45,155,90,.25)}
.ac.abs{background:rgba(192,57,43,.05);border-color:rgba(192,57,43,.18)}
.an{font-weight:700;font-size:.87rem;color:var(--navy)}
.as{font-size:.75rem;color:var(--text-light)}
.at{font-family:'DM Mono',monospace;font-size:.77rem;color:var(--text-mid)}
.qrc{display:inline-block;text-align:center;padding:20px 18px;border:2px solid var(--navy);border-radius:12px;background:#fff}
.qrh{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:800;color:var(--navy)}
.qrs{font-size:.72rem;color:var(--text-light);margin:2px 0 10px}
.qrn{font-size:.95rem;font-weight:700;color:var(--navy);margin-top:7px}
.qrroll{font-family:'DM Mono',monospace;font-size:.8rem;color:var(--text-mid)}
.twrap{position:fixed;bottom:24px;right:24px;z-index:3000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--navy);color:#fff;padding:11px 18px;border-radius:9px;font-size:.85rem;font-weight:500;box-shadow:var(--shadow-lg);animation:tIn .25s ease;display:flex;align-items:center;gap:9px;min-width:240px}
@keyframes tIn{from{opacity:0;transform:translateX(28px)}to{opacity:1;transform:translateX(0)}}
.toast.suc{border-left:4px solid var(--success)}.toast.err{border-left:4px solid var(--danger)}.toast.inf{border-left:4px solid var(--info)}
.empty{text-align:center;padding:50px 20px;color:var(--text-light)}
.empty .ei{font-size:2.8rem;margin-bottom:10px}
.tpills{display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap}
.tp{padding:7px 16px;border-radius:20px;font-size:.8rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);color:var(--text-mid);background:#fff;transition:all .18s;font-family:'DM Sans',sans-serif}
.tp.active{background:var(--royal);color:#fff;border-color:var(--royal)}
.tp:hover:not(.active){border-color:var(--royal);color:var(--royal)}
.stab{display:none}.stab.active{display:block}
.sdiv{display:flex;align-items:center;gap:10px;color:var(--text-light);font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin:20px 0 14px}
.sdiv::before,.sdiv::after{content:'';flex:1;height:1px;background:var(--border)}
.crow{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:16px}
.crow .fg{margin-bottom:0;min-width:150px}
.notice-card{background:#fff;border-radius:11px;border:1px solid var(--border);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
.notice-card h4{color:var(--navy);font-size:.95rem;font-weight:700;margin-bottom:5px}
.notice-card .meta{font-size:.72rem;color:var(--text-light);margin-bottom:8px}
.notice-card .msg{font-size:.85rem;color:var(--text-dark);line-height:1.5}
.stu-check{margin-right:8px;width:18px;height:18px;cursor:pointer}
@media print{body>*:not(#pr){display:none!important}#pr{display:block!important;position:absolute;top:0;left:0;width:100%}.np{display:none!important}}
@media(max-width:860px){.app{grid-template-columns:1fr}.sidebar{display:flex;flex-wrap:wrap;padding:10px;gap:3px}.nav-lbl{display:none}.ni{border-left:none;border-radius:7px;padding:7px 10px;font-size:.78rem}.srow{grid-template-columns:repeat(2,1fr)}.fr{grid-template-columns:1fr}}
</style>
</head>
<body>

<body>

<!-- ADD LOADER -->
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p style="color:var(--text-mid);font-size:.9rem;font-weight:500">Loading...</p>
</div>

<!-- LOGIN PAGE -->
       <div class="fg">
  <label>Username</label>
  <input type="email" id="loginUser" required placeholder="Enter email">
</div>
      <div class="fg">
        <label>Password</label>
        <input type="password" id="loginPass" required placeholder="Enter password">
      </div>
      <button type="submit" class="btn btn-p" style="width:100%;justify-content:center">Login</button>
    </form>
    <p style="margin-top:20px;font-size:.78rem;color:var(--text-mid);text-align:center">
  New user? Enter email and password (min 6 chars) to auto-create account
</p>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">
<header class="hdr">
  <div class="logo">
    <div class="logo-icon">ğŸ“</div>
    <div>
      <h1>Central Public School</h1>
      <span>Management System</span>
    </div>
  </div>
 <div style="display:flex;align-items:center;gap:8px">
  <span class="sess-tag" id="sessTag">Session 2026â€“27</span>
  <span style="font-size:.7rem;color:var(--gold-light)" id="userEmail"></span>
  <button class="btn btn-d btn-sm" onclick="logout()">Logout</button>
</div>
</header>

<div class="app">
  <nav class="sidebar">
    <div class="nav-lbl">Main</div>
    <div class="ni active" onclick="goP('dashboard',this)"><span class="ni-ic">ğŸ“Š</span> Dashboard</div>
    <div class="ni" onclick="goP('register',this)"><span class="ni-ic">âœ</span> Register</div>
    <div class="ni" onclick="goP('students',this)"><span class="ni-ic">ğŸ‘¥</span> Students</div>
    <div class="nav-lbl">Operations</div>
    <div class="ni" onclick="goP('attendance',this)"><span class="ni-ic">ğŸ“‹</span> Attendance</div>
    <div class="ni" onclick="goP('billing',this)"><span class="ni-ic">ğŸ’³</span> Billing</div>
    <div class="ni" onclick="goP('notices',this)"><span class="ni-ic">ğŸ“¢</span> Notices</div>
    <div class="ni" onclick="goP('reports',this)"><span class="ni-ic">ğŸ“ˆ</span> Reports</div>
    <div class="nav-lbl">Settings</div>
    <div class="ni" onclick="goP('sessions',this)"><span class="ni-ic">ğŸ“</span> Sessions</div>
    <div class="ni" onclick="goP('settings',this)"><span class="ni-ic">âš™</span> Settings</div>
  </nav>

  <main class="mc">
    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="ph"><h2>Dashboard</h2><p>School overview</p></div>
      <div class="srow" id="dStats"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
        <div class="card"><div class="ct">ğŸ“… Today's Attendance</div><div id="dAtt"></div></div>
        <div class="card"><div class="ct">ğŸ’° Recent Bills</div><div id="dBills"></div></div>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="page-register" class="page">
      <div class="ph"><h2>Register Student</h2><p>Add to current session</p></div>
      <div class="card">
        <form id="sForm" onsubmit="regStudent(event)">
          <div class="fr">
            <div class="fg"><label>Student Name *</label><input id="rn" required placeholder="Full name"></div>
            <div class="fg"><label>Class *</label><select id="rc" required onchange="updateRollPreview()"><option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          </div>
          <div class="fr">
            <div class="fg"><label>Date of Birth *</label><input type="date" id="rd" required></div>
            <div class="fg">
              <label>Roll Number *</label>
              <input id="rr" required placeholder="Auto-generated" readonly style="background:#f8f9fa">
              <small style="color:var(--text-light);font-size:.7rem;margin-top:3px;display:block">Auto-assigned for each class</small>
            </div>
          </div>
          <div class="fr">
            <div class="fg"><label>Parent Name *</label><input id="rp" required placeholder="Father/Mother"></div>
            <div class="fg"><label>Phone *</label><input id="rpm" pattern="[0-9]{10}" required placeholder="10 digit mobile"></div>
          </div>
          <div class="fr">
            <div class="fg"><label>Date of Joining *</label><input type="date" id="rj" required></div>
            <div class="fg"><label>Monthly Fee (â‚¹) *</label><input type="number" id="rf" required placeholder="e.g. 1500"></div>
          </div>
          <div class="fg"><label>Address</label><textarea id="ra" rows="2" placeholder="Optional"></textarea></div>
          <div style="display:flex;gap:9px;margin-top:6px">
            <button type="submit" class="btn btn-p">âœ“ Register</button>
            <button type="button" class="btn btn-o" onclick="clrForm()">Clear</button>
          </div>
        </form>
      </div>
    </div>

    <!-- STUDENTS -->
    <div id="page-students" class="page">
      <div class="ph" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div><h2>Students</h2><p><span id="scnt">0</span> total</p></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-o btn-sm" onclick="showDownloadQR()">ğŸ–¼ Download QR Codes</button>
          <button class="btn btn-p btn-sm" onclick="goP('register',document.querySelector('[onclick*=register]'))">+ Add</button>
        </div>
      </div>
      <div class="fbar">
        <div class="sb"><span class="si">ğŸ”</span><input type="text" id="srch" placeholder="Search name, roll..." oninput="renderStudents()"></div>
        <div class="fg"><label>Class</label><select id="fCls" onchange="renderStudents()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        <div class="fg"><label>Session</label><select id="fSess" onchange="renderStudents()"><option value="">All Sessions</option></select></div>
      </div>
      <div id="sGrid" class="sgrid"></div>
    </div>

    <!-- ATTENDANCE -->
    <div id="page-attendance" class="page">
      <div class="ph"><h2>Mark Attendance</h2><p>Scan QR or enter roll number</p></div>
      <div style="max-width:500px;margin:0 auto;text-align:center;padding:16px 0">
        <div style="font-size:3.2rem">ğŸ“·</div>
        <p style="color:var(--text-light);font-size:.88rem;margin:8px 0">Scan QR code or type roll number below</p>
        <div class="sin-w"><input type="text" id="scanIn" placeholder="Roll Number..." onkeydown="if(event.key==='Enter')markAtt()" autocomplete="off"></div>
        <button class="btn btn-p" style="width:100%;justify-content:center;padding:13px" onclick="markAtt()">âœ“ Mark Present</button>
        <div id="sFeed" class="sfeed" style="display:none"></div>
      </div>
      <div class="sdiv">Attendance Log</div>
      <div class="crow">
        <div class="fg"><label>Date</label><input type="date" id="aDate" onchange="renderAttR()"></div>
        <div class="fg"><label>Class</label><select id="aCls" onchange="renderAttR()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        <button class="btn btn-o btn-sm np" onclick="window.print()" style="align-self:flex-end">ğŸ–¼ Print</button>
      </div>
      <div class="srow" id="aStats" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px"></div>
      <div id="aReport"></div>
    </div>

    <!-- BILLING -->
    <div id="page-billing" class="page">
      <div class="ph"><h2>Fee Management</h2><p>Generate, track and print bills</p></div>
      <div class="tpills">
        <div class="tp active" onclick="swBTab('gen',this)">ğŸ“ Generate Bill</div>
        <div class="tp" onclick="swBTab('ov',this)">ğŸ“Š Monthly Overview</div>
        <div class="tp" onclick="swBTab('hist',this)">ğŸ“‚ Bill History</div>
      </div>

      <div id="bt-gen" class="stab active">
        <div class="fr" style="margin-bottom:0">
          <div class="fg"><label>Select Class</label><select id="bCls" onchange="loadBStu()"><option value="">Choose class</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <div class="fg"><label>Select Student</label><select id="bStu" onchange="loadSBill()"><option value="">Choose student</option></select></div>
        </div>
        <div class="fr">
          <div class="fg"><label>Billing Month</label><select id="bMo"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Year</label><select id="bYr"><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option></select></div>
        </div>
        <div id="bPrevW" style="display:none">
          <div id="bPrev"></div>
          <div class="np" style="display:flex;gap:9px;margin-top:14px;justify-content:center">
            <button class="btn btn-s" onclick="saveBill()">ğŸ’¾ Save (Paid)</button>
            <button class="btn btn-p" onclick="printBill()">ğŸ–¼ Print</button>
            <button class="btn btn-g" onclick="sendBillSMS()">ğŸ“± Send SMS</button>
          </div>
        </div>
      </div>

      <div id="bt-ov" class="stab">
        <div class="crow">
          <div class="fg"><label>Month</label><select id="ovMo"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Year</label><select id="ovYr"><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option></select></div>
          <div class="fg"><label>Class</label><select id="ovCls"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <button class="btn btn-p btn-sm" onclick="renderOv()" style="align-self:flex-end">View</button>
        </div>
        <div id="ovList"></div>
      </div>

      <div id="bt-hist" class="stab">
        <div class="crow">
          <div class="fg"><label>Search</label><input type="text" id="hSrch" placeholder="Name or roll..." oninput="renderHist()"></div>
          <div class="fg"><label>Month</label><select id="hMo" onchange="renderHist()"><option value="">All</option><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Class</label><select id="hCls" onchange="renderHist()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        </div>
        <div id="hList" class="sgrid"></div>
      </div>
    </div>

    <!-- NOTICES -->
    <div id="page-notices" class="page">
      <div class="ph"><h2>Notice Board</h2><p>Send messages to parents</p></div>
      <div class="card">
        <div class="ct">ğŸ“¢ Send New Notice</div>
        <div class="fg">
          <label>Notice Title</label>
          <input type="text" id="noticeTitle" placeholder="e.g. School Holiday Announcement">
        </div>
        <div class="fg">
          <label>Message</label>
          <textarea id="noticeMsg" rows="4" placeholder="Type your message here..."></textarea>
        </div>
        <div class="fg">
          <label>Send To</label>
          <select id="noticeTo" onchange="noticeTypeChange()">
            <option value="all">All Parents</option>
            <option value="class">Specific Class</option>
            <option value="select">Select Students</option>
          </select>
        </div>
        <div id="noticeClassSelect" class="fg" style="display:none">
          <label>Select Class</label>
          <select id="noticeClass">
            <option value="">Choose class</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
        <div id="noticeStudentSelect" style="display:none">
          <label style="display:block;margin-bottom:8px;font-size:.75rem;font-weight:600;color:var(--text-mid);text-transform:uppercase">Select Students</label>
          <div id="studentCheckList" style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:10px"></div>
        </div>
        <button class="btn btn-p" onclick="sendNotice()">ğŸ“¤ Send Notice</button>
      </div>
      <div class="sdiv">Notice History</div>
      <div id="noticeHistory"></div>
    </div>

    <!-- REPORTS -->
    <div id="page-reports" class="page">
      <div class="ph"><h2>Reports</h2><p>Analytics</p></div>
      <div class="card">
        <div class="ct">ğŸ“Š Attendance Report</div>
        <div class="crow">
          <div class="fg"><label>Date</label><input type="date" id="rDate"></div>
          <div class="fg"><label>Class</label><select id="rCls"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <button class="btn btn-p btn-sm" onclick="renderRpt()" style="align-self:flex-end">Generate</button>
        </div>
        <div id="rCnt"></div>
      </div>
    </div>

    <!-- SESSIONS -->
    <div id="page-sessions" class="page">
      <div class="ph" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div><h2>Session Management</h2><p>Academic year control</p></div>
        <button class="btn btn-p btn-sm" onclick="showNewSession()">+ Create Session</button>
      </div>
      <div id="sessList"></div>
    </div>

    <!-- SETTINGS -->
    <div id="page-settings" class="page">
      <div class="ph"><h2>Settings</h2><p>System configuration</p></div>
      <div class="card">
        <div class="ct">ğŸ” Change Password</div>
        <div class="fg">
          <label>Current Password</label>
          <input type="password" id="currentPass" placeholder="Enter current password">
        </div>
        <div class="fg">
          <label>New Password</label>
          <input type="password" id="newPass" placeholder="Enter new password">
        </div>
        <div class="fg">
          <label>Confirm New Password</label>
          <input type="password" id="confirmPass" placeholder="Confirm new password">
        </div>
        <button class="btn btn-p" onclick="changePassword()">Update Password</button>
      </div>
    </div>

  </main>
</div>
</div>

<!-- MODALS -->
<div id="qrM" class="modal">
  <div class="mbox">
    <div class="mhdr"><h3 id="qrMT">QR Code</h3><button class="mcl" onclick="clsM('qrM')">âœ•</button></div>
    <div id="qrMB"></div>
  </div>
</div>

<div id="downloadQrM" class="modal">
  <div class="mbox">
    <div class="mhdr"><h3>Download QR Codes</h3><button class="mcl" onclick="clsM('downloadQrM')">âœ•</button></div>
    <div class="fg">
      <label>Select Class</label>
      <select id="dlQrCls">
        <option value="">All Classes</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
      </select>
    </div>
    <button class="btn btn-p" onclick="generateQRDownload()">Generate QR Codes</button>
  </div>
</div>

<div id="allQrM" class="modal">
  <div class="mbox mw">
    <div class="mhdr"><h3>QR Codes</h3><button class="mcl" onclick="clsM('allQrM')">âœ•</button></div>
    <div class="np" style="text-align:center;margin-bottom:16px"><button class="btn btn-p" onclick="window.print()">ğŸ–¼ Print All</button></div>
    <div id="allQrB"></div>
  </div>
</div>

<div id="newSessionM" class="modal">
  <div class="mbox">
    <div class="mhdr"><h3>Create New Session</h3><button class="mcl" onclick="clsM('newSessionM')">âœ•</button></div>
    <div class="fg">
      <label>Session Name</label>
      <input type="text" id="newSessName" placeholder="e.g. 2027-28">
    </div>
    <p style="font-size:.82rem;color:var(--text-light);margin-bottom:16px">Creating a new session will archive the current session and start fresh.</p>
    <button class="btn btn-p" onclick="createNewSession()">Create Session</button>
  </div>
</div>

<div class="twrap" id="twrap"></div>
<div id="pr" style="display:none"></div>

<script type="module">
// ===== FIREBASE IMPORTS =====
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyDA67oWl6Kq1kNXLylumXlC7YV5tgrsnBs",
  authDomain: "central-public-school-1cd53.firebaseapp.com",
  projectId: "central-public-school-1cd53",
  storageBucket: "central-public-school-1cd53.firebasestorage.app",
  messagingSenderId: "490014133859",
  appId: "1:490014133859:web:f89fe318d46e3e768c3256"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===== GLOBAL VARIABLES =====
const MO=['','January','February','March','April','May','June','July','August','September','October','November','December'];

let dbCache = {
  students: [],
  attendance: {},
  bills: [],
  sessions: [],
  notices: [],
  cur: '2026-27'
};

let currentUser = null;

// ===== HELPER FUNCTIONS =====
function showLoader(){document.getElementById('loader').classList.add('show');}
function hideLoader(){document.getElementById('loader').classList.remove('show');}

window.toast = function(msg,type='inf',dur=3000){
  const w=document.getElementById('twrap'),t=document.createElement('div');
  t.className='toast '+type;
  t.innerHTML=(type==='suc'?'âœ“':type==='err'?'âœ—':'â„¹')+' '+msg;
  w.appendChild(t);setTimeout(()=>t.remove(),dur);
};

// ===== AUTHENTICATION =====
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    document.getElementById('userEmail').textContent = user.email;
    await loadAllData();
    showApp();
  } else {
    currentUser = null;
    document.getElementById('mainApp').style.display='none';
    document.getElementById('loginPage').style.display='flex';
  }
  hideLoader();
});

window.doLogin = async function(e) {
  e.preventDefault();
  showLoader();
  const email = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;
  
  try {
    await signInWithEmailAndPassword(auth, email, password);
    toast('Login successful!','suc');
  } catch (error) {
    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, 'settings', auth.currentUser.uid), {
          currentSession: '2026-27',
          sessions: [],
          createdAt: new Date().toISOString()
        });
        toast('Account created!','suc');
      } catch (createError) {
        toast('Error: ' + createError.message,'err');
        hideLoader();
      }
    } else {
      toast('Login failed: ' + error.message,'err');
      hideLoader();
    }
  }
};

window.logout = async function() {
  if(!confirm('Logout?')) return;
  showLoader();
  try {
    await signOut(auth);
    document.getElementById('loginForm').reset();
    toast('Logged out','inf');
  } catch (error) {
    toast('Logout failed','err');
  }
  hideLoader();
};

window.changePassword = async function() {
  const newP = document.getElementById('newPass').value;
  const confirm = document.getElementById('confirmPass').value;
  
  if(!newP || !confirm) {
    toast('Please fill all fields','err');
    return;
  }
  
  if(newP !== confirm) {
    toast('Passwords do not match','err');
    return;
  }
  
  if(newP.length < 6) {
    toast('Password must be at least 6 characters','err');
    return;
  }
  
  showLoader();
  try {
    await updatePassword(auth.currentUser, newP);
    toast('Password changed!','suc');
    document.getElementById('currentPass').value='';
    document.getElementById('newPass').value='';
    document.getElementById('confirmPass').value='';
  } catch (error) {
    toast('Error: Re-login and try again','err');
  }
  hideLoader();
};

// ===== DATA LOADING =====
async function loadAllData() {
  showLoader();
  try {
    const uid = auth.currentUser.uid;
    
    // Load settings
    const settingsDoc = await getDoc(doc(db, 'settings', uid));
    if (settingsDoc.exists()) {
      const settingsData = settingsDoc.data();
      dbCache.cur = settingsData.currentSession || '2026-27';
      dbCache.sessions = settingsData.sessions || [];
    }
    
    // Load students
    const studentsSnap = await getDocs(collection(db, 'users', uid, 'students'));
    dbCache.students = studentsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
    
    // Load attendance
    const attendanceSnap = await getDocs(collection(db, 'users', uid, 'attendance'));
    dbCache.attendance = {};
    attendanceSnap.docs.forEach(doc => {
      dbCache.attendance[doc.id] = doc.data();
    });
    
    // Load bills
    const billsSnap = await getDocs(collection(db, 'users', uid, 'bills'));
    dbCache.bills = billsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
    
    // Load notices
    const noticesSnap = await getDocs(collection(db, 'users', uid, 'notices'));
    dbCache.notices = noticesSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
    
  } catch (error) {
    console.error('Error loading data:', error);
    toast('Error loading data','err');
  }
  hideLoader();
}

async function saveSettings() {
  if (!auth.currentUser) return;
  try {
    await setDoc(doc(db, 'settings', auth.currentUser.uid), {
      currentSession: dbCache.cur,
      sessions: dbCache.sessions,
      updatedAt: new Date().toISOString()
    });
  } catch (error) {
    console.error('Error saving settings:', error);
  }
}

async function saveStudent(student) {
  if (!auth.currentUser) return;
  try {
    const uid = auth.currentUser.uid;
    if (student.id) {
      const {id, ...data} = student;
      await setDoc(doc(db, 'users', uid, 'students', id), data);
    } else {
      const {id, ...data} = student;
      const docRef = await addDoc(collection(db, 'users', uid, 'students'), data);
      student.id = docRef.id;
    }
    return student;
  } catch (error) {
    console.error('Error saving student:', error);
    throw error;
  }
}

async function saveAttendance(date, data) {
  if (!auth.currentUser) return;
  try {
    await setDoc(doc(db, 'users', auth.currentUser.uid, 'attendance', date), data);
  } catch (error) {
    console.error('Error saving attendance:', error);
    throw error;
  }
}

async function saveBillToDb(bill) {
  if (!auth.currentUser) return;
  try {
    const uid = auth.currentUser.uid;
    if (bill.id) {
      const {id, ...data} = bill;
      await setDoc(doc(db, 'users', uid, 'bills', id), data);
    } else {
      const {id, ...data} = bill;
      const docRef = await addDoc(collection(db, 'users', uid, 'bills'), data);
      bill.id = docRef.id;
    }
    return bill;
  } catch (error) {
    console.error('Error saving bill:', error);
    throw error;
  }
}

async function saveNoticeToDb(notice) {
  if (!auth.currentUser) return;
  try {
    const {id, ...data} = notice;
    const docRef = await addDoc(collection(db, 'users', auth.currentUser.uid, 'notices'), data);
    notice.id = docRef.id;
    return notice;
  } catch (error) {
    console.error('Error saving notice:', error);
    throw error;
  }
}

// ===== APP INITIALIZATION =====
function showApp(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('mainApp').style.display='block';
  init();
}

function getNextRollNumber(cls){
  const students=dbCache.students.filter(s=>s.class===cls&&s.session===dbCache.cur);
  let maxNum=0;
  students.forEach(s=>{
    const num=parseInt(s.rollNumber);
    if(!isNaN(num)&&num>maxNum)maxNum=num;
  });
  return String(maxNum+1).padStart(3,'0');
}

window.updateRollPreview = function(){
  const cls=document.getElementById('rc').value;
  if(cls){
    document.getElementById('rr').value=getNextRollNumber(cls);
  }else{
    document.getElementById('rr').value='';
  }
};

function init(){
  document.getElementById('rj').valueAsDate=new Date();
  document.getElementById('aDate').valueAsDate=new Date();
  document.getElementById('rDate').valueAsDate=new Date();
  const m=new Date().getMonth()+1;
  ['bMo','ovMo'].forEach(id=>{const e=document.getElementById(id);if(e)e.value=m;});
  document.getElementById('sessTag').textContent='Session '+dbCache.cur;
  populateFSess();
  renderDash();renderStudents();renderAttR();renderSess();renderNotices();
  
  const p=new URLSearchParams(window.location.search),r=p.get('attendance');
  if(r)markFromQR(r);
}

function populateFSess(){
  const s=document.getElementById('fSess');
  s.innerHTML='<option value="">All Sessions</option>';
  [...new Set(dbCache.students.map(x=>x.session).filter(Boolean))].sort().reverse().forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent='Session '+x;s.appendChild(o);});
}

window.goP = function(n,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+n).classList.add('active');
  if(el)el.classList.add('active');
  if(n==='dashboard')renderDash();
  if(n==='students')renderStudents();
  if(n==='reports')renderRpt();
  if(n==='sessions')renderSess();
  if(n==='billing')renderHist();
  if(n==='notices')renderNotices();
};

window.swBTab = function(n,el){
  document.querySelectorAll('#page-billing .stab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#page-billing .tp').forEach(t=>t.classList.remove('active'));
  document.getElementById('bt-'+n).classList.add('active');el.classList.add('active');
  if(n==='hist')renderHist();if(n==='ov')renderOv();
};

window.opM = function(id){document.getElementById(id).classList.add('open');};
window.clsM = function(id){document.getElementById(id).classList.remove('open');};

// ===== STUDENT MANAGEMENT =====
window.regStudent = async function(e){
  e.preventDefault();
  showLoader();
  const roll=document.getElementById('rr').value.trim();
  const cls=document.getElementById('rc').value;
  if(dbCache.students.find(s=>s.rollNumber===roll&&s.class===cls&&s.session===dbCache.cur)){
    toast('Roll number exists!','err');
    hideLoader();
    return;
  }
  const s={
    name:document.getElementById('rn').value.trim(),
    rollNumber:roll,
    dob:document.getElementById('rd').value,
    parentName:document.getElementById('rp').value.trim(),
    phoneNumber:document.getElementById('rpm').value.trim(),
    class:cls,
    joiningDate:document.getElementById('rj').value,
    monthlyFee:parseFloat(document.getElementById('rf').value),
    address:document.getElementById('ra').value.trim(),
    session:dbCache.cur,
    createdAt: new Date().toISOString()
  };
  
  try {
    const saved = await saveStudent(s);
    dbCache.students.push(saved);
    toast('Registered: '+s.name,'suc');
    document.getElementById('sForm').reset();
    document.getElementById('rj').valueAsDate=new Date();
    renderStudents();renderDash();
  } catch (error) {
    toast('Error registering','err');
  }
  hideLoader();
};

window.clrForm = function(){
  document.getElementById('sForm').reset();
  document.getElementById('rj').valueAsDate=new Date();
  document.getElementById('rr').value='';
};

function getAP(r){let t=0,p=0;for(let d in dbCache.attendance){t++;if(dbCache.attendance[d][r])p++;}return t?Math.round(p/t*100):0;}

function renderDash(){
  const td=new Date().toISOString().split('T')[0],ta=dbCache.attendance[td]||{};
  const ss=dbCache.students.filter(s=>s.session===dbCache.cur),pr=ss.filter(s=>ta[s.rollNumber]).length;
  const m=new Date().getMonth()+1,y=new Date().getFullYear();
  const mb=dbCache.bills.filter(b=>b.month==m&&b.year==y),col=mb.reduce((a,b)=>a+b.total,0);
  document.getElementById('dStats').innerHTML=`<div class="sbox"><div class="sic si-b">ğŸ‘¥</div><div class="snum">${ss.length}</div><div class="slbl">Total Students</div></div><div class="sbox"><div class="sic si-g">âœ“</div><div class="snum">${pr}</div><div class="slbl">Present Today</div></div><div class="sbox"><div class="sic si-r">âš </div><div class="snum">${ss.length-pr}</div><div class="slbl">Absent Today</div></div><div class="sbox"><div class="sic si-gold">ğŸ’°</div><div class="snum">â‚¹${col.toLocaleString('en-IN')}</div><div class="slbl">Collected This Month</div></div>`;
  const ae=document.getElementById('dAtt'),plist=ss.filter(s=>ta[s.rollNumber]).slice(0,5);
  ae.innerHTML=plist.length?plist.map(s=>`<div class="ac pres" style="margin-bottom:7px"><div class="an">${s.name}</div><div class="as">Class ${s.class} Â· ${s.rollNumber}</div><div class="at">ğŸ• ${ta[s.rollNumber].time}</div></div>`).join('')+(pr>5?`<p style="color:var(--text-light);font-size:.75rem;margin-top:6px">+${pr-5} more...</p>`:''):'<div class="empty" style="padding:16px 0"><div class="ei">ğŸ“‹</div><p>No attendance today</p></div>';
  const be=document.getElementById('dBills'),rb=[...dbCache.bills].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
  be.innerHTML=rb.length?rb.map(b=>`<div style="display:flex;gap:10px;padding:8px;background:var(--cream);border-radius:7px;margin-bottom:5px"><div style="flex:1"><div style="font-size:.82rem;font-weight:600;color:var(--navy)">${b.studentName}</div><div style="font-size:.7rem;color:var(--text-light)">${MO[b.month]} ${b.year} Â· Class ${b.studentClass}</div></div><div style="font-family:'DM Mono',monospace;font-size:.82rem;font-weight:600;color:var(--navy)">â‚¹${b.total.toLocaleString('en-IN')}</div></div>`).join(''):'<div class="empty" style="padding:16px 0"><div class="ei">ğŸ’³</div><p>No bills yet</p></div>';
}

function renderStudents(){
  const srch=(document.getElementById('srch')?.value||'').toLowerCase(),cls=document.getElementById('fCls')?.value||'',sess=document.getElementById('fSess')?.value||'';
  let list=dbCache.students.filter(s=>{if(cls&&s.class!==cls)return false;if(sess&&s.session!==sess)return false;if(srch&&!s.name.toLowerCase().includes(srch)&&!s.rollNumber.toLowerCase().includes(srch))return false;return true;});
  document.getElementById('scnt').textContent=list.length;
  const g=document.getElementById('sGrid');
  if(!list.length){g.innerHTML='<div class="empty"><div class="ei">ğŸ‘¤</div><h4>No students found</h4></div>';return;}
  g.innerHTML=list.map(s=>{
    const ap=getAP(s.rollNumber),init=s.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase(),pm=dbCache.bills.filter(b=>b.studentId===s.id).length;
    return`<div class="sc"><div class="av">${init}</div><div class="sm"><h3>${s.name} <span class="bdg bdg-c">Class ${s.class}</span> <span class="bdg bdg-s">${s.session}</span></h3><div class="sub"><span>ğŸ“‹ ${s.rollNumber}</span><span>ğŸ‘ª ${s.parentName}</span><span>ğŸ“± ${s.phoneNumber}</span></div><div style="margin-top:5px;display:flex;align-items:center;gap:9px"><div style="flex:1;background:#e9ecef;border-radius:20px;height:5px;max-width:140px"><div style="background:${ap>=75?'var(--success)':ap>=50?'var(--warning)':'var(--danger)'};width:${ap}%;height:5px;border-radius:20px"></div></div><span style="font-size:.7rem;color:var(--text-light)">${ap}% Â· ${pm} bills</span></div></div><div class="sa"><button class="btn btn-i btn-xs" onclick="showQR('${s.id}')">QR Code</button><button class="btn btn-g btn-xs" onclick="qkBill('${s.id}')">Bill</button><button class="btn btn-d btn-xs" onclick="delStu('${s.id}')">ğŸ—‘</button></div></div>`;
  }).join('');
}

window.delStu = async function(id){
  if(!confirm('Delete?'))return;
  showLoader();
  try {
    await deleteDoc(doc(db, 'users', auth.currentUser.uid, 'students', id));
    dbCache.students=dbCache.students.filter(s=>s.id!==id);
    renderStudents();renderDash();
    toast('Deleted','inf');
  } catch (error) {
    toast('Error deleting','err');
  }
  hideLoader();
};

window.qkBill = function(id){
  goP('billing',document.querySelector('[onclick*=\'billing\']'));
  setTimeout(()=>{const s=dbCache.students.find(s=>s.id===id);if(!s)return;document.getElementById('bCls').value=s.class;loadBStu();setTimeout(()=>{document.getElementById('bStu').value=id;loadSBill();},110);},180);
};

// ===== QR CODE =====
const BU=window.location.href.split('?')[0];

window.showQR = function(id){
  const s=dbCache.students.find(s=>s.id===id);if(!s)return;
  const url=BU+'?attendance='+s.rollNumber;
  document.getElementById('qrMT').textContent=s.name+' â€” QR Code';
  document.getElementById('qrMB').innerHTML=`<div style="text-align:center">
    <div class="qrc" id="qrCS"><div class="qrh">ğŸ“ Central Public School</div><div class="qrs">Session ${s.session} Â· Class ${s.class}</div><div id="qrCV" style="margin:10px auto;display:inline-block"></div><div class="qrn">${s.name}</div><div class="qrroll">Roll: ${s.rollNumber}</div></div>
    <div class="np" style="display:flex;gap:9px;justify-content:center;margin-top:18px"><button class="btn btn-p" onclick="prQR()">ğŸ–¼ Print Card</button><button class="btn btn-o" onclick="clsM('qrM')">Close</button></div>
  </div>`;
  opM('qrM');
  setTimeout(()=>{
    new QRCode(document.getElementById('qrCV'),{
      text:url,
      width:190,
      height:190,
      colorDark:'#0f1b2d',
      colorLight:'#ffffff'
    });
  },100);
};

window.prQR = function(){
  const c=document.getElementById('qrCS'),pr=document.getElementById('pr');
  pr.innerHTML='<div style="padding:28px;text-align:center">'+c.outerHTML+'</div>';
  pr.style.display='block';window.print();pr.style.display='none';pr.innerHTML='';
};

window.showDownloadQR = function(){
  opM('downloadQrM');
};

window.generateQRDownload = function(){
  const cls=document.getElementById('dlQrCls').value;
  const sess=document.getElementById('fSess')?.value||dbCache.cur;
  const list=dbCache.students.filter(s=>{
    if(s.session!==sess)return false;
    if(cls&&s.class!==cls)return false;
    return true;
  });
  if(!list.length){toast('No students match filter','err');return;}
  
  clsM('downloadQrM');
  document.getElementById('allQrB').innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px">${list.map((s,i)=>`<div style="text-align:center;border:2px solid var(--navy);border-radius:11px;padding:14px;page-break-inside:avoid"><div style="font-family:'Playfair Display',serif;font-size:.9rem;font-weight:800;color:var(--navy)">Central Public School</div><div style="font-size:.7rem;color:var(--text-light);margin:2px 0 8px">Session ${s.session} Â· Class ${s.class}</div><div id="qa${i}" style="margin:0 auto;display:inline-block"></div><div style="font-size:.88rem;font-weight:700;color:var(--navy);margin-top:7px">${s.name}</div><div style="font-family:'DM Mono',monospace;font-size:.75rem;color:var(--text-mid)">Roll: ${s.rollNumber}</div><div style="font-size:.7rem;color:var(--text-light);margin-top:2px">${s.phoneNumber}</div></div>`).join('')}</div>`;
  opM('allQrM');
  setTimeout(()=>{
    list.forEach((s,i)=>{
      new QRCode(document.getElementById('qa'+i),{
        text:BU+'?attendance='+s.rollNumber,
        width:150,
        height:150,
        colorDark:'#0f1b2d',
        colorLight:'#ffffff'
      });
    });
  },130);
};

// ===== ATTENDANCE =====
window.markFromQR = async function(r){
  const s=dbCache.students.find(s=>s.rollNumber===r);
  if(!s){alert('Student not found: '+r);return;}
  const td=new Date().toISOString().split('T')[0];
  if(!dbCache.attendance[td])dbCache.attendance[td]={};
  if(dbCache.attendance[td][r]){alert('Already marked!\nğŸ‘¤ '+s.name+'\nğŸ“ '+r+'\nğŸ• '+dbCache.attendance[td][r].time);return;}
  const time=new Date().toLocaleTimeString('en-IN');
  dbCache.attendance[td][r]={name:s.name,class:s.class,time};
  
  showLoader();
  try {
    await saveAttendance(td, dbCache.attendance[td]);
    alert('Attendance Marked!\nğŸ‘¤ '+s.name+'\nğŸ“ Roll: '+r+'\nğŸ“š Class '+s.class+'\nğŸ• '+time);
    renderDash();renderAttR();
  } catch (error) {
    toast('Error saving','err');
  }
  hideLoader();
};

window.markAtt = async function(){
  const r=document.getElementById('scanIn').value.trim();if(!r)return;
  const s=dbCache.students.find(s=>s.rollNumber===r),f=document.getElementById('sFeed');f.style.display='flex';
  if(!s){f.className='sfeed err';f.innerHTML='âœ— Not found: <b>'+r+'</b>';}
  else{
    const td=new Date().toISOString().split('T')[0];if(!dbCache.attendance[td])dbCache.attendance[td]={};
    if(dbCache.attendance[td][r]){f.className='sfeed wrn';f.innerHTML='âš  Already marked â€” <b>'+s.name+'</b> at '+dbCache.attendance[td][r].time;}
    else{
      const time=new Date().toLocaleTimeString('en-IN');
      dbCache.attendance[td][r]={name:s.name,class:s.class,time};
      showLoader();
      try {
        await saveAttendance(td, dbCache.attendance[td]);
        renderAttR();renderDash();
        f.className='sfeed suc';
        f.innerHTML='âœ“ <b>'+s.name+'</b> Â· Class '+s.class+' Â· ğŸ• '+time;
      } catch (error) {
        toast('Error saving','err');
      }
      hideLoader();
    }
  }
  document.getElementById('scanIn').value='';setTimeout(()=>{f.style.display='none';},3500);
};

function renderAttR(){
  const date=document.getElementById('aDate')?.value,cls=document.getElementById('aCls')?.value||'';if(!date)return;
  const da=dbCache.attendance[date]||{};let ss=dbCache.students.filter(s=>s.session===dbCache.cur);if(cls)ss=ss.filter(s=>s.class===cls);
  const pr=ss.filter(s=>da[s.rollNumber]),ab=ss.filter(s=>!da[s.rollNumber]);
  document.getElementById('aStats').innerHTML=`<div class="sbox"><div class="sic si-b">ğŸ‘¥</div><div class="snum">${ss.length}</div><div class="slbl">Total</div></div><div class="sbox"><div class="sic si-g">âœ“</div><div class="snum">${pr.length}</div><div class="slbl">Present</div></div><div class="sbox"><div class="sic si-r">âœ—</div><div class="snum">${ab.length}</div><div class="slbl">Absent</div></div><div class="sbox"><div class="sic si-gold">ğŸ“Š</div><div class="snum">${ss.length?Math.round(pr.length/ss.length*100):0}%</div><div class="slbl">Rate</div></div>`;
  let h='<div class="sdiv">Present ('+pr.length+')</div><div class="agrid">';
  pr.forEach(s=>{h+=`<div class="ac pres"><div class="an">${s.name}</div><div class="as">Roll ${s.rollNumber} Â· Class ${s.class}</div><div class="at">ğŸ• ${da[s.rollNumber].time}</div></div>`;});
  h+='</div><div class="sdiv">Absent ('+ab.length+')</div><div class="agrid">';
  ab.forEach(s=>{h+=`<div class="ac abs"><div class="an">${s.name}</div><div class="as">Roll ${s.rollNumber} Â· Class ${s.class}</div><div class="as">ğŸ“± ${s.phoneNumber}</div></div>`;});
  h+='</div>';document.getElementById('aReport').innerHTML=h;
}

// ===== BILLING =====
let cb={student:null,items:[]};

window.loadBStu = function(){
  const cls=document.getElementById('bCls').value,sel=document.getElementById('bStu');
  sel.innerHTML='<option value="">Choose student</option>';if(!cls)return;
  dbCache.students.filter(s=>s.class===cls&&s.session===dbCache.cur).forEach(s=>{const o=document.createElement('option');o.value=s.id;o.textContent=s.name+' ('+s.rollNumber+')';sel.appendChild(o);});
};

window.loadSBill = function(){
  const id=document.getElementById('bStu').value;
  if(!id){document.getElementById('bPrevW').style.display='none';return;}
  const s=dbCache.students.find(s=>s.id===id);if(!s)return;
  cb.student=s;cb.items=[{name:'Monthly Fee',price:s.monthlyFee}];
  updBP();
};

function updBP(){
  if(!cb.student)return;
  const s=cb.student,tot=cb.items.reduce((a,b)=>a+b.price,0);
  const mo=parseInt(document.getElementById('bMo').value),yr=document.getElementById('bYr').value;
  
  const existing=dbCache.bills.find(b=>b.studentId===s.id&&b.month===mo&&b.year==yr);
  const paidBadge=existing?'<span class="bdg bdg-paid">PAID âœ“</span>':'';
  
  document.getElementById('bPrevW').style.display='block';
  document.getElementById('bPrev').innerHTML=`<div style="background:#fff;border:2px solid var(--navy);border-radius:8px;padding:24px;max-width:500px;margin:0 auto" id="pbill">
    <div style="font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;color:var(--navy);text-align:center">Central Public School</div>
    <div style="text-align:center;margin:12px 0;font-size:.95rem;font-weight:700;color:var(--gold)">FEE RECEIPT ${paidBadge}</div>
    <div style="margin:12px 0;font-size:.82rem"><div style="display:flex;gap:10px;margin:4px 0"><span style="color:var(--text-light);min-width:85px">Student:</span><span style="font-weight:600">${s.name}</span></div><div style="display:flex;gap:10px;margin:4px 0"><span style="color:var(--text-light);min-width:85px">Roll No:</span><span style="font-weight:600">${s.rollNumber}</span></div><div style="display:flex;gap:10px;margin:4px 0"><span style="color:var(--text-light);min-width:85px">Class:</span><span style="font-weight:600">Class ${s.class}</span></div><div style="display:flex;gap:10px;margin:4px 0"><span style="color:var(--text-light);min-width:85px">Parent:</span><span style="font-weight:600">${s.parentName}</span></div><div style="display:flex;gap:10px;margin:4px 0"><span style="color:var(--text-light);min-width:85px">Phone:</span><span style="font-weight:600">${s.phoneNumber}</span></div><div style="display:flex;gap:10px;margin:4px 0"><span style="color:var(--text-light);min-width:85px">Period:</span><span style="font-weight:600">${MO[mo]} ${yr}</span></div></div>
    <div style="margin:16px 0;padding:12px;background:var(--navy);color:#fff;border-radius:6px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:.78rem">TOTAL AMOUNT</span><span style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:800;color:var(--gold-light)">â‚¹${tot.toLocaleString('en-IN')}</span></div>
    <div style="text-align:center;font-size:.72rem;color:var(--text-light);margin-top:12px">Thank you. Central Public School</div>
  </div>`;
}

window.saveBill = async function(){
  if(!cb.student){toast('Select student first','err');return;}
  showLoader();
  const s=cb.student,mo=parseInt(document.getElementById('bMo').value),yr=parseInt(document.getElementById('bYr').value),tot=cb.items.reduce((a,b)=>a+b.price,0);
  
  try {
    dbCache.bills=dbCache.bills.filter(b=>!(b.studentId===s.id&&b.month===mo&&b.year===yr));
    
    const bill = {
      studentId:s.id,
      studentName:s.name,
      studentClass:s.class,
      rollNumber:s.rollNumber,
      parentName:s.parentName,
      phone:s.phoneNumber,
      month:mo,
      year:yr,
      total:tot,
      items:[...cb.items],
      createdAt:new Date().toISOString(),
      session:s.session,
      paid:true
    };
    
    const saved = await saveBillToDb(bill);
    dbCache.bills.push(saved);
    
    renderDash();renderHist();updBP();
    toast('Bill saved for '+s.name,'suc');
  } catch (error) {
    toast('Error saving bill','err');
  }
  hideLoader();
};

window.printBill = function(){
  if(!cb.student){toast('Generate bill first','err');return;}
  const b=document.getElementById('pbill');if(!b){toast('Error','err');return;}
  const pr=document.getElementById('pr');pr.innerHTML=b.outerHTML;pr.style.display='block';window.print();pr.style.display='none';pr.innerHTML='';
};

window.sendBillSMS = function(){
  if(!cb.student){toast('Generate bill first','err');return;}
  const s=cb.student,mo=parseInt(document.getElementById('bMo').value),yr=parseInt(document.getElementById('bYr').value),tot=cb.items.reduce((a,b)=>a+b.price,0);
  const msg=`Dear ${s.parentName}, fee bill for ${s.name} (${s.rollNumber}) for ${MO[mo]} ${yr} is â‚¹${tot}. - Central Public School`;
  alert('SMS Message (to '+s.phoneNumber+'):\n\n'+msg+'\n\nNote: Integrate with SMS gateway API.');
  toast('SMS prepared','suc');
};

window.renderOv = function(){
  const mo=parseInt(document.getElementById('ovMo').value),yr=parseInt(document.getElementById('ovYr').value),cls=document.getElementById('ovCls').value;
  let ss=dbCache.students.filter(s=>s.session===dbCache.cur);if(cls)ss=ss.filter(s=>s.class===cls);
  const bills=dbCache.bills.filter(b=>b.month===mo&&b.year===yr),bids=bills.map(b=>b.studentId);
  const paid=ss.filter(s=>bids.includes(s.id)),upd=ss.filter(s=>!bids.includes(s.id));
  let h='<div class="sdiv">Paid ('+paid.length+')</div><div class="sgrid">';
  paid.forEach(s=>{h+=`<div style="background:#fff;border-radius:9px;border:1px solid var(--border);padding:12px;display:flex;gap:12px;align-items:center"><div style="flex:1"><div style="font-weight:700;font-size:.88rem;color:var(--navy)">${s.name} <span class="bdg bdg-c">Class ${s.class}</span></div><div style="font-size:.75rem;color:var(--text-light);margin-top:2px">Roll: ${s.rollNumber}</div></div><div style="color:var(--success);font-weight:700">PAID</div></div>`;});
  h+='</div><div class="sdiv">Unpaid ('+upd.length+')</div><div class="sgrid">';
  upd.forEach(s=>{h+=`<div style="background:#fff;border-radius:9px;border:1px solid var(--border);padding:12px;display:flex;gap:12px;align-items:center"><div style="flex:1"><div style="font-weight:700;font-size:.88rem;color:var(--navy)">${s.name} <span class="bdg bdg-c">Class ${s.class}</span></div><div style="font-size:.75rem;color:var(--text-light);margin-top:2px">Roll: ${s.rollNumber} Â· ğŸ“± ${s.phoneNumber}</div></div><div style="display:flex;gap:4px"><button class="btn btn-g btn-xs" onclick="qkBill('${s.id}')">Bill</button><button class="btn btn-i btn-xs" onclick="sendDueSMS('${s.id}',${mo},${yr})">ğŸ“±</button></div></div>`;});
  h+='</div>';document.getElementById('ovList').innerHTML=h;
};

window.sendDueSMS = function(sid,mo,yr){
  const s=dbCache.students.find(s=>s.id===sid);
  if(!s)return;
  const msg=`Dear ${s.parentName}, reminder: fee for ${s.name} (${s.rollNumber}) for ${MO[mo]} ${yr} is pending. Amount: â‚¹${s.monthlyFee}. - Central Public School`;
  alert('SMS Message (to '+s.phoneNumber+'):\n\n'+msg);
  toast('Reminder sent','suc');
};

function renderHist(){
  const srch=(document.getElementById('hSrch')?.value||'').toLowerCase();
  const mo=parseInt(document.getElementById('hMo')?.value||'0');
  const cls=document.getElementById('hCls')?.value||'';
  let bills=[...dbCache.bills].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  if(mo)bills=bills.filter(b=>b.month===mo);
  if(cls)bills=bills.filter(b=>b.studentClass===cls);
  if(srch)bills=bills.filter(b=>b.studentName.toLowerCase().includes(srch)||b.rollNumber.toLowerCase().includes(srch));
  const c=document.getElementById('hList');
  if(!bills.length){c.innerHTML='<div class="empty"><div class="ei">ğŸ“‚</div><h4>No bills found</h4></div>';return;}
  c.innerHTML=bills.map(b=>`<div class="sc"><div class="av" style="background:linear-gradient(135deg,var(--success),#20c997)">â‚¹</div><div class="sm"><h3>${b.studentName} <span class="bdg bdg-c">Class ${b.studentClass}</span> ${b.paid?'<span class="bdg bdg-paid">PAID</span>':''}</h3><div class="sub"><span>ğŸ“ ${b.rollNumber}</span><span>ğŸ“… ${MO[b.month]} ${b.year}</span><span>ğŸ‘ª ${b.parentName}</span></div></div><div style="text-align:right;flex-shrink:0"><div style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:800;color:var(--navy)">â‚¹${b.total.toLocaleString('en-IN')}</div><div style="font-size:.72rem;color:var(--text-light)">${new Date(b.createdAt).toLocaleDateString('en-IN')}</div><button class="btn btn-i btn-xs" onclick="sendBillSMSById('${b.id}')" style="margin-top:4px">ğŸ“± SMS</button></div></div>`).join('');
}

window.sendBillSMSById = function(bid){
  const b=dbCache.bills.find(x=>x.id===bid);
  if(!b)return;
  const msg=`Dear ${b.parentName}, fee bill for ${b.studentName} (${b.rollNumber}) for ${MO[b.month]} ${b.year} is â‚¹${b.total}${b.paid?' - PAID':''} - Central Public School`;
  alert('SMS Message:\n\n'+msg);
  toast('SMS sent','suc');
};

// ===== NOTICES =====
window.noticeTypeChange = function(){
  const type=document.getElementById('noticeTo').value;
  document.getElementById('noticeClassSelect').style.display=type==='class'?'block':'none';
  document.getElementById('noticeStudentSelect').style.display=type==='select'?'block':'none';
  if(type==='select')loadStudentCheckList();
};

function loadStudentCheckList(){
  const list=dbCache.students.filter(s=>s.session===dbCache.cur);
  document.getElementById('studentCheckList').innerHTML=list.map(s=>`<div style="padding:5px;border-bottom:1px solid var(--border)"><label style="display:flex;align-items:center;cursor:pointer"><input type="checkbox" class="stu-check" value="${s.id}"><span style="font-size:.85rem">${s.name} (${s.rollNumber}) - Class ${s.class}</span></label></div>`).join('');
}

window.sendNotice = async function(){
  const title=document.getElementById('noticeTitle').value.trim();
  const msg=document.getElementById('noticeMsg').value.trim();
  const type=document.getElementById('noticeTo').value;
  
  if(!title||!msg){toast('Fill title and message','err');return;}
  
  let recipients=[];
  if(type==='all'){
    recipients=dbCache.students.filter(s=>s.session===dbCache.cur);
  }else if(type==='class'){
    const cls=document.getElementById('noticeClass').value;
    if(!cls){toast('Select a class','err');return;}
    recipients=dbCache.students.filter(s=>s.session===dbCache.cur&&s.class===cls);
  }else if(type==='select'){
    const checked=document.querySelectorAll('.stu-check:checked');
    if(checked.length===0){toast('Select students','err');return;}
    const ids=Array.from(checked).map(c=>c.value);
    recipients=dbCache.students.filter(s=>ids.includes(s.id));
  }
  
  if(recipients.length===0){toast('No recipients','err');return;}
  
  showLoader();
  try {
    const notice={
      title,
      message:msg,
      type,
      recipientCount:recipients.length,
      createdAt:new Date().toISOString(),
      recipients:recipients.map(r=>({id:r.id,name:r.name,phone:r.phoneNumber}))
    };
    
    const saved = await saveNoticeToDb(notice);
    dbCache.notices.push(saved);
    
    toast(`Notice sent to ${recipients.length} parents!`,'suc');
    document.getElementById('noticeTitle').value='';
    document.getElementById('noticeMsg').value='';
    document.getElementById('noticeTo').value='all';
    noticeTypeChange();
    renderNotices();
  } catch (error) {
    toast('Error sending notice','err');
  }
  hideLoader();
};

function renderNotices(){
  const list=[...dbCache.notices].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  const c=document.getElementById('noticeHistory');
  if(!list.length){c.innerHTML='<div class="empty"><div class="ei">ğŸ“¢</div><h4>No notices yet</h4></div>';return;}
  c.innerHTML=list.map(n=>`<div class="notice-card">
    <h4>${n.title}</h4>
    <div class="meta">Sent to ${n.recipientCount} parents Â· ${new Date(n.createdAt).toLocaleString('en-IN')}</div>
    <div class="msg">${n.message}</div>
  </div>`).join('');
}

// ===== REPORTS =====
function renderRpt(){
  const date=document.getElementById('rDate')?.value,cls=document.getElementById('rCls')?.value||'';
  if(!date){document.getElementById('rCnt').innerHTML='<div class="empty"><div class="ei">ğŸ“Š</div><p>Select a date</p></div>';return;}
  const da=dbCache.attendance[date]||{};let ss=dbCache.students.filter(s=>s.session===dbCache.cur);if(cls)ss=ss.filter(s=>s.class===cls);
  const pr=ss.filter(s=>da[s.rollNumber]),ab=ss.filter(s=>!da[s.rollNumber]);
  let h='<div class="sdiv">Present ('+pr.length+')</div><div class="agrid">';
  pr.forEach(s=>{h+=`<div class="ac pres"><div class="an">${s.name}</div><div class="as">Roll ${s.rollNumber} Â· Class ${s.class}</div><div class="at">ğŸ• ${da[s.rollNumber].time}</div></div>`;});
  h+='</div><div class="sdiv">Absent ('+ab.length+')</div><div class="agrid">';
  ab.forEach(s=>{h+=`<div class="ac abs"><div class="an">${s.name}</div><div class="as">Roll ${s.rollNumber} Â· Class ${s.class}</div></div>`;});
  h+='</div>';document.getElementById('rCnt').innerHTML=h;
}

// ===== SESSIONS =====
window.showNewSession = function(){
  opM('newSessionM');
};

window.createNewSession = async function(){
  const name=document.getElementById('newSessName').value.trim();
  if(!name){toast('Enter session name','err');return;}
  if(dbCache.sessions.includes(name)||name===dbCache.cur){toast('Session exists','err');return;}
  
  if(!confirm(`Archive ${dbCache.cur} and create ${name}?`))return;
  
  showLoader();
  try {
    dbCache.sessions.push(dbCache.cur);
    dbCache.cur=name;
    await saveSettings();
    
    document.getElementById('newSessName').value='';
    clsM('newSessionM');
    document.getElementById('sessTag').textContent='Session '+dbCache.cur;
    toast('Session created: '+name,'suc');
    renderSess();renderDash();
  } catch (error) {
    toast('Error creating session','err');
  }
  hideLoader();
};

function renderSess(){
  const all=[...new Set([dbCache.cur,...dbCache.sessions,...dbCache.students.map(s=>s.session).filter(Boolean)])].sort().reverse();
  let h='<div style="background:linear-gradient(135deg,var(--navy),var(--royal));border-radius:12px;padding:18px 22px;color:#fff;margin-bottom:20px"><h3 style="font-family:\'Playfair Display\',serif;font-size:1rem;font-weight:800">Active: Session '+dbCache.cur+'</h3><p style="font-size:.8rem;color:rgba(255,255,255,.7);margin-top:2px">All new registrations go here</p></div><div class="sgrid">';
  all.forEach(sess=>{
    const ss=dbCache.students.filter(s=>s.session===sess),bs=dbCache.bills.filter(b=>b.session===sess),col=bs.reduce((a,b)=>a+b.total,0);
    h+=`<div class="card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px"><div><div style="font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:800;color:var(--navy)">Session ${sess}</div>${sess===dbCache.cur?'<span class="bdg" style="background:rgba(45,155,90,.12);color:var(--success);margin-top:3px">â— Active</span>':'<span class="bdg" style="background:var(--cream);color:var(--text-mid);border:1px solid var(--border);margin-top:3px">Archived</span>'}</div><div style="text-align:right"><div style="font-size:.72rem;color:var(--text-light)">Collected</div><div style="font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:800;color:var(--navy)">â‚¹${col.toLocaleString('en-IN')}</div></div></div><div style="display:flex;gap:20px">${[[ss.length,'Students'],[bs.length,'Bills'],[...new Set(ss.map(s=>s.class))].length,'Classes'].map(([v,l])=>`<div><div style="font-size:1.4rem;font-weight:800;color:var(--navy)">${v}</div><div style="font-size:.72rem;color:var(--text-light)">${l}</div></div>`).join('')}</div></div>`;
  });
  h+='</div>';document.getElementById('sessList').innerHTML=h;
}

// Start loader
showLoader();
</script>