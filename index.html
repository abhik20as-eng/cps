<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Central Public School \u2014 Management</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--navy:#0f1b2d;--deep:#1a2d4a;--royal:#1e3f6e;--gold:#c9a84c;--gold-light:#e8c96a;--cream:#faf8f3;--white:#fff;--success:#2d9b5a;--danger:#c0392b;--warning:#e67e22;--info:#2471a3;--text-dark:#0f1b2d;--text-mid:#3d5a80;--text-light:#6b8cae;--border:#dde4ed;--shadow:0 4px 24px rgba(15,27,45,.10);--shadow-lg:0 12px 48px rgba(15,27,45,.18)}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--text-dark);min-height:100vh}
.hdr{background:var(--navy);color:#fff;padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:68px;box-shadow:0 2px 16px rgba(15,27,45,.3);position:sticky;top:0;z-index:200}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:44px;height:44px;background:var(--gold);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo h1{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:800;line-height:1.1}
.logo span{font-size:.68rem;color:var(--gold-light);font-weight:400;letter-spacing:1.5px;text-transform:uppercase;display:block}
.sess-tag{background:rgba(201,168,76,.18);border:1px solid var(--gold);color:var(--gold-light);padding:5px 12px;border-radius:20px;font-size:.75rem;font-weight:500;letter-spacing:.5px}
.login-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--navy),var(--royal));display:flex;align-items:center;justify-content:center;z-index:9999}
.login-box{background:#fff;border-radius:16px;padding:40px;max-width:400px;width:90%;box-shadow:var(--shadow-lg)}
.login-box h2{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:800;color:var(--navy);text-align:center;margin-bottom:10px}
.login-box p{color:var(--text-light);text-align:center;margin-bottom:24px;font-size:.9rem}
.app{display:grid;grid-template-columns:210px 1fr;min-height:calc(100vh - 68px)}
.sidebar{background:var(--navy);padding:20px 0;border-right:1px solid rgba(255,255,255,.06)}
.nav-lbl{font-size:.62rem;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text-light);padding:0 18px;margin:14px 0 6px}
.ni{display:flex;align-items:center;gap:10px;padding:11px 18px;cursor:pointer;color:#7a9abf;font-size:.87rem;font-weight:500;border-left:3px solid transparent;transition:all .18s;user-select:none}
.ni:hover{background:rgba(255,255,255,.05);color:#fff}
.ni.active{color:var(--gold-light);background:rgba(201,168,76,.1);border-left-color:var(--gold)}
.ni-ic{font-size:1rem;width:20px;text-align:center}
.mc{padding:28px;overflow-y:auto}
.page{display:none}.page.active{display:block}
.ph{margin-bottom:24px}
.ph h2{font-family:'Playfair Display',serif;font-size:1.75rem;font-weight:800;color:var(--navy)}
.ph p{color:var(--text-light);font-size:.87rem;margin-top:3px}
.card{background:#fff;border-radius:12px;padding:22px;box-shadow:var(--shadow);border:1px solid var(--border)}
.ct{font-size:.95rem;font-weight:600;color:var(--navy);margin-bottom:16px;display:flex;align-items:center;gap:7px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.fg{margin-bottom:16px}
.fg label{display:block;margin-bottom:5px;font-size:.75rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:.9rem;font-family:'DM Sans',sans-serif;color:var(--text-dark);background:#fff;transition:all .2s;outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--royal);box-shadow:0 0 0 3px rgba(30,63,110,.08)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border:none;border-radius:8px;cursor:pointer;font-size:.85rem;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .18s}
.btn-p{background:var(--royal);color:#fff}.btn-p:hover{background:var(--deep);transform:translateY(-1px);box-shadow:0 4px 12px rgba(30,63,110,.3)}
.btn-g{background:var(--gold);color:var(--navy)}.btn-g:hover{background:var(--gold-light);transform:translateY(-1px)}
.btn-s{background:var(--success);color:#fff}.btn-s:hover{background:#23844a;transform:translateY(-1px)}
.btn-d{background:var(--danger);color:#fff}.btn-d:hover{background:#a93226;transform:translateY(-1px)}
.btn-i{background:var(--info);color:#fff}.btn-i:hover{background:#1a5f88;transform:translateY(-1px)}
.btn-o{background:transparent;border:1.5px solid var(--border);color:var(--text-mid)}.btn-o:hover{border-color:var(--royal);color:var(--royal)}
.btn-sm{padding:6px 12px;font-size:.78rem;border-radius:7px}
.btn-xs{padding:4px 10px;font-size:.73rem;border-radius:6px}
.btn-upg{background:var(--gold);color:var(--navy);border:none;cursor:pointer;padding:7px 15px;border-radius:7px;font-size:.78rem;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .2s;margin-left:8px}
.btn-upg:hover{background:var(--gold-light)}
.srow{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.sbox{background:#fff;border-radius:12px;padding:18px 20px;border:1px solid var(--border);box-shadow:var(--shadow)}
.snum{font-family:'Playfair Display',serif;font-size:2rem;font-weight:800;color:var(--navy);line-height:1}
.slbl{font-size:.75rem;color:var(--text-light);margin-top:3px;font-weight:500}
.sic{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;margin-bottom:10px}
.si-b{background:rgba(30,63,110,.1)}.si-g{background:rgba(45,155,90,.1)}.si-r{background:rgba(192,57,43,.1)}.si-gold{background:rgba(201,168,76,.15)}
.sgrid{display:grid;gap:12px}
.sc{background:#fff;border-radius:11px;border:1px solid var(--border);padding:16px 18px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow);transition:all .18s}
.sc:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.av{width:46px;height:46px;border-radius:11px;background:linear-gradient(135deg,var(--royal),var(--deep));display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;font-weight:700;font-family:'Playfair Display',serif;flex-shrink:0}
.sm{flex:1;min-width:0}
.sm h3{font-size:.93rem;font-weight:700;color:var(--navy)}
.sm .sub{font-size:.77rem;color:var(--text-light);margin-top:3px;display:flex;gap:12px;flex-wrap:wrap}
.bdg{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:.7rem;font-weight:600}
.bdg-c{background:rgba(30,63,110,.1);color:var(--royal)}
.bdg-s{background:rgba(201,168,76,.15);color:#9a6f00}
.bdg-paid{background:rgba(45,155,90,.12);color:var(--success)}
.sa{display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0}
.fbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:flex-end}
.fbar .fg{margin-bottom:0;min-width:140px;flex:1}
.sb{position:relative;flex:2}
.sb input{padding-left:38px!important;width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:.9rem;font-family:'DM Sans',sans-serif;color:var(--text-dark);background:#fff;transition:all .2s;outline:none}
.sb input:focus{border-color:var(--royal);box-shadow:0 0 0 3px rgba(30,63,110,.08)}
.si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-light);pointer-events:none}
.modal{position:fixed;inset:0;background:rgba(10,18,30,.75);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter:blur(4px)}
.modal.open{display:flex}
.mbox{background:#fff;border-radius:16px;padding:28px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(10,18,30,.35);animation:mIn .2s ease}
.mbox.mw{max-width:860px}
@keyframes mIn{from{opacity:0;transform:scale(.96) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.mhdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.mhdr h3{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:800;color:var(--navy)}
.mcl{width:34px;height:34px;border-radius:7px;background:var(--cream);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text-light);transition:all .2s}
.mcl:hover{background:#ffe0dd;color:var(--danger)}
.sin-w{position:relative;margin:18px 0}
.sin-w input{width:100%;padding:14px 18px;font-size:1.05rem;font-family:'DM Mono',monospace;border:2.5px solid var(--royal);border-radius:11px;outline:none;color:var(--navy);transition:all .2s}
.sin-w input:focus{box-shadow:0 0 0 4px rgba(30,63,110,.12)}
.sfeed{padding:12px 16px;border-radius:9px;margin-top:14px;font-size:.92rem;font-weight:500;min-height:54px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:4px}
.sfeed.suc{background:rgba(45,155,90,.1);color:var(--success);border:1px solid rgba(45,155,90,.25)}
.sfeed.err{background:rgba(192,57,43,.1);color:var(--danger);border:1px solid rgba(192,57,43,.2)}
.sfeed.wrn{background:rgba(230,126,34,.1);color:var(--warning);border:1px solid rgba(230,126,34,.2)}
.agrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px}
.ac{padding:11px 14px;border-radius:9px;border:1px solid;display:flex;flex-direction:column;gap:3px}
.ac.pres{background:rgba(45,155,90,.07);border-color:rgba(45,155,90,.25)}
.ac.abs{background:rgba(192,57,43,.05);border-color:rgba(192,57,43,.18)}
.an{font-weight:700;font-size:.87rem;color:var(--navy)}
.as{font-size:.75rem;color:var(--text-light)}
.at{font-family:'DM Mono',monospace;font-size:.77rem;color:var(--text-mid)}
.bpaper{background:#fff;border:2px solid var(--navy);border-radius:4px;padding:32px 28px;max-width:600px;margin:0 auto;font-size:.88rem}
.bsn{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;color:var(--navy);text-align:center}
.btag{text-align:center;font-size:.75rem;color:var(--text-light);margin-top:2px}
.brl{text-align:center;margin:10px 0;font-size:.95rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--gold);border-top:2px solid var(--navy);border-bottom:1px solid var(--border);padding:7px 0}
.bmeta{display:grid;grid-template-columns:1fr 1fr;gap:5px 18px;margin:14px 0}
.bmr{display:flex;gap:6px;font-size:.82rem}
.bmr span:first-child{color:var(--text-light);min-width:85px}
.bmr span:last-child{font-weight:600;color:var(--navy)}
.btbl{width:100%;border-collapse:collapse;margin:14px 0}
.btbl th{background:var(--navy);color:#fff;padding:8px 10px;text-align:left;font-size:.79rem;letter-spacing:.5px}
.btbl td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:.85rem}
.btbl tr:last-child td{border-bottom:none}
.btr{display:flex;justify-content:flex-end;margin-top:6px}
.btb{background:var(--navy);color:#fff;padding:10px 18px;border-radius:7px;display:flex;gap:18px;align-items:center}
.tlbl{font-size:.78rem;opacity:.75}
.tval{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:800;color:var(--gold-light)}
.bft{text-align:center;margin-top:20px;padding-top:14px;border-top:1px dashed var(--border);font-size:.75rem;color:var(--text-light)}
.tpills{display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap}
.tp{padding:7px 16px;border-radius:20px;font-size:.8rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);color:var(--text-mid);background:#fff;transition:all .18s;font-family:'DM Sans',sans-serif}
.tp.active{background:var(--royal);color:#fff;border-color:var(--royal)}
.tp:hover:not(.active){border-color:var(--royal);color:var(--royal)}
.stab{display:none}.stab.active{display:block}
.sdiv{display:flex;align-items:center;gap:10px;color:var(--text-light);font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin:20px 0 14px}
.sdiv::before,.sdiv::after{content:'';flex:1;height:1px;background:var(--border)}
.crow{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:16px}
.crow .fg{margin-bottom:0;min-width:150px}
.twrap{position:fixed;bottom:24px;right:24px;z-index:3000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--navy);color:#fff;padding:11px 18px;border-radius:9px;font-size:.85rem;font-weight:500;box-shadow:var(--shadow-lg);animation:tIn .25s ease;display:flex;align-items:center;gap:9px;min-width:240px}
@keyframes tIn{from{opacity:0;transform:translateX(28px)}to{opacity:1;transform:translateX(0)}}
.toast.suc{border-left:4px solid var(--success)}.toast.err{border-left:4px solid var(--danger)}.toast.inf{border-left:4px solid var(--info)}
.empty{text-align:center;padding:50px 20px;color:var(--text-light)}
.empty .ei{font-size:2.8rem;margin-bottom:10px}
.mbc{background:#fff;border-radius:9px;border:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:12px;transition:all .18s;margin-bottom:7px}
.mbc:hover{box-shadow:var(--shadow)}
.mbi{width:38px;height:38px;border-radius:9px;background:rgba(30,63,110,.08);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.mbn{font-weight:700;font-size:.88rem;color:var(--navy)}
.mbs{font-size:.75rem;color:var(--text-light);margin-top:2px}
.mba{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:800;color:var(--navy);text-align:right}
.mbst{font-family:'DM Sans',sans-serif;font-size:.7rem;font-weight:600;margin-top:2px}
.qbi{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;background:var(--cream);border:1px solid var(--border);margin-bottom:7px}
.qbd{width:7px;height:7px;border-radius:50%;flex-shrink:0;background:var(--success)}
.qbn{font-size:.82rem;font-weight:600;color:var(--navy)}
.qbs{font-size:.72rem;color:var(--text-light)}
.qbam{font-family:'DM Mono',monospace;font-size:.82rem;font-weight:600;color:var(--navy)}
.sbann{background:linear-gradient(135deg,var(--navy),var(--royal));border-radius:12px;padding:18px 22px;color:#fff;display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.sbann h3{font-family:'Playfair Display',serif;font-size:1rem;font-weight:800}
.sbann p{font-size:.8rem;color:rgba(255,255,255,.7);margin-top:2px}
.qrc{display:inline-block;text-align:center;padding:20px 18px;border:2px solid var(--navy);border-radius:12px;background:#fff}
.qrh{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:800;color:var(--navy)}
.qrs{font-size:.72rem;color:var(--text-light);margin:2px 0 10px}
.qrn{font-size:.95rem;font-weight:700;color:var(--navy);margin-top:7px}
.qrroll{font-family:'DM Mono',monospace;font-size:.8rem;color:var(--text-mid)}
.qrib{margin-top:14px;padding:12px;background:var(--cream);border-radius:9px;border:1px solid var(--border);text-align:left;font-size:.8rem;max-width:280px;margin-left:auto;margin-right:auto}
.qrir{display:flex;gap:7px;padding:3px 0;color:var(--text-dark)}
.qrir span:first-child{color:var(--text-light);min-width:75px}
.fab{background:var(--gold);color:var(--navy);border:none;width:32px;height:32px;border-radius:7px;font-size:1.3rem;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-weight:700;transition:all .2s;vertical-align:middle;margin-left:7px}
.fab:hover{background:var(--gold-light);transform:scale(1.06)}
.notice-card{background:#fff;border-radius:9px;border:1px solid var(--border);padding:14px 18px;margin-bottom:10px;box-shadow:var(--shadow)}
.notice-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.notice-title{font-weight:700;font-size:.92rem;color:var(--navy)}
.notice-date{font-size:.7rem;color:var(--text-light)}
.notice-msg{font-size:.82rem;color:var(--text-mid);line-height:1.5}
.notice-rcpt{font-size:.72rem;color:var(--text-light);margin-top:6px}
@media print{body>*:not(#pr){display:none!important}#pr{display:block!important;position:absolute;top:0;left:0;width:100%}.np{display:none!important}}
@media(max-width:860px){.app{grid-template-columns:1fr}.sidebar{display:flex;flex-wrap:wrap;padding:10px;gap:3px}.nav-lbl{display:none}.ni{border-left:none;border-radius:7px;padding:7px 10px;font-size:.78rem}.srow{grid-template-columns:repeat(2,1fr)}.fr{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <div style="text-align:center;margin-bottom:20px">
      <div class="logo-icon" style="margin:0 auto">\ud83c\udf93</div>
    </div>
    <h2>Admin Login</h2>
    <p>Central Public School Management</p>
    <form onsubmit="doLogin(event)">
      <div class="fg">
        <label>Username</label>
        <input type="text" id="loginUser" required placeholder="Enter username">
      </div>
      <div class="fg">
        <label>Password</label>
        <input type="password" id="loginPass" required placeholder="Enter password">
      </div>
      <button type="submit" class="btn btn-p" style="width:100%;justify-content:center">Login</button>
    </form>
    <p style="margin-top:16px;font-size:.75rem;color:var(--danger)" id="loginErr"></p>
  </div>
</div>

<header class="hdr" style="display:none" id="mainHeader">
  <div class="logo">
    <div class="logo-icon">\ud83c\udf93</div>
    <div>
      <h1>Central Public School</h1>
      <span>Management System</span>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <span class="sess-tag" id="sessTag">Session 2026\u201327</span>
    <button class="btn-upg" onclick="showSessUpgrade()">\u21e7 New Session</button>
    <button class="btn btn-d btn-sm" onclick="logout()">Logout</button>
  </div>
</header>

<div class="app" style="display:none" id="mainApp">
  <nav class="sidebar">
    <div class="nav-lbl">Main</div>
    <div class="ni active" onclick="goP('dashboard',this)"><span class="ni-ic">\ud83d\udcca</span> Dashboard</div>
    <div class="ni" onclick="goP('register',this)"><span class="ni-ic">\u270e</span> Register</div>
    <div class="ni" onclick="goP('students',this)"><span class="ni-ic">\ud83d\udc65</span> Students</div>
    <div class="nav-lbl">Operations</div>
    <div class="ni" onclick="goP('attendance',this)"><span class="ni-ic">\ud83d\udccb</span> Attendance</div>
    <div class="ni" onclick="goP('billing',this)"><span class="ni-ic">\ud83d\udcb3</span> Billing</div>
    <div class="ni" onclick="goP('notices',this)"><span class="ni-ic">\ud83d\udce2</span> Notices</div>
    <div class="ni" onclick="goP('reports',this)"><span class="ni-ic">\ud83d\udcc8</span> Reports</div>
    <div class="nav-lbl">Settings</div>
    <div class="ni" onclick="goP('sessions',this)"><span class="ni-ic">\ud83d\udcc1</span> Sessions</div>
  </nav>

  <main class="mc">
    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="ph"><h2>Dashboard</h2><p>Central Public School overview</p></div>
      <div class="srow" id="dStats"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
        <div class="card"><div class="ct">\ud83d\udcc5 Today's Attendance</div><div id="dAtt"></div></div>
        <div class="card"><div class="ct">\ud83d\udcb0 Recent Bills</div><div id="dBills"></div></div>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="page-register" class="page">
      <div class="ph"><h2>Register Student <button class="fab" onclick="goP('billing',document.querySelector('[onclick*=billing]'))">+</button></h2><p>Add to current session</p></div>
      <div style="display:grid;grid-template-columns:1fr 310px;gap:20px;align-items:start">
        <div class="card">
          <form id="sForm" onsubmit="regStudent(event)">
            <div class="fr">
              <div class="fg"><label>Student Name *</label><input id="rn" required placeholder="Full name"></div>
              <div class="fg"><label>Class *</label><select id="rc" required onchange="updateRollSugg()"><option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
            </div>
            <div class="fg">
              <label>Roll Number * <span id="rollSugg" style="color:var(--gold);font-weight:700"></span></label>
              <input id="rr" required placeholder="e.g. 001">
            </div>
            <div class="fr">
              <div class="fg"><label>Date of Birth *</label><input type="date" id="rd" required></div>
              <div class="fg"><label>Parent Name *</label><input id="rp" required placeholder="Father/Mother"></div>
            </div>
            <div class="fr">
              <div class="fg"><label>Phone *</label><input id="rpm" pattern="[0-9]{10}" required placeholder="10 digit mobile"></div>
              <div class="fg"><label>Date of Joining *</label><input type="date" id="rj" required></div>
            </div>
            <div class="fg"><label>Monthly Fee (\u20b9) *</label><input type="number" id="rf" required placeholder="e.g. 1500"></div>
            <div class="fg"><label>Address</label><textarea id="ra" rows="2" placeholder="Optional"></textarea></div>
            <div style="display:flex;gap:9px;margin-top:6px">
              <button type="submit" class="btn btn-p">\u2713 Register</button>
              <button type="button" class="btn btn-o" onclick="clrForm()">Clear</button>
            </div>
          </form>
        </div>
        <div class="card" style="position:sticky;top:90px">
          <div class="ct">\ud83d\udcc5 Recent Bills</div>
          <div class="fg" style="margin-bottom:10px"><label>Month</label><select id="qbM" onchange="renderQB()"></select></div>
          <div id="qbList"></div>
        </div>
      </div>
    </div>

    <!-- STUDENTS -->
    <div id="page-students" class="page">
      <div class="ph" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div><h2>Students</h2><p><span id="scnt">0</span> total</p></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-p btn-sm" onclick="goP('register',document.querySelector('[onclick*=register]'))">+ Add</button>
        </div>
      </div>
      <div class="fbar">
        <div class="sb"><span class="si">\ud83d\udd0d</span><input type="text" id="srch" placeholder="Search name, roll..." oninput="renderStudents()"></div>
        <div class="fg"><label>Class</label><select id="fCls" onchange="renderStudents()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        <div class="fg"><label>Session</label><select id="fSess" onchange="renderStudents()"><option value="">All Sessions</option></select></div>
        <button class="btn btn-i btn-sm" onclick="showQRDownload()">\ud83d\udce5 Download QR Codes</button>
      </div>
      <div id="sGrid" class="sgrid"></div>
    </div>

    <!-- ATTENDANCE -->
    <div id="page-attendance" class="page">
      <div class="ph"><h2>Mark Attendance</h2><p>Scan QR or enter roll number</p></div>
      <div style="max-width:500px;margin:0 auto;text-align:center;padding:16px 0">
        <div style="font-size:3.2rem">\ud83d\udcf7</div>
        <p style="color:var(--text-light);font-size:.88rem;margin:8px 0">Scan QR code or type roll number below</p>
        <div class="sin-w"><input type="text" id="scanIn" placeholder="Roll Number..." onkeydown="if(event.key==='Enter')markAtt()" autocomplete="off"></div>
        <button class="btn btn-p" style="width:100%;justify-content:center;padding:13px" onclick="markAtt()">\u2713 Mark Present</button>
        <div id="sFeed" class="sfeed" style="display:none"></div>
      </div>
      <div class="sdiv">Attendance Log</div>
      <div class="crow">
        <div class="fg"><label>Date</label><input type="date" id="aDate" onchange="renderAttR()"></div>
        <div class="fg"><label>Class</label><select id="aCls" onchange="renderAttR()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        <button class="btn btn-o btn-sm np" onclick="window.print()" style="align-self:flex-end">\ud83d\udda8 Print</button>
      </div>
      <div class="srow" id="aStats" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px"></div>
      <div id="aReport"></div>
    </div>

    <!-- BILLING -->
    <div id="page-billing" class="page">
      <div class="ph"><h2>Fee Management</h2><p>Generate, track and print bills</p></div>
      <div class="tpills">
        <div class="tp active" onclick="swBTab('gen',this)">\ud83d\udcdd Generate Bill</div>
        <div class="tp" onclick="swBTab('ov',this)">\ud83d\udcca Monthly Overview</div>
        <div class="tp" onclick="swBTab('hist',this)">\ud83d\udcc2 Bill History</div>
      </div>
      
      <div id="bt-gen" class="stab active">
        <div class="fr" style="margin-bottom:0">
          <div class="fg"><label>Select Class</label><select id="bCls" onchange="loadBStu()"><option value="">Choose class</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <div class="fg"><label>Select Student</label><select id="bStu" onchange="loadSBill()"><option value="">Choose student</option></select></div>
        </div>
        <div class="fr">
          <div class="fg"><label>Billing Month</label><select id="bMo"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Year</label><select id="bYr"><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option></select></div>
        </div>
        <div class="card" id="bItems" style="display:none;margin-bottom:18px">
          <div class="ct">\ud83d\udccb Bill Items</div>
          <div id="bItemList" style="margin-bottom:12px"></div>
          <div style="display:flex;gap:9px;align-items:flex-end">
            <div class="fg" style="flex:2;margin:0"><label>Item Name</label><input type="text" id="iName" placeholder="e.g. Books" onkeydown="if(event.key==='Enter')addItem()"></div>
            <div class="fg" style="flex:1;margin:0"><label>Amount (\u20b9)</label><input type="number" id="iAmt" placeholder="500" onkeydown="if(event.key==='Enter')addItem()"></div>
            <button class="btn btn-i btn-sm np" onclick="addItem()" style="height:38px">+ Add</button>
          </div>
        </div>
        <div id="bPrevW" style="display:none">
          <div id="bPrev"></div>
          <div class="np" style="display:flex;gap:9px;margin-top:14px;justify-content:center">
            <button class="btn btn-s" onclick="saveBill()">\ud83d\udcbe Save (Mark Paid)</button>
            <button class="btn btn-p" onclick="printOnly()">\ud83d\udda8 Print Only</button>
            <button class="btn btn-i" onclick="sendSMS()">\ud83d\udcf1 Send SMS</button>
          </div>
        </div>
      </div>

      <div id="bt-ov" class="stab">
        <div class="crow">
          <div class="fg"><label>Month</label><select id="ovMo"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Year</label><select id="ovYr"><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option></select></div>
          <div class="fg"><label>Class</label><select id="ovCls"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <div class="fg"><label>Roll Number</label><input type="text" id="ovRoll" placeholder="e.g. 001"></div>
          <button class="btn btn-p btn-sm" onclick="renderOv()" style="align-self:flex-end">View</button>
        </div>
        <div class="srow" id="ovStats" style="grid-template-columns:repeat(3,1fr);margin-bottom:16px"></div>
        <div id="ovList"></div>
      </div>

      <div id="bt-hist" class="stab">
        <div class="crow">
          <div class="fg"><label>Search</label><input type="text" id="hSrch" placeholder="Name or roll..." oninput="renderHist()"></div>
          <div class="fg"><label>Month</label><select id="hMo" onchange="renderHist()"><option value="">All</option><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Class</label><select id="hCls" onchange="renderHist()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        </div>
        <div id="hList" class="sgrid"></div>
      </div>
    </div>

    <!-- NOTICES -->
    <div id="page-notices" class="page">
      <div class="ph"><h2>Notice Board</h2><p>Send messages to parents</p></div>
      <div class="card" style="margin-bottom:20px">
        <div class="ct">\ud83d\udce2 Send New Notice</div>
        <div class="fg"><label>Notice Title</label><input type="text" id="notTitle" placeholder="e.g. Parent-Teacher Meeting"></div>
        <div class="fg"><label>Message</label><textarea id="notMsg" rows="4" placeholder="Enter your message..."></textarea></div>
        <div class="fr">
          <div class="fg"><label>Send To</label><select id="notType" onchange="toggleNotClass()"><option value="all">All Parents</option><option value="class">Specific Class</option><option value="student">Specific Student</option></select></div>
          <div class="fg" id="notClsWrap" style="display:none"><label>Select Class</label><select id="notCls"><option value="">Choose class</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <div class="fg" id="notStuWrap" style="display:none"><label>Select Student</label><select id="notStu"><option value="">Choose student</option></select></div>
        </div>
        <button class="btn btn-p" onclick="sendNotice()">\ud83d\udce4 Send Notice</button>
      </div>
      <div class="sdiv">Notice History</div>
      <div id="noticeList"></div>
    </div>

    <!-- REPORTS -->
    <div id="page-reports" class="page">
      <div class="ph"><h2>Reports</h2><p>Attendance and financial analytics</p></div>
      <div class="tpills">
        <div class="tp active" onclick="swRTab('att',this)">\ud83d\udccb Attendance</div>
        <div class="tp" onclick="swRTab('fin',this)">\ud83d\udcb0 Financial</div>
      </div>
      <div id="rt-att" class="stab active">
        <div class="crow">
          <div class="fg"><label>Date</label><input type="date" id="rDate" onchange="renderRpt()"></div>
          <div class="fg"><label>Class</label><select id="rCls" onchange="renderRpt()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <button class="btn btn-o btn-sm np" onclick="window.print()" style="align-self:flex-end">\ud83d\udda8 Print</button>
        </div>
        <div class="srow" id="rStats"></div>
        <div id="rCnt"></div>
      </div>
      <div id="rt-fin" class="stab">
        <div class="crow">
          <div class="fg"><label>Month</label><select id="fMo"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Year</label><select id="fYr"><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option></select></div>
          <button class="btn btn-p btn-sm" onclick="renderFin()" style="align-self:flex-end">Generate</button>
        </div>
        <div id="fRpt"></div>
      </div>
    </div>

    <!-- SESSIONS -->
    <div id="page-sessions" class="page">
      <div class="ph"><h2>Session Management</h2><p>Academic year archives and upgrades</p></div>
      <div id="sessList"></div>
    </div>
  </main>
</div>

<!-- Modals -->
<div id="qrM" class="modal"><div class="mbox"><div class="mhdr"><h3 id="qrMT">QR Code</h3><button class="mcl" onclick="clsM('qrM')">\u2715</button></div><div id="qrMB"></div></div></div>
<div id="sessM" class="modal"><div class="mbox"><div class="mhdr"><h3>\u21e7 New Session</h3><button class="mcl" onclick="clsM('sessM')">\u2715</button></div><div id="sessMB"></div></div></div>
<div id="qrDownM" class="modal"><div class="mbox mw"><div class="mhdr"><h3>Download QR Codes</h3><button class="mcl" onclick="clsM('qrDownM')">\u2715</button></div><div id="qrDownB"></div></div></div>

<div class="twrap" id="twrap"></div>
<div id="pr" style="display:none"></div>

<script>
const MO=['','January','February','March','April','May','June','July','August','September','October','November','December'];

let db={
  students:JSON.parse(localStorage.getItem('cps_s'))||[],
  attendance:JSON.parse(localStorage.getItem('cps_a'))||{},
  bills:JSON.parse(localStorage.getItem('cps_b'))||[],
  sessions:JSON.parse(localStorage.getItem('cps_ss'))||[],
  notices:JSON.parse(localStorage.getItem('cps_n'))||[],
  cur:localStorage.getItem('cps_cur')||'2026-27',
  admin:JSON.parse(localStorage.getItem('cps_admin'))||null
};

function sv(){
  localStorage.setItem('cps_s',JSON.stringify(db.students));
  localStorage.setItem('cps_a',JSON.stringify(db.attendance));
  localStorage.setItem('cps_b',JSON.stringify(db.bills));
  localStorage.setItem('cps_ss',JSON.stringify(db.sessions));
  localStorage.setItem('cps_n',JSON.stringify(db.notices));
  localStorage.setItem('cps_cur',db.cur);
  localStorage.setItem('cps_admin',JSON.stringify(db.admin));
}

function doLogin(e){
  e.preventDefault();
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  
  if(!db.admin){
    db.admin={username:u,password:p};
    sv();
    toast('Admin account created!','suc');
    showApp();
  }else{
    if(db.admin.username===u&&db.admin.password===p){
      showApp();
    }else{
      document.getElementById('loginErr').textContent='Invalid credentials!';
      setTimeout(()=>document.getElementById('loginErr').textContent='',3000);
    }
  }
}

function showApp(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('mainHeader').style.display='flex';
  document.getElementById('mainApp').style.display='grid';
  initApp();
}

function logout(){
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('mainHeader').style.display='none';
  document.getElementById('mainApp').style.display='none';
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
}

function initApp(){
  document.getElementById('rj').valueAsDate=new Date();
  document.getElementById('aDate').valueAsDate=new Date();
  document.getElementById('rDate').valueAsDate=new Date();
  const m=new Date().getMonth()+1;
  ['bMo','ovMo','fMo'].forEach(id=>{const e=document.getElementById(id);if(e)e.value=m;});
  document.getElementById('sessTag').textContent='Session '+db.cur;
  populateQBM();populateFSess();
  renderDash();renderStudents();renderAttR();renderSess();renderQB();renderNotices();
}

window.addEventListener('load',function(){
  if(db.admin){
    const p=new URLSearchParams(window.location.search),r=p.get('attendance');
    if(r){
      showApp();
      setTimeout(()=>markFromQR(r),500);
    }
  }
});

function populateQBM(){
  const s=document.getElementById('qbM');s.innerHTML='<option value="">All months</option>';
  for(let i=1;i<=12;i++){const o=document.createElement('option');o.value=i;o.textContent=MO[i];s.appendChild(o);}
  s.value=new Date().getMonth()+1;
}

function populateFSess(){
  const s=document.getElementById('fSess');
  [...new Set(db.students.map(x=>x.session).filter(Boolean))].sort().reverse().forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent='Session '+x;s.appendChild(o);});
}

function goP(n,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+n).classList.add('active');
  if(el)el.classList.add('active');
  if(n==='dashboard')renderDash();
  if(n==='students')renderStudents();
  if(n==='reports')renderRpt();
  if(n==='sessions')renderSess();
  if(n==='billing')renderHist();
  if(n==='register')renderQB();
  if(n==='notices')renderNotices();
}

function swBTab(n,el){
  document.querySelectorAll('#page-billing .stab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#page-billing .tp').forEach(t=>t.classList.remove('active'));
  document.getElementById('bt-'+n).classList.add('active');el.classList.add('active');
  if(n==='hist')renderHist();if(n==='ov')renderOv();
}

function swRTab(n,el){
  document.querySelectorAll('#page-reports .stab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#page-reports .tp').forEach(t=>t.classList.remove('active'));
  document.getElementById('rt-'+n).classList.add('active');el.classList.add('active');
}

function toast(msg,type='inf',dur=3000){
  const w=document.getElementById('twrap'),t=document.createElement('div');
  t.className='toast '+type;
  t.innerHTML=(type==='suc'?'\u2713':type==='err'?'\u2717':'\u2139')+' '+msg;
  w.appendChild(t);setTimeout(()=>t.remove(),dur);
}

function opM(id){document.getElementById(id).classList.add('open');}
function clsM(id){document.getElementById(id).classList.remove('open');}

function getNextRoll(cls){
  const existing=db.students.filter(s=>s.class===cls&&s.session===db.cur).map(s=>parseInt(s.rollNumber)||0);
  const max=existing.length?Math.max(...existing):0;
  return String(max+1).padStart(3,'0');
}

function updateRollSugg(){
  const cls=document.getElementById('rc').value;
  if(cls){
    const next=getNextRoll(cls);
    document.getElementById('rollSugg').textContent='(Suggested: '+next+')';
  }else{
    document.getElementById('rollSugg').textContent='';
  }
}

function regStudent(e){
  e.preventDefault();
  const cls=document.getElementById('rc').value;
  const roll=document.getElementById('rr').value.trim();
  
  if(db.students.find(s=>s.rollNumber===roll&&s.class===cls&&s.session===db.cur)){
    toast('Roll number exists in this class!','err');return;
  }
  
  const s={
    id:Date.now(),
    name:document.getElementById('rn').value.trim(),
    rollNumber:roll,
    dob:document.getElementById('rd').value,
    parentName:document.getElementById('rp').value.trim(),
    phoneNumber:document.getElementById('rpm').value.trim(),
    class:cls,
    joiningDate:document.getElementById('rj').value,
    monthlyFee:parseFloat(document.getElementById('rf').value),
    address:document.getElementById('ra').value.trim(),
    session:db.cur
  };
  
  db.students.push(s);sv();toast('Registered: '+s.name,'suc');
  document.getElementById('sForm').reset();
  document.getElementById('rj').valueAsDate=new Date();
  updateRollSugg();
  renderStudents();renderDash();renderQB();
}

function clrForm(){
  document.getElementById('sForm').reset();
  document.getElementById('rj').valueAsDate=new Date();
  updateRollSugg();
}

function getAP(r,c){
  let t=0,p=0;
  for(let d in db.attendance){
    const st=db.students.find(s=>s.rollNumber===r&&s.class===c);
    if(st){t++;if(db.attendance[d][r+'-'+c])p++;}
  }
  return t?Math.round(p/t*100):0;
}

function renderDash(){
  const td=new Date().toISOString().split('T')[0],ta=db.attendance[td]||{};
  const ss=db.students.filter(s=>s.session===db.cur);
  const pr=ss.filter(s=>ta[s.rollNumber+'-'+s.class]).length;
  const m=new Date().getMonth()+1,y=new Date().getFullYear();
  const mb=db.bills.filter(b=>b.month==m&&b.year==y&&b.paid),col=mb.reduce((a,b)=>a+b.total,0);
  
  document.getElementById('dStats').innerHTML=`<div class="sbox"><div class="sic si-b">\ud83d\udc65</div><div class="snum">${ss.length}</div><div class="slbl">Total Students</div></div><div class="sbox"><div class="sic si-g">\u2713</div><div class="snum">${pr}</div><div class="slbl">Present Today</div></div><div class="sbox"><div class="sic si-r">\u26a0</div><div class="snum">${ss.length-pr}</div><div class="slbl">Absent Today</div></div><div class="sbox"><div class="sic si-gold">\ud83d\udcb0</div><div class="snum">\u20b9${col.toLocaleString('en-IN')}</div><div class="slbl">Collected This Month</div></div>`;
  
  const ae=document.getElementById('dAtt'),plist=ss.filter(s=>ta[s.rollNumber+'-'+s.class]).slice(0,5);
  ae.innerHTML=plist.length?plist.map(s=>`<div class="ac pres" style="margin-bottom:7px"><div class="an">${s.name}</div><div class="as">Class ${s.class} \u2022 ${s.rollNumber}</div><div class="at">\ud83d\udd50 ${ta[s.rollNumber+'-'+s.class].time}</div></div>`).join('')+(pr>5?`<p style="color:var(--text-light);font-size:.75rem;margin-top:6px">+${pr-5} more...</p>`:''):'<div class="empty" style="padding:16px 0"><div class="ei">\ud83d\udccb</div><p>No attendance today</p></div>';
  
  const be=document.getElementById('dBills'),rb=[...db.bills].filter(b=>b.paid).sort((a,b)=>b.createdAt-a.createdAt).slice(0,5);
  be.innerHTML=rb.length?rb.map(b=>`<div class="qbi"><div class="qbd"></div><div><div class="qbn">${b.studentName}</div><div class="qbs">${MO[b.month]} ${b.year} \u2022 Class ${b.studentClass}</div></div><div class="qbam" style="margin-left:auto">\u20b9${b.total.toLocaleString('en-IN')}</div></div>`).join(''):'<div class="empty" style="padding:16px 0"><div class="ei">\ud83d\udcb3</div><p>No bills yet</p></div>';
}

function renderStudents(){
  const srch=(document.getElementById('srch')?.value||'').toLowerCase(),cls=document.getElementById('fCls')?.value||'',sess=document.getElementById('fSess')?.value||'';
  let list=db.students.filter(s=>{
    if(cls&&s.class!==cls)return false;
    if(sess&&s.session!==sess)return false;
    if(srch&&!s.name.toLowerCase().includes(srch)&&!s.rollNumber.toLowerCase().includes(srch))return false;
    return true;
  });
  
  document.getElementById('scnt').textContent=list.length;
  const g=document.getElementById('sGrid');
  if(!list.length){g.innerHTML='<div class="empty"><div class="ei">\ud83d\udc64</div><h4>No students found</h4></div>';return;}
  
  g.innerHTML=list.map(s=>{
    const ap=getAP(s.rollNumber,s.class),init=s.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
    const paid=db.bills.filter(b=>b.studentId===s.id&&b.paid).length;
    const unpaid=db.bills.filter(b=>b.studentId===s.id&&!b.paid).length;
    return`<div class="sc"><div class="av">${init}</div><div class="sm"><h3>${s.name} <span class="bdg bdg-c">Class ${s.class}</span> <span class="bdg bdg-s">${s.session}</span></h3><div class="sub"><span>\ud83d\udccb ${s.rollNumber}</span><span>\ud83d\udc6a ${s.parentName}</span><span>\ud83d\udcf1 ${s.phoneNumber}</span></div><div style="margin-top:5px;display:flex;align-items:center;gap:9px"><div style="flex:1;background:#e9ecef;border-radius:20px;height:5px;max-width:140px"><div style="background:${ap>=75?'var(--success)':ap>=50?'var(--warning)':'var(--danger)'};width:${ap}%;height:5px;border-radius:20px"></div></div><span style="font-size:.7rem;color:var(--text-light)">${ap}% \u2022 ${paid} paid, ${unpaid} unpaid</span></div></div><div class="sa"><button class="btn btn-i btn-xs" onclick="showQR(${s.id})">QR Code</button><button class="btn btn-g btn-xs" onclick="qkBill(${s.id})">Bill</button><button class="btn btn-o btn-xs" onclick="upgStu(${s.id})" title="Upgrade session">\u21e7</button><button class="btn btn-d btn-xs" onclick="delStu(${s.id})">\ud83d\uddd1</button></div></div>`;
  }).join('');
}

function delStu(id){
  if(!confirm('Delete this student?'))return;
  db.students=db.students.filter(s=>s.id!==id);sv();
  renderStudents();renderDash();toast('Deleted','inf');
}

function upgStu(id){
  const s=db.students.find(s=>s.id===id);if(!s)return;
  goP('register',document.querySelector('[onclick*=\'register\']'));
  setTimeout(()=>{
    document.getElementById('rn').value=s.name;document.getElementById('rd').value=s.dob;
    document.getElementById('rp').value=s.parentName;document.getElementById('rpm').value=s.phoneNumber;
    document.getElementById('rc').value=s.class;document.getElementById('rf').value=s.monthlyFee;
    document.getElementById('ra').value=s.address||'';document.getElementById('rr').value='';
    document.getElementById('rj').valueAsDate=new Date();
    updateRollSugg();
    toast('Form prefilled \u2014 enter new Roll No for session '+db.cur,'inf',5000);
  },150);
}

function qkBill(id){
  goP('billing',document.querySelector('[onclick*=\'billing\']'));
  setTimeout(()=>{
    const s=db.students.find(s=>s.id===id);if(!s)return;
    document.getElementById('bCls').value=s.class;loadBStu();
    setTimeout(()=>{document.getElementById('bStu').value=id;loadSBill();},110);
  },180);
}

const BU=window.location.href.split('?')[0];

function showQR(id){
  const s=db.students.find(s=>s.id===id);if(!s)return;
  const url=BU+'?attendance='+s.rollNumber+'-'+s.class;
  
  document.getElementById('qrMT').textContent=s.name+' \u2014 QR Code';
  document.getElementById('qrMB').innerHTML=`<div style="text-align:center">
    <div class="qrc" id="qrCS"><div class="qrh">\ud83c\udf93 Central Public School</div><div class="qrs">Session ${s.session} \u2022 Class ${s.class}</div><div id="qrCV" style="margin:10px auto;display:inline-block"></div><div class="qrn">${s.name}</div><div class="qrroll">Roll: ${s.rollNumber}</div></div>
    <div class="qrib"><div style="font-weight:700;margin-bottom:7px;color:var(--navy)">\ud83d\udccc Scan to mark attendance</div><div class="qrir"><span>\ud83d\udc64 Name:</span><span><b>${s.name}</b></span></div><div class="qrir"><span>\ud83d\udd22 Roll:</span><span>${s.rollNumber}</span></div><div class="qrir"><span>\ud83d\udcda Class:</span><span>Class ${s.class}</span></div><div class="qrir"><span>\ud83d\udcf1 Phone:</span><span>${s.phoneNumber}</span></div></div>
    <div class="np" style="display:flex;gap:9px;justify-content:center;margin-top:18px"><button class="btn btn-p" onclick="prQR()">\ud83d\udda8 Print Card</button><button class="btn btn-o" onclick="clsM('qrM')">Close</button></div>
  </div>`;
  
  opM('qrM');
  setTimeout(()=>{
    const qr=document.getElementById('qrCV');
    qr.innerHTML='';
    new QRCode(qr,{text:url,width:190,height:190,colorDark:'#0f1b2d',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.H});
  },200);
}

function prQR(){
  const c=document.getElementById('qrCS'),pr=document.getElementById('pr');
  pr.innerHTML='<div style="padding:28px;text-align:center">'+c.outerHTML+'</div>';
  pr.style.display='block';window.print();pr.style.display='none';pr.innerHTML='';
}

function showQRDownload(){
  const cls=document.getElementById('fCls')?.value||'';
  
  document.getElementById('qrDownB').innerHTML=`
    <div class="fg"><label>Select Class</label><select id="qrDCls"><option value="">All Classes</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
    <button class="btn btn-p" onclick="genQRs()" style="width:100%;justify-content:center">Generate QR Codes</button>
    <div id="qrGrid" style="margin-top:20px"></div>
  `;
  
  if(cls)document.getElementById('qrDCls').value=cls;
  opM('qrDownM');
}

function genQRs(){
  const cls=document.getElementById('qrDCls').value;
  const sess=document.getElementById('fSess')?.value||db.cur;
  const list=db.students.filter(s=>{
    if(s.session!==sess)return false;
    if(cls&&s.class!==cls)return false;
    return true;
  });
  
  if(!list.length){toast('No students match filter','err');return;}
  
  document.getElementById('qrGrid').innerHTML=`
    <div class="np" style="text-align:center;margin-bottom:16px"><button class="btn btn-p" onclick="window.print()">\ud83d\udda8 Print All</button></div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px">${list.map((s,i)=>`<div style="text-align:center;border:2px solid var(--navy);border-radius:11px;padding:14px;page-break-inside:avoid"><div style="font-family:'Playfair Display',serif;font-size:.9rem;font-weight:800;color:var(--navy)">Central Public School</div><div style="font-size:.7rem;color:var(--text-light);margin:2px 0 8px">Session ${s.session} \u2022 Class ${s.class}</div><div id="qa${i}" style="margin:0 auto;display:inline-block"></div><div style="font-size:.88rem;font-weight:700;color:var(--navy);margin-top:7px">${s.name}</div><div style="font-family:'DM Mono',monospace;font-size:.75rem;color:var(--text-mid)">Roll: ${s.rollNumber}</div><div style="font-size:.7rem;color:var(--text-light);margin-top:2px">${s.phoneNumber}</div></div>`).join('')}</div>
  `;
  
  setTimeout(()=>{
    list.forEach((s,i)=>{
      const qr=document.getElementById('qa'+i);
      if(qr){
        qr.innerHTML='';
        new QRCode(qr,{text:BU+'?attendance='+s.rollNumber+'-'+s.class,width:150,height:150,colorDark:'#0f1b2d',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.H});
      }
    });
  },300);
}

function markFromQR(r){
  const parts=r.split('-');
  if(parts.length!==2){alert('Invalid QR code format');return;}
  
  const roll=parts[0],cls=parts[1];
  const s=db.students.find(s=>s.rollNumber===roll&&s.class===cls);
  
  if(!s){alert('Student not found: Roll '+roll+', Class '+cls);return;}
  
  const td=new Date().toISOString().split('T')[0];
  if(!db.attendance[td])db.attendance[td]={};
  
  const key=s.rollNumber+'-'+s.class;
  if(db.attendance[td][key]){
    alert('Already marked!\n\ud83d\udc64 '+s.name+'\n\ud83d\udd22 '+roll+'\n\ud83d\udcda Class '+cls+'\n\ud83d\udd50 '+db.attendance[td][key].time+'\n\ud83d\udcf1 '+s.phoneNumber);
    return;
  }
  
  const time=new Date().toLocaleTimeString('en-IN');
  db.attendance[td][key]={name:s.name,class:s.class,time,phone:s.phoneNumber};sv();
  alert('Attendance Marked!\n\ud83d\udc64 '+s.name+'\n\ud83d\udd22 Roll: '+roll+'\n\ud83d\udcda Class '+cls+'\n\ud83d\udcf1 '+s.phoneNumber+'\n\ud83d\udd50 '+time);
  renderDash();renderAttR();
}

function markAtt(){
  const input=document.getElementById('scanIn').value.trim();if(!input)return;
  
  let roll,cls;
  if(input.includes('-')){
    const parts=input.split('-');
    roll=parts[0];cls=parts[1];
  }else{
    roll=input;
    const matches=db.students.filter(s=>s.rollNumber===roll&&s.session===db.cur);
    if(matches.length===0){
      showFeedback('err','Not found: '+roll);return;
    }else if(matches.length>1){
      showFeedback('wrn','Multiple students with this roll. Use format: ROLL-CLASS');return;
    }
    cls=matches[0].class;
  }
  
  const s=db.students.find(s=>s.rollNumber===roll&&s.class===cls);
  if(!s){showFeedback('err','Not found: '+roll+(cls?' (Class '+cls+')':''));return;}
  
  const td=new Date().toISOString().split('T')[0];
  if(!db.attendance[td])db.attendance[td]={};
  
  const key=s.rollNumber+'-'+s.class;
  if(db.attendance[td][key]){
    showFeedback('wrn','Already marked \u2014 <b>'+s.name+'</b> at '+db.attendance[td][key].time);
  }else{
    const time=new Date().toLocaleTimeString('en-IN');
    db.attendance[td][key]={name:s.name,class:s.class,time,phone:s.phoneNumber};
    sv();renderAttR();renderDash();
    showFeedback('suc','<b>'+s.name+'</b> \u2022 Class '+s.class+' \u2022 \ud83d\udd50 '+time);
  }
  
  document.getElementById('scanIn').value='';
}

function showFeedback(type,msg){
  const f=document.getElementById('sFeed');
  f.style.display='flex';
  f.className='sfeed '+type;
  f.innerHTML=(type==='suc'?'\u2713':type==='err'?'\u2717':'\u26a0')+' '+msg;
  setTimeout(()=>{f.style.display='none';},3500);
}

function renderAttR(){
  const date=document.getElementById('aDate')?.value,cls=document.getElementById('aCls')?.value||'';
  if(!date)return;
  
  const da=db.attendance[date]||{};
  let ss=db.students.filter(s=>s.session===db.cur);
  if(cls)ss=ss.filter(s=>s.class===cls);
  
  const pr=ss.filter(s=>da[s.rollNumber+'-'+s.class]);
  const ab=ss.filter(s=>!da[s.rollNumber+'-'+s.class]);
  
  document.getElementById('aStats').innerHTML=`<div class="sbox"><div class="sic si-b">\ud83d\udc65</div><div class="snum">${ss.length}</div><div class="slbl">Total</div></div><div class="sbox"><div class="sic si-g">\u2713</div><div class="snum">${pr.length}</div><div class="slbl">Present</div></div><div class="sbox"><div class="sic si-r">\u2717</div><div class="snum">${ab.length}</div><div class="slbl">Absent</div></div><div class="sbox"><div class="sic si-gold">\ud83d\udcca</div><div class="snum">${ss.length?Math.round(pr.length/ss.length*100):0}%</div><div class="slbl">Rate</div></div>`;
  
  let h='<div class="sdiv">Present ('+pr.length+')</div><div class="agrid">';
  pr.forEach(s=>{h+=`<div class="ac pres"><div class="an">${s.name}</div><div class="as">Roll ${s.rollNumber} \u2022 Class ${s.class}</div><div class="at">\ud83d\udd50 ${da[s.rollNumber+'-'+s.class].time}</div></div>`;});
  h+='</div><div class="sdiv">Absent ('+ab.length+')</div><div class="agrid">';
  ab.forEach(s=>{h+=`<div class="ac abs"><div class="an">${s.name}</div><div class="as">Roll ${s.rollNumber} \u2022 Class ${s.class}</div><div class="as">\ud83d\udcf1 ${s.phoneNumber}</div></div>`;});
  h+='</div>';document.getElementById('aReport').innerHTML=h;
}

let cb={student:null,items:[]};

function loadBStu(){
  const cls=document.getElementById('bCls').value,sel=document.getElementById('bStu');
  sel.innerHTML='<option value="">Choose student</option>';if(!cls)return;
  db.students.filter(s=>s.class===cls&&s.session===db.cur).forEach(s=>{
    const o=document.createElement('option');o.value=s.id;o.textContent=s.name+' ('+s.rollNumber+')';sel.appendChild(o);
  });
}

function loadSBill(){
  const id=parseInt(document.getElementById('bStu').value);
  if(!id){
    document.getElementById('bItems').style.display='none';
    document.getElementById('bPrevW').style.display='none';
    return;
  }
  
  const s=db.students.find(s=>s.id===id);if(!s)return;
  cb.student=s;cb.items=[{name:'Monthly Fee',price:s.monthlyFee}];
  document.getElementById('bItems').style.display='block';renBI();updBP();
}

function renBI(){
  document.getElementById('bItemList').innerHTML=cb.items.map((it,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 11px;background:var(--cream);border-radius:7px;margin-bottom:5px;border:1px solid var(--border)"><span style="font-size:.88rem;font-weight:500">${it.name}</span><div style="display:flex;align-items:center;gap:10px"><span style="font-family:'DM Mono',monospace;font-size:.88rem;font-weight:700">\u20b9${it.price.toFixed(2)}</span>${i>0?`<button class="btn btn-d btn-xs np" onclick="remBI(${i})">\u2715</button>`:''}</div></div>`).join('');
}

function addItem(){
  const n=document.getElementById('iName').value.trim(),a=parseFloat(document.getElementById('iAmt').value);
  if(!n||isNaN(a)||a<=0){toast('Enter valid name and amount','err');return;}
  cb.items.push({name:n,price:a});
  document.getElementById('iName').value='';document.getElementById('iAmt').value='';
  renBI();updBP();
}

function remBI(i){cb.items.splice(i,1);renBI();updBP();}

function updBP(){
  if(!cb.student)return;
  const s=cb.student,tot=cb.items.reduce((a,b)=>a+b.price,0);
  const mo=parseInt(document.getElementById('bMo').value),yr=document.getElementById('bYr').value;
  const td=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  const rno='REC-'+yr+'-'+String(mo).padStart(2,'0')+'-'+s.class+'-'+s.rollNumber;
  
  document.getElementById('bPrevW').style.display='block';
  document.getElementById('bPrev').innerHTML=`<div class="bpaper" id="pbill">
    <div class="bsn">Central Public School</div><div class="btag">Excellence in Education \u2014 Jamshedpur</div>
    <div class="brl">Fee Receipt</div>
    <div class="bmeta"><div class="bmr"><span>Receipt No.:</span><span>${rno}</span></div><div class="bmr"><span>Date:</span><span>${td}</span></div><div class="bmr"><span>Student:</span><span>${s.name}</span></div><div class="bmr"><span>Roll No.:</span><span>${s.rollNumber}</span></div><div class="bmr"><span>Class:</span><span>Class ${s.class}</span></div><div class="bmr"><span>Parent:</span><span>${s.parentName}</span></div><div class="bmr"><span>Phone:</span><span>${s.phoneNumber}</span></div><div class="bmr"><span>Period:</span><span>${MO[mo]} ${yr}</span></div></div>
    <table class="btbl"><thead><tr><th>#</th><th>Description</th><th style="text-align:right">Amount (\u20b9)</th></tr></thead><tbody>${cb.items.map((it,i)=>`<tr><td>${i+1}</td><td>${it.name}</td><td style="text-align:right;font-family:'DM Mono',monospace">${it.price.toFixed(2)}</td></tr>`).join('')}</tbody></table>
    <div class="btr"><div class="btb"><div><div class="tlbl">Total Amount</div></div><div class="tval">\u20b9${tot.toLocaleString('en-IN',{minimumFractionDigits:2})}</div></div></div>
    <div class="bft"><p>Thank you for your timely payment.</p><p>Central Public School \u2022 Session ${s.session}</p></div>
  </div>`;
}

function saveBill(){
  if(!cb.student){toast('Select a student first','err');return;}
  const s=cb.student,mo=parseInt(document.getElementById('bMo').value),yr=parseInt(document.getElementById('bYr').value),tot=cb.items.reduce((a,b)=>a+b.price,0);
  
  const existing=db.bills.find(b=>b.studentId===s.id&&b.month===mo&&b.year===yr);
  if(existing){
    existing.paid=true;
    existing.items=[...cb.items];
    existing.total=tot;
  }else{
    db.bills.push({
      id:Date.now(),
      studentId:s.id,
      studentName:s.name,
      studentClass:s.class,
      rollNumber:s.rollNumber,
      parentName:s.parentName,
      phone:s.phoneNumber,
      month:mo,
      year:yr,
      total:tot,
      items:[...cb.items],
      createdAt:Date.now(),
      session:s.session,
      paid:true
    });
  }
  
  sv();renderDash();renderQB();renderHist();
  toast('Saved & Marked PAID: '+s.name,'suc');
  printOnly();
}

function printOnly(){
  const b=document.getElementById('pbill');
  if(!b){toast('Generate bill first','err');return;}
  const pr=document.getElementById('pr');
  pr.innerHTML=b.outerHTML;
  pr.style.display='block';
  window.print();
  pr.style.display='none';
  pr.innerHTML='';
}

function sendSMS(){
  if(!cb.student){toast('Select a student first','err');return;}
  const s=cb.student,mo=parseInt(document.getElementById('bMo').value),yr=document.getElementById('bYr').value;
  const tot=cb.items.reduce((a,b)=>a+b.price,0);
  const msg=`Dear ${s.parentName}, Fee receipt for ${s.name} (Roll: ${s.rollNumber}, Class: ${s.class}) for ${MO[mo]} ${yr}. Amount: \u20b9${tot}. Thank you. - Central Public School`;
  
  toast('SMS message prepared for '+s.phoneNumber,'suc',4000);
  alert('SMS to: '+s.phoneNumber+'\n\n'+msg+'\n\n(In production, this would send via SMS gateway)');
}

function renderOv(){
  const mo=parseInt(document.getElementById('ovMo').value),yr=parseInt(document.getElementById('ovYr').value);
  const cls=document.getElementById('ovCls').value,roll=document.getElementById('ovRoll').value.trim();
  
  let ss=db.students.filter(s=>s.session===db.cur);
  if(cls)ss=ss.filter(s=>s.class===cls);
  if(roll)ss=ss.filter(s=>s.rollNumber===roll);
  
  const bills=db.bills.filter(b=>b.month===mo&&b.year===yr&&b.paid);
  const bids=bills.map(b=>b.studentId);
  const paid=ss.filter(s=>bids.includes(s.id));
  const upd=ss.filter(s=>!bids.includes(s.id));
  const col=bills.filter(b=>ss.find(s=>s.id===b.studentId)).reduce((a,b)=>a+b.total,0);
  
  document.getElementById('ovStats').innerHTML=`<div class="sbox"><div class="sic si-g">\u2713</div><div class="snum">${paid.length}</div><div class="slbl">Paid \u2014 ${MO[mo]}</div></div><div class="sbox"><div class="sic si-r">\u23f1</div><div class="snum">${upd.length}</div><div class="slbl">Unpaid</div></div><div class="sbox"><div class="sic si-gold">\ud83d\udcb0</div><div class="snum">\u20b9${col.toLocaleString('en-IN')}</div><div class="slbl">Collected</div></div>`;
  
  let h='<div class="sdiv">Paid ('+paid.length+')</div><div class="sgrid">';
  paid.forEach(s=>{
    const b=bills.find(b=>b.studentId===s.id);
    h+=`<div class="mbc"><div class="mbi">\u2713</div><div style="flex:1"><div class="mbn">${s.name} <span class="bdg bdg-c">Class ${s.class}</span> <span class="bdg bdg-paid">PAID</span></div><div class="mbs">Roll: ${s.rollNumber}</div></div><div class="mba">\u20b9${b.total.toLocaleString('en-IN')}</div><button class="btn btn-o btn-xs np" onclick="rePrint(${b.id})">\ud83d\udda8</button><button class="btn btn-i btn-xs np" onclick="sendBillSMS(${b.id})">\ud83d\udcf1</button></div>`;
  });
  h+='</div><div class="sdiv">Unpaid ('+upd.length+')</div><div class="sgrid">';
  upd.forEach(s=>{
    h+=`<div class="mbc"><div class="mbi">\u23f1</div><div style="flex:1"><div class="mbn">${s.name} <span class="bdg bdg-c">Class ${s.class}</span></div><div class="mbs">Roll: ${s.rollNumber} \u2022 \ud83d\udcf1 ${s.phoneNumber}</div></div><div class="mba" style="font-size:.9rem;color:var(--danger)">\u20b9${s.monthlyFee.toLocaleString('en-IN')}<div class="mbst" style="color:var(--danger)">DUE</div></div><button class="btn btn-g btn-xs np" onclick="qkBill(${s.id})">Bill</button></div>`;
  });
  h+='</div>';document.getElementById('ovList').innerHTML=h;
}

function renderHist(){
  const srch=(document.getElementById('hSrch')?.value||'').toLowerCase();
  const mo=parseInt(document.getElementById('hMo')?.value||'0');
  const cls=document.getElementById('hCls')?.value||'';
  
  let bills=[...db.bills].sort((a,b)=>b.createdAt-a.createdAt);
  if(mo)bills=bills.filter(b=>b.month===mo);
  if(cls)bills=bills.filter(b=>b.studentClass===cls);
  if(srch)bills=bills.filter(b=>b.studentName.toLowerCase().includes(srch)||b.rollNumber.toLowerCase().includes(srch));
  
  const c=document.getElementById('hList');
  if(!bills.length){c.innerHTML='<div class="empty"><div class="ei">\ud83d\udcc2</div><h4>No bills found</h4></div>';return;}
  
  c.innerHTML=bills.map(b=>`<div class="sc"><div class="av" style="background:linear-gradient(135deg,${b.paid?'var(--success)':'var(--danger)'},${b.paid?'#20c997':'#e74c3c'})">\u20b9</div><div class="sm"><h3>${b.studentName} <span class="bdg bdg-c">Class ${b.studentClass}</span> ${b.paid?'<span class="bdg bdg-paid">PAID</span>':''}</h3><div class="sub"><span>\ud83d\udd22 ${b.rollNumber}</span><span>\ud83d\udcc5 ${MO[b.month]} ${b.year}</span><span>\ud83d\udc6a ${b.parentName}</span></div><div style="margin-top:5px">${b.items.map(it=>`<span class="bdg" style="background:var(--cream);color:var(--text-mid);border:1px solid var(--border);margin:2px">${it.name}: \u20b9${it.price}</span>`).join('')}</div></div><div style="text-align:right;flex-shrink:0"><div style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:800;color:var(--navy)">\u20b9${b.total.toLocaleString('en-IN')}</div><div style="font-size:.72rem;color:var(--text-light)">${new Date(b.createdAt).toLocaleDateString('en-IN')}</div><div style="margin-top:7px;display:flex;gap:4px;justify-content:flex-end"><button class="btn btn-o btn-xs np" onclick="rePrint(${b.id})">\ud83d\udda8</button>${b.paid?`<button class="btn btn-i btn-xs np" onclick="sendBillSMS(${b.id})">\ud83d\udcf1</button>`:''}</div></div></div>`).join('');
}

function rePrint(bid){
  const b=db.bills.find(b=>b.id===bid);if(!b)return;
  const td=new Date().toLocaleDateString('en-IN',{day:'2-digit',month:'long',year:'numeric'});
  const rno='REC-'+b.year+'-'+String(b.month).padStart(2,'0')+'-'+b.studentClass+'-'+b.rollNumber;
  
  const pr=document.getElementById('pr');
  pr.innerHTML=`<div class="bpaper"><div class="bsn">Central Public School</div><div class="btag">Excellence in Education \u2014 Jamshedpur</div><div class="brl">Fee Receipt</div><div class="bmeta"><div class="bmr"><span>Receipt No.:</span><span>${rno}</span></div><div class="bmr"><span>Date:</span><span>${td}</span></div><div class="bmr"><span>Student:</span><span>${b.studentName}</span></div><div class="bmr"><span>Roll No.:</span><span>${b.rollNumber}</span></div><div class="bmr"><span>Class:</span><span>Class ${b.studentClass}</span></div><div class="bmr"><span>Parent:</span><span>${b.parentName}</span></div><div class="bmr"><span>Phone:</span><span>${b.phone}</span></div>    <div class="bmr"><span>Period:</span><span>${MO[b.month]} ${b.year}</span></div></div>
    <table class="btbl"><thead><tr><th>#</th><th>Description</th><th style="text-align:right">Amount ()</th></tr></thead><tbody>${b.items.map((it, i) => `<tr><td>${i + 1}</td><td>${it.name}</td><td style="text-align:right;font-family:'DM Mono',monospace">${it.price.toFixed(2)}</td></tr>`).join('')}</tbody></table>
    <div class="btr"><div class="btb"><div><div class="tlbl">Total Amount</div></div><div class="tval">${b.total.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</div></div></div>
    <div class="bft"><p>Thank you for your payment.</p><p>Central Public School  Session ${b.session}</p></div>
  </div>`;
  pr.style.display = 'block';
  window.print();
  pr.style.display = 'none';
  pr.innerHTML = '';
}

function sendBillSMS(bid) {
  const b = db.bills.find(x => x.id === bid);
  if (!b) return;
  const msg = `Dear Parent, fee of ${b.total} for ${b.studentName} for ${MO[b.month]} ${b.year} has been received. Thank you! - CPS`;
  alert("SMS Sent to " + b.phone + ":\n\n" + msg);
}

function renderQB() {
  const m = parseInt(document.getElementById('qbM').value);
  const list = db.bills.filter(b => (!m || b.month === m) && b.paid).sort((a, b) => b.createdAt - a.createdAt).slice(0, 8);
  const c = document.getElementById('qbList');
  if (!list.length) { c.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-light);font-size:.8rem">No recent payments</p>'; return; }
  c.innerHTML = list.map(b => `<div class="qbi"><div class="qbd"></div><div><div class="qbn">${b.studentName}</div><div class="qbs">${MO[b.month]}  Class ${b.studentClass}</div></div><div class="qbam" style="margin-left:auto">${b.total}</div></div>`).join('');
}

function sendNotice() {
  const t = document.getElementById('notTitle').value.trim();
  const m = document.getElementById('notMsg').value.trim();
  if (!t || !m) { toast('Enter title and message', 'err'); return; }
  db.notices.unshift({ id: Date.now(), title: t, msg: m, date: new Date().toLocaleDateString('en-IN'), target: document.getElementById('notType').value });
  sv(); renderNotices();
  document.getElementById('notTitle').value = ''; document.getElementById('notMsg').value = '';
  toast('Notice broadcasted successfully', 'suc');
}

function renderNotices() {
  const c = document.getElementById('noticeList');
  if (!db.notices.length) { c.innerHTML = '<div class="empty"><div class="ei"></div><p>No notices sent yet</p></div>'; return; }
  c.innerHTML = db.notices.map(n => `<div class="notice-card"><div class="notice-header"><div class="notice-title">${n.title}</div><div class="notice-date">${n.date}</div></div><div class="notice-msg">${n.msg}</div><div class="notice-rcpt">To: ${n.target.toUpperCase()}</div></div>`).join('');
}

function showSessUpgrade() {
  document.getElementById('sessMB').innerHTML = `
    <div style="padding:10px 0">
      <p style="font-size:.88rem;color:var(--text-mid);margin-bottom:15px">Enter the new academic session name (e.g., 2027-28). This will set the default for new registrations.</p>
      <div class="fg"><label>New Session Name</label><input type="text" id="newSessName" placeholder="2027-28"></div>
      <button class="btn btn-p" style="width:100%;justify-content:center" onclick="confirmSessUp()">Create New Session</button>
    </div>`;
  opM('sessM');
}

function confirmSessUp() {
  const v = document.getElementById('newSessName').value.trim();
  if (!v) return;
  db.cur = v; sv();
  document.getElementById('sessTag').textContent = 'Session ' + v;
  clsM('sessM'); toast('Session updated to ' + v, 'suc');
}

function renderSess() {
  const c = document.getElementById('sessList');
  const counts = db.students.reduce((acc, s) => { acc[s.session] = (acc[s.session] || 0) + 1; return acc; }, {});
  const sessions = [...new Set([db.cur, ...Object.keys(counts)])].sort().reverse();
  c.innerHTML = sessions.map(s => `<div class="sc"><div class="av">S</div><div class="sm"><h3>Session ${s} ${s === db.cur ? '<span class="bdg bdg-paid">ACTIVE</span>' : ''}</h3><div class="sub"><span>${counts[s] || 0} Students registered</span></div></div></div>`).join('');
}
</script>
</body>
</html>
