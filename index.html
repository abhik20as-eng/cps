<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Central Public School â€” Management System</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;900&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#1a1a2e;--deep:#16213e;--royal:#0f3460;
  --gold:#e8b84b;--gold-light:#f5d98b;--gold-dim:rgba(232,184,75,0.15);
  --white:#fff;--cream:#fdf6e3;
  --ok:#2ecc71;--err:#e74c3c;--warn:#f39c12;--info:#3498db;
  --border:rgba(232,184,75,0.18);--card:rgba(255,255,255,0.04);
  --muted:rgba(255,255,255,0.45);--radius:12px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--ink);color:var(--white);min-height:100vh;
  background-image:radial-gradient(ellipse at 15% 50%,rgba(15,52,96,.55) 0%,transparent 60%),
                   radial-gradient(ellipse at 85% 15%,rgba(232,184,75,.07) 0%,transparent 50%)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--deep)}
::-webkit-scrollbar-thumb{background:var(--gold);border-radius:3px}

/* â”€â”€ HEADER â”€â”€ */
.hdr{background:linear-gradient(135deg,var(--deep),var(--royal));border-bottom:1px solid var(--border);
  padding:0 32px;display:flex;align-items:center;justify-content:space-between;gap:16px;
  position:sticky;top:0;z-index:100;box-shadow:0 4px 30px rgba(0,0,0,.35)}
.hdr-logo{display:flex;align-items:center;gap:14px;padding:12px 0}
.hdr-icon{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#c9952e);
  display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;
  box-shadow:0 0 18px rgba(232,184,75,.4)}
.hdr-title h1{font-family:'Playfair Display',serif;font-size:1.35em;color:var(--gold);line-height:1.2}
.hdr-title p{font-size:.73em;color:var(--muted);letter-spacing:.05em}
.session-pill{background:rgba(232,184,75,.12);border:1px solid var(--gold);color:var(--gold);
  padding:5px 14px;border-radius:20px;font-size:.78em;font-weight:600;
  display:flex;align-items:center;gap:7px}
.dot{width:8px;height:8px;background:var(--ok);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}

/* â”€â”€ TABS â”€â”€ */
.nav-tabs{display:flex;background:var(--deep);border-bottom:1px solid var(--border);
  overflow-x:auto;padding:0 20px;gap:2px}
.ntab{padding:13px 20px;background:none;border:none;color:var(--muted);
  font-family:'DM Sans',sans-serif;font-size:.88em;font-weight:500;cursor:pointer;
  border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;
  display:flex;align-items:center;gap:7px}
.ntab:hover{color:var(--white)}
.ntab.active{color:var(--gold);border-bottom-color:var(--gold)}

/* â”€â”€ LAYOUT â”€â”€ */
.main{max-width:1380px;margin:0 auto;padding:28px 22px}
.panel{display:none;animation:fadeUp .3s ease}
.panel.active{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ TYPOGRAPHY â”€â”€ */
.sec-title{font-family:'Playfair Display',serif;font-size:1.75em;color:var(--white);
  margin-bottom:6px;display:flex;align-items:center;gap:11px}
.sec-sub{color:var(--muted);font-size:.88em;margin-bottom:26px}

/* â”€â”€ CARD â”€â”€ */
.card{background:linear-gradient(135deg,rgba(22,33,62,.92),rgba(15,52,96,.38));
  border:1px solid var(--border);border-radius:var(--radius);padding:26px;backdrop-filter:blur(8px)}

/* â”€â”€ GRID â”€â”€ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:15px}
@media(max-width:900px){.g2,.g3,.g4{grid-template-columns:1fr}}
@media(max-width:1100px){.g4{grid-template-columns:1fr 1fr}.g3{grid-template-columns:1fr 1fr}}

/* â”€â”€ FORMS â”€â”€ */
.fg{margin-bottom:17px}
.fg label{display:block;margin-bottom:5px;font-size:.8em;font-weight:600;
  color:var(--gold-light);letter-spacing:.05em;text-transform:uppercase}
.fc{width:100%;padding:11px 15px;background:rgba(255,255,255,.07);
  border:1px solid rgba(255,255,255,.11);border-radius:8px;
  color:var(--white);font-family:'DM Sans',sans-serif;font-size:.93em;transition:all .2s}
.fc:focus{outline:none;border-color:var(--gold);background:rgba(232,184,75,.08);
  box-shadow:0 0 0 3px rgba(232,184,75,.1)}
.fc option{background:var(--deep);color:var(--white)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:15px}
@media(max-width:680px){.frow{grid-template-columns:1fr}}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:10px 21px;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;
  font-size:.88em;font-weight:600;cursor:pointer;transition:all .2s;
  display:inline-flex;align-items:center;gap:7px;letter-spacing:.02em}
.btn-gold{background:linear-gradient(135deg,var(--gold),#c9952e);color:var(--ink)}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(232,184,75,.4)}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--white)}
.btn-ghost:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.22)}
.btn-ok{background:var(--ok);color:#fff}.btn-err{background:var(--err);color:#fff}
.btn-info{background:var(--info);color:#fff}
.btn-sm{padding:6px 13px;font-size:.79em}
.brow{display:flex;gap:9px;flex-wrap:wrap;margin-top:18px}

/* â”€â”€ STAT CARDS â”€â”€ */
.sc{background:linear-gradient(135deg,rgba(22,33,62,.95),rgba(15,52,96,.6));
  border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.sc.gold{border-color:rgba(232,184,75,.45);background:linear-gradient(135deg,rgba(232,184,75,.13),rgba(201,149,46,.06))}
.sc.green{border-color:rgba(46,204,113,.38);background:linear-gradient(135deg,rgba(46,204,113,.1),rgba(46,204,113,.04))}
.sc.red{border-color:rgba(231,76,60,.38);background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(231,76,60,.04))}
.sc.blue{border-color:rgba(52,152,219,.38);background:linear-gradient(135deg,rgba(52,152,219,.1),rgba(52,152,219,.04))}
.sc-num{font-family:'Playfair Display',serif;font-size:2.3em;font-weight:700;color:var(--white)}
.sc-lbl{font-size:.79em;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-top:4px}

/* â”€â”€ STUDENT CARD â”€â”€ */
.stud-card{background:rgba(255,255,255,.04);border:1px solid var(--border);
  border-radius:var(--radius);padding:16px 20px;
  display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;
  transition:all .2s;margin-bottom:9px}
.stud-card:hover{background:rgba(232,184,75,.06);border-color:rgba(232,184,75,.3)}
.stud-av{width:44px;height:44px;border-radius:50%;
  background:linear-gradient(135deg,var(--gold),#c9952e);
  display:flex;align-items:center;justify-content:center;
  font-family:'Playfair Display',serif;font-size:1.15em;color:var(--ink);font-weight:700;flex-shrink:0}
.stud-meta{flex:1;min-width:190px}
.stud-meta h3{font-size:.97em;font-weight:600;color:var(--white);margin-bottom:3px}
.stud-meta p{font-size:.78em;color:var(--muted)}
.ab{padding:3px 10px;border-radius:20px;font-size:.73em;font-weight:600;
  background:rgba(46,204,113,.14);color:var(--ok);border:1px solid rgba(46,204,113,.3)}
.ab.low{background:rgba(231,76,60,.14);color:var(--err);border-color:rgba(231,76,60,.3)}

/* â”€â”€ MODAL â”€â”€ */
.moverlay{position:fixed;inset:0;background:rgba(0,0,0,.86);
  display:none;align-items:center;justify-content:center;
  z-index:9000;padding:20px;backdrop-filter:blur(5px)}
.moverlay.open{display:flex}
.mbox{background:linear-gradient(135deg,#1a1a2e,#16213e);
  border:1px solid var(--border);border-radius:16px;
  max-width:660px;width:100%;max-height:92vh;overflow-y:auto;
  box-shadow:0 24px 60px rgba(0,0,0,.5);animation:mIn .28s ease}
@keyframes mIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.mhead{padding:22px 26px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between}
.mhead h2{font-family:'Playfair Display',serif;font-size:1.35em;color:var(--gold)}
.mclose{width:31px;height:31px;border:none;background:rgba(255,255,255,.1);
  color:var(--white);border-radius:50%;cursor:pointer;font-size:1em;
  display:flex;align-items:center;justify-content:center;transition:background .2s}
.mclose:hover{background:var(--err)}
.mbody{padding:22px 26px}

/* â”€â”€ QR â”€â”€ */
.qr-wrap{display:flex;flex-direction:column;align-items:center;gap:14px;
  background:var(--white);border-radius:12px;padding:22px;margin:10px 0}
.qr-info{background:rgba(232,184,75,.08);border:1px solid var(--border);
  border-radius:8px;padding:11px 15px;font-size:.83em;
  color:var(--gold-light);word-break:break-all;font-family:monospace;margin-top:8px}

/* â”€â”€ CHAT BILL â”€â”€ */
.chatbox{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.chat-msgs{height:220px;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:9px}
.msg{padding:9px 13px;border-radius:8px;font-size:.86em;max-width:82%}
.msg-u{background:var(--gold);color:var(--ink);align-self:flex-end;font-weight:500}
.msg-b{background:rgba(255,255,255,.08);border:1px solid var(--border)}
.chat-foot{display:flex;gap:9px;padding:11px;border-top:1px solid var(--border)}
.chat-foot input{flex:1}

/* â”€â”€ BILL PRINT â”€â”€ */
.bill-print{background:#fff;color:#1a1a2e;border-radius:12px;padding:30px;margin-top:18px;
  font-family:'DM Sans',sans-serif;border:2px solid rgba(232,184,75,.35)}
.bp-head{text-align:center;border-bottom:3px double #1a1a2e;padding-bottom:18px;margin-bottom:18px}
.bp-head h2{font-family:'Playfair Display',serif;font-size:1.75em;color:#1a1a2e}
.bp-head p{font-size:.83em;color:#666}
.bp-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #eee}
.bp-total{display:flex;justify-content:space-between;font-size:1.25em;font-weight:700;
  padding:15px 0;border-top:3px double #1a1a2e;margin-top:7px}
.bp-foot{text-align:center;margin-top:18px;font-size:.78em;color:#999}

/* â”€â”€ ATTENDANCE â”€â”€ */
.att-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(215px,1fr));gap:11px;margin-top:14px}
.att-card{background:rgba(46,204,113,.07);border:1px solid rgba(46,204,113,.22);border-radius:10px;padding:13px}
.att-card.absent{background:rgba(231,76,60,.07);border-color:rgba(231,76,60,.22)}
.att-card h4{font-size:.88em;margin-bottom:4px;color:var(--white)}
.att-card p{font-size:.77em;color:var(--muted)}

/* â”€â”€ BILL HISTORY PANEL â”€â”€ */
.bh-panel{position:fixed;right:-430px;top:0;bottom:0;width:420px;
  background:linear-gradient(160deg,#1a1a2e,#0f3460);
  border-left:1px solid var(--border);z-index:200;
  transition:right .35s cubic-bezier(.4,0,.2,1);
  display:flex;flex-direction:column;box-shadow:-12px 0 40px rgba(0,0,0,.5)}
.bh-panel.open{right:0}
.bh-head{padding:18px 22px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.2)}
.bh-head h2{font-family:'Playfair Display',serif;font-size:1.2em;color:var(--gold)}
.bh-x{background:none;border:none;color:var(--muted);font-size:1.3em;cursor:pointer}
.bh-x:hover{color:var(--white)}
.bh-filters{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;gap:9px;flex-wrap:wrap}
.bh-content{flex:1;overflow-y:auto;padding:14px 18px}
.bh-month{margin-bottom:18px}
.bh-month-lbl{font-size:.77em;text-transform:uppercase;letter-spacing:.1em;
  color:var(--gold);font-weight:700;margin-bottom:9px;padding-bottom:5px;border-bottom:1px solid var(--border)}
.bh-bc{background:rgba(255,255,255,.05);border:1px solid var(--border);
  border-radius:8px;padding:11px 13px;margin-bottom:7px;
  display:flex;justify-content:space-between;align-items:flex-start;gap:9px}
.bh-bc.paid{border-left:3px solid var(--ok)}
.bh-bi h4{font-size:.88em;color:var(--white);margin-bottom:2px}
.bh-bi p{font-size:.76em;color:var(--muted)}
.bh-date{font-size:.7em;color:var(--muted);margin-top:2px}
.bh-prbtn{background:rgba(232,184,75,.14);border:1px solid rgba(232,184,75,.28);
  color:var(--gold);border-radius:5px;padding:3px 9px;font-size:.73em;cursor:pointer;margin-top:5px}
.bh-prbtn:hover{background:rgba(232,184,75,.28)}
.bh-sum{padding:14px 18px;border-top:1px solid var(--border);background:rgba(0,0,0,.2)}
.bh-sr{display:flex;justify-content:space-between;font-size:.83em;margin-bottom:5px}
.bh-st{display:flex;justify-content:space-between;font-weight:700;font-size:1.03em;
  color:var(--gold);padding-top:7px;border-top:1px solid var(--border)}
.bh-btn{position:fixed;right:22px;top:50%;transform:translateY(-50%);z-index:199;
  background:linear-gradient(135deg,var(--gold),#c9952e);color:var(--ink);border:none;
  width:50px;height:50px;border-radius:50%;font-size:1.4em;cursor:pointer;
  box-shadow:0 8px 24px rgba(232,184,75,.42);display:flex;align-items:center;justify-content:center;
  transition:all .2s}
.bh-btn:hover{transform:translateY(-50%) scale(1.1)}
.bh-btn.open{right:442px}

/* â”€â”€ SCANNER â”€â”€ */
.scan-wrap{background:rgba(0,0,0,.3);border:2px dashed var(--border);
  border-radius:16px;padding:38px;text-align:center;margin-bottom:22px}
.scan-in{font-size:1.3em;width:100%;max-width:380px;margin:14px auto;display:block;
  background:rgba(255,255,255,.06);border:2px solid var(--gold);
  border-radius:10px;padding:13px 18px;color:var(--white);
  font-family:'DM Sans',sans-serif;text-align:center;letter-spacing:.08em}
.scan-in:focus{outline:none;box-shadow:0 0 0 3px rgba(232,184,75,.22)}

/* â”€â”€ MONEY TABLE â”€â”€ */
.mt{width:100%;border-collapse:collapse;margin-top:15px}
.mt th{padding:9px 15px;background:rgba(232,184,75,.1);text-align:left;
  font-size:.8em;color:var(--gold);letter-spacing:.06em;text-transform:uppercase}
.mt td{padding:9px 15px;border-bottom:1px solid var(--border);font-size:.86em;color:var(--white)}
.mt tr:hover td{background:rgba(255,255,255,.03)}
.mt .tr-tot td{font-weight:700;color:var(--gold);border-top:2px solid var(--border)}

/* â”€â”€ CHECKLIST â”€â”€ */
.checklist{background:rgba(0,0,0,.2);border:1px solid var(--border);
  border-radius:8px;max-height:290px;overflow-y:auto;padding:9px}
.ci{display:flex;align-items:center;gap:9px;padding:8px 11px;border-radius:6px;cursor:pointer;
  transition:background .15s;font-size:.87em}
.ci:hover{background:rgba(255,255,255,.06)}
.ci input{accent-color:var(--gold);width:15px;height:15px}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(90px);
  background:var(--deep);border:1px solid var(--gold);color:var(--white);
  padding:11px 22px;border-radius:50px;font-size:.88em;font-weight:500;
  z-index:9999;transition:transform .3s ease;box-shadow:0 8px 28px rgba(0,0,0,.5);
  display:flex;align-items:center;gap:9px;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}

@media print{
  body{background:#fff!important;color:#000!important}
  .hdr,.nav-tabs,.main>*:not(#billPrintTarget),.bh-panel,.bh-btn,.toast,
  .moverlay,.brow,.chat-foot,.ntab{display:none!important}
  #billPrintTarget{display:block!important;position:fixed;inset:0;background:#fff;z-index:9999;padding:30px}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="hdr-logo">
    <div class="hdr-icon">ğŸ“</div>
    <div class="hdr-title">
      <h1>Central Public School</h1>
      <p>Student & Attendance Management System</p>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <div class="session-pill"><span class="dot"></span>Session: <span id="hdrSess">2025â€“26</span></div>
    <span style="font-size:.78em;color:var(--muted)" id="hdrDate"></span>
  </div>
</header>

<!-- NAV -->
<nav class="nav-tabs">
  <button class="ntab active" onclick="switchTab('register',this)">ğŸ“ Register</button>
  <button class="ntab" onclick="switchTab('students',this)">ğŸ‘¥ Students</button>
  <button class="ntab" onclick="switchTab('billing',this)">ğŸ’° Billing</button>
  <button class="ntab" onclick="switchTab('attendance',this)">âœ… Attendance</button>
  <button class="ntab" onclick="switchTab('reports',this)">ğŸ“Š Reports</button>
  <button class="ntab" onclick="switchTab('sessions',this)">ğŸ—‚ï¸ Sessions</button>
</nav>

<main class="main">

<!-- â•â• REGISTER â•â• -->
<div id="tab-register" class="panel active">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:6px">
    <h2 class="sec-title">ğŸ“ Register New Student</h2>
    <span style="font-size:.83em;color:var(--muted)">Session: <strong style="color:var(--gold)" id="regSess">2025â€“26</strong></span>
  </div>
  <p class="sec-sub">Add a new student to the current academic session</p>
  <div class="card">
    <form id="regForm" onsubmit="registerStudent(event)">
      <div class="frow">
        <div class="fg"><label>Student Name *</label><input type="text" id="sName" class="fc" required placeholder="Full name"></div>
        <div class="fg"><label>Roll Number *</label><input type="text" id="sRoll" class="fc" required placeholder="e.g. A001"></div>
      </div>
      <div class="frow">
        <div class="fg"><label>Date of Birth *</label><input type="date" id="sDob" class="fc" required></div>
        <div class="fg"><label>Class *</label>
          <select id="sClass" class="fc" required><option value="">Select Class</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option>11</option><option>12</option></select></div>
      </div>
      <div class="frow">
        <div class="fg"><label>Parent's Name *</label><input type="text" id="sParent" class="fc" required></div>
        <div class="fg"><label>Phone Number *</label><input type="tel" id="sPhone" class="fc" pattern="[0-9]{10}" placeholder="10-digit mobile" required></div>
      </div>
      <div class="frow">
        <div class="fg"><label>Date of Joining *</label><input type="date" id="sJoin" class="fc" required></div>
        <div class="fg"><label>Monthly Fee (â‚¹) *</label><input type="number" id="sFee" class="fc" required placeholder="0"></div>
      </div>
      <div class="brow">
        <button type="submit" class="btn btn-gold">âœ“ Register Student</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('regForm').reset()">âœ• Clear</button>
      </div>
    </form>
  </div>
</div>

<!-- â•â• STUDENTS â•â• -->
<div id="tab-students" class="panel">
  <h2 class="sec-title">ğŸ‘¥ Students</h2>
  <p class="sec-sub">All students in the current session</p>
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:18px">
    <div style="flex:1;min-width:150px">
      <label style="font-size:.78em;color:var(--muted);display:block;margin-bottom:5px">Filter by Class</label>
      <select id="filterClass" class="fc" onchange="displayStudents()">
        <option value="">All Classes</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        <option>11</option><option>12</option>
      </select>
    </div>
    <button class="btn btn-gold" onclick="genAllQR()">ğŸ”² All QR Codes</button>
    <button class="btn btn-ghost" onclick="showBulkSMS()">ğŸ“± Bulk SMS</button>
    <button class="btn btn-ghost" onclick="showSelSMS()">ğŸ“© Selective SMS</button>
  </div>
  <div id="studentsList"></div>
</div>

<!-- â•â• BILLING â•â• -->
<div id="tab-billing" class="panel">
  <h2 class="sec-title">ğŸ’° Billing</h2>
  <p class="sec-sub">Generate and print fee receipts</p>
  <div class="card" style="margin-bottom:18px">
    <div class="frow">
      <div class="fg"><label>Class</label>
        <select id="billClass" class="fc" onchange="loadBillStudents()">
          <option value="">Choose class</option>
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          <option>11</option><option>12</option>
        </select></div>
      <div class="fg"><label>Student</label>
        <select id="billStudent" class="fc" onchange="startBill()"><option value="">Choose student</option></select></div>
    </div>
    <div class="fg"><label>Month</label>
      <select id="billMonth" class="fc">
        <option>April</option><option>May</option><option>June</option><option>July</option>
        <option>August</option><option>September</option><option>October</option><option>November</option>
        <option>December</option><option>January</option><option>February</option><option>March</option>
      </select></div>
  </div>
  <div class="chatbox">
    <div class="chat-msgs" id="chatMsgs"><div class="msg msg-b" style="color:var(--muted)">Select a student to start the bill...</div></div>
    <div class="chat-foot">
      <input type="text" id="chatIn" class="fc" placeholder='Item + price e.g. "Books 500"'>
      <button class="btn btn-gold btn-sm" onclick="addItem()">ï¼‹ Add</button>
    </div>
  </div>
  <div id="billPreview"></div>
  <div class="brow" style="justify-content:center">
    <button class="btn btn-gold" onclick="printBill()">ğŸ–¨ï¸ Print</button>
    <button class="btn btn-ok" onclick="saveBill()">ğŸ’¾ Save</button>
    <button class="btn btn-ghost" onclick="clearBill()">âœ• Clear</button>
  </div>
</div>

<!-- â•â• ATTENDANCE â•â• -->
<div id="tab-attendance" class="panel">
  <h2 class="sec-title">âœ… Attendance</h2>
  <p class="sec-sub">Mark attendance via QR scan or manual entry</p>
  <div class="scan-wrap">
    <div style="font-size:2.8em;margin-bottom:10px">ğŸ“±</div>
    <h3 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:7px">QR / Manual Entry</h3>
    <p style="color:var(--muted);font-size:.88em">Scan QR code with any reader app, or type roll number here</p>
    <input type="text" id="scanIn" class="scan-in" placeholder="Roll Number"
      onkeydown="if(event.key==='Enter')markAtt()">
    <div style="margin-top:10px">
      <button class="btn btn-gold" onclick="markAtt()">Mark Present âœ“</button>
    </div>
    <div id="attMsg" style="margin-top:18px;font-size:.95em"></div>
  </div>
  <div class="card">
    <h3 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:14px">Today's Attendance</h3>
    <div id="todayAtt"><p style="color:var(--muted);font-size:.88em;text-align:center;padding:20px">Loading...</p></div>
  </div>
</div>

<!-- â•â• REPORTS â•â• -->
<div id="tab-reports" class="panel">
  <h2 class="sec-title">ğŸ“Š Reports</h2>
  <p class="sec-sub">Attendance and fee collection analytics</p>
  <div style="display:flex;gap:8px;margin-bottom:22px;flex-wrap:wrap">
    <button class="btn btn-gold btn-sm" id="rpt-att-btn" onclick="showRpt('att')">ğŸ“… Attendance</button>
    <button class="btn btn-ghost btn-sm" id="rpt-coll-btn" onclick="showRpt('coll')">ğŸ’µ Fee Collection</button>
  </div>
  <div id="rpt-att">
    <div class="card" style="margin-bottom:18px">
      <div class="frow">
        <div class="fg"><label>Date</label><input type="date" id="rptDate" class="fc" onchange="genRpt()"></div>
        <div class="fg"><label>Class</label>
          <select id="rptClass" class="fc" onchange="genRpt()">
            <option value="">All Classes</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option>11</option><option>12</option>
          </select></div>
      </div>
    </div>
    <div class="g4" id="rptStats" style="margin-bottom:18px"></div>
    <div id="rptContent"></div>
  </div>
  <div id="rpt-coll" style="display:none">
    <div class="card" style="margin-bottom:18px">
      <div class="frow">
        <div class="fg"><label>Month</label>
          <select id="collMonth" class="fc" onchange="genColl()">
            <option value="">All Months</option>
            <option>April</option><option>May</option><option>June</option><option>July</option>
            <option>August</option><option>September</option><option>October</option><option>November</option>
            <option>December</option><option>January</option><option>February</option><option>March</option>
          </select></div>
        <div class="fg"><label>Class</label>
          <select id="collClass" class="fc" onchange="genColl()">
            <option value="">All Classes</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
            <option>11</option><option>12</option>
          </select></div>
      </div>
    </div>
    <div class="g4" id="collStats" style="margin-bottom:18px"></div>
    <div id="collContent"></div>
  </div>
</div>

<!-- â•â• SESSIONS â•â• -->
<div id="tab-sessions" class="panel">
  <h2 class="sec-title">ğŸ—‚ï¸ Session Management</h2>
  <p class="sec-sub">Manage academic years and archived data</p>
  <div class="card" style="margin-bottom:20px">
    <h3 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:14px">Switch / Create Session</h3>
    <div class="frow">
      <div class="fg"><label>Active Session</label>
        <select id="sesSel" class="fc" onchange="switchSession()"></select></div>
      <div class="fg"><label>New Session</label>
        <input type="text" id="newSessIn" class="fc" placeholder="e.g. 2027-28"></div>
    </div>
    <div class="brow">
      <button class="btn btn-gold" onclick="createSession()">ğŸ†• Create Session</button>
    </div>
  </div>
  <div class="card">
    <h3 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:14px">All Sessions</h3>
    <div id="sessList"></div>
  </div>
</div>

</main>

<!-- BILL HISTORY TOGGLE -->
<button class="bh-btn" id="bhBtn" onclick="toggleBH()" title="Bill History &amp; Records">ğŸ’³</button>

<!-- BILL HISTORY PANEL -->
<aside class="bh-panel" id="bhPanel">
  <div class="bh-head">
    <h2>ğŸ’³ Bill Records</h2>
    <button class="bh-x" onclick="toggleBH()">âœ•</button>
  </div>
  <div class="bh-filters">
    <select id="bhClass" class="fc" style="flex:1;min-width:90px;font-size:.82em" onchange="renderBH()">
      <option value="">All Classes</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
      <option>11</option><option>12</option>
    </select>
    <select id="bhMon" class="fc" style="flex:1;min-width:90px;font-size:.82em" onchange="renderBH()">
      <option value="">All Months</option>
      <option>April</option><option>May</option><option>June</option><option>July</option>
      <option>August</option><option>September</option><option>October</option><option>November</option>
      <option>December</option><option>January</option><option>February</option><option>March</option>
    </select>
  </div>
  <div class="bh-content" id="bhContent"></div>
  <div class="bh-sum" id="bhSum"></div>
</aside>

<!-- MODALS -->
<div class="moverlay" id="qrModal"><div class="mbox">
  <div class="mhead"><h2 id="qrMTitle">QR Code</h2><button class="mclose" onclick="closeM('qrModal')">âœ•</button></div>
  <div class="mbody" id="qrMBody"></div>
</div></div>

<div class="moverlay" id="smsModal"><div class="mbox">
  <div class="mhead"><h2>ğŸ“± SMS</h2><button class="mclose" onclick="closeM('smsModal')">âœ•</button></div>
  <div class="mbody" id="smsMBody"></div>
</div></div>

<!-- PRINT TARGET -->
<div id="billPrintTarget" style="display:none"></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const MONTHS=['April','May','June','July','August','September','October','November','December','January','February','March'];
const BASE_URL=window.location.href.split('?')[0];
let currentSession=localStorage.getItem('CPS_session')||'2025-26';
let allSessions=JSON.parse(localStorage.getItem('CPS_allSessions')||'["2025-26"]');
let students=[],attendance={},bills=[];
let cb={student:null,items:[]};

// â”€â”€ data helpers â”€â”€
function sk(k){return `CPS_${currentSession}_${k}`}
function load(){
  students=JSON.parse(localStorage.getItem(sk('students'))||'[]');
  attendance=JSON.parse(localStorage.getItem(sk('attendance'))||'{}');
  bills=JSON.parse(localStorage.getItem(sk('bills'))||'[]');
}
function save(k,v){localStorage.setItem(sk(k),JSON.stringify(v))}
load();

// â”€â”€ init UI â”€â”€
const NOW=new Date();
const TODAY=NOW.toISOString().split('T')[0];
document.getElementById('hdrDate').textContent=NOW.toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'});
document.getElementById('hdrSess').textContent=currentSession.replace('-','â€“');
document.getElementById('regSess').textContent=currentSession.replace('-','â€“');
if(document.getElementById('sJoin'))document.getElementById('sJoin').value=TODAY;
if(document.getElementById('rptDate'))document.getElementById('rptDate').value=TODAY;
// Set current month
const CM=NOW.toLocaleString('en-IN',{month:'long'});
const bms=document.getElementById('billMonth');
if(bms){[...bms.options].forEach(o=>{if(o.value===CM)o.selected=true;})}
// Init sessions selector
initSessSel();

// â”€â”€ QR attendance from URL â”€â”€
(()=>{const p=new URLSearchParams(window.location.search);const r=p.get('attendance');if(r)setTimeout(()=>qrMarkAtt(r),500)})();

// â•â• TOAST â•â•
function toast(msg,dur=2700){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}

// â•â• TABS â•â•
function switchTab(id,btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ntab').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  if(id==='students')displayStudents();
  if(id==='reports'){if(document.getElementById('rptDate').value===''||!document.getElementById('rptDate').value)document.getElementById('rptDate').value=TODAY;genRpt();}
  if(id==='attendance')renderTodayAtt();
  if(id==='sessions')renderSessions();
}

// â•â• SESSIONS â•â•
function initSessSel(){
  const sel=document.getElementById('sesSel');
  if(!sel)return;
  sel.innerHTML='';
  allSessions.forEach(s=>{const o=new Option(s.replace('-','â€“'),s);sel.appendChild(o);});
  sel.value=currentSession;
}
function switchSession(){
  currentSession=document.getElementById('sesSel').value;
  localStorage.setItem('CPS_session',currentSession);
  load();
  document.getElementById('hdrSess').textContent=currentSession.replace('-','â€“');
  document.getElementById('regSess').textContent=currentSession.replace('-','â€“');
  displayStudents();renderBH();
  toast('âœ… Session '+currentSession.replace('-','â€“'));
}
function createSession(){
  const v=document.getElementById('newSessIn').value.trim();
  if(!v||!/^\d{4}-\d{2,4}$/.test(v)){toast('âš ï¸ Format: YYYY-YY e.g. 2027-28');return;}
  if(!allSessions.includes(v)){allSessions.push(v);localStorage.setItem('CPS_allSessions',JSON.stringify(allSessions));}
  initSessSel();
  document.getElementById('sesSel').value=v;
  currentSession=v;localStorage.setItem('CPS_session',v);
  load();
  document.getElementById('hdrSess').textContent=v.replace('-','â€“');
  document.getElementById('regSess').textContent=v.replace('-','â€“');
  document.getElementById('newSessIn').value='';
  toast('ğŸ‰ Session '+v.replace('-','â€“')+' created!');
  renderSessions();
}
function renderSessions(){
  const c=document.getElementById('sessList');if(!c)return;
  c.innerHTML=allSessions.map(s=>{
    const ss=JSON.parse(localStorage.getItem(`CPS_${s}_students`)||'[]');
    const sb=JSON.parse(localStorage.getItem(`CPS_${s}_bills`)||'[]');
    const act=s===currentSession;
    return`<div style="display:flex;align-items:center;justify-content:space-between;padding:13px;
      background:${act?'rgba(232,184,75,.1)':'rgba(255,255,255,.04)'};
      border:1px solid ${act?'rgba(232,184,75,.4)':'var(--border)'};
      border-radius:8px;margin-bottom:8px;flex-wrap:wrap;gap:9px">
      <div>
        <strong style="color:${act?'var(--gold)':'var(--white)'}">${s.replace('-','â€“')}${act?' <span style="font-size:.72em;background:var(--gold);color:var(--ink);padding:2px 8px;border-radius:20px">Active</span>':''}</strong>
        <p style="font-size:.78em;color:var(--muted);margin-top:3px">${ss.length} students Â· ${sb.length} bills Â· â‚¹${sb.reduce((a,b)=>a+b.total,0).toFixed(0)} collected</p>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('sesSel').value='${s}';switchSession()">Switch â†’</button>
    </div>`;
  }).join('');
}

// â•â• REGISTER â•â•
function registerStudent(e){
  e.preventDefault();
  const roll=document.getElementById('sRoll').value.trim();
  if(students.find(s=>s.rollNumber===roll)){toast('âš ï¸ Roll number already exists!');return;}
  const st={
    id:Date.now(),
    name:document.getElementById('sName').value.trim(),
    rollNumber:roll,
    dob:document.getElementById('sDob').value,
    class:document.getElementById('sClass').value,
    parentName:document.getElementById('sParent').value.trim(),
    phoneNumber:document.getElementById('sPhone').value.trim(),
    joiningDate:document.getElementById('sJoin').value,
    monthlyFee:parseFloat(document.getElementById('sFee').value),
    session:currentSession
  };
  students.push(st);save('students',students);
  toast(`âœ… ${st.name} registered â€” Class ${st.class}`);
  document.getElementById('regForm').reset();
  document.getElementById('sJoin').value=TODAY;
}

// â•â• STUDENTS â•â•
function displayStudents(){
  const fc=document.getElementById('filterClass').value;
  const list=fc?students.filter(s=>s.class===fc):students;
  const c=document.getElementById('studentsList');
  if(!list.length){c.innerHTML=`<div style="text-align:center;padding:55px;color:var(--muted)"><div style="font-size:2.8em;margin-bottom:10px">ğŸ’</div><p>No students found</p></div>`;return;}
  c.innerHTML=list.map(s=>{
    const pct=getAttPct(s.rollNumber);const days=getPDays(s.rollNumber);
    return`<div class="stud-card">
      <div class="stud-av">${s.name.charAt(0).toUpperCase()}</div>
      <div class="stud-meta">
        <h3>${s.name}</h3>
        <p>Roll: <strong style="color:var(--gold)">${s.rollNumber}</strong> Â· Class <strong>${s.class}</strong> Â· ${s.parentName} Â· ğŸ“ ${s.phoneNumber}</p>
        <p style="margin-top:2px">â‚¹${s.monthlyFee}/mo Â· Joined: ${s.joiningDate}</p>
      </div>
      <span class="ab ${pct<75?'low':''}">${days}d (${pct}%)</span>
      <div style="display:flex;gap:7px;flex-wrap:wrap">
        <button class="btn btn-info btn-sm" onclick="showQR(${s.id})">ğŸ”² QR</button>
        <button class="btn btn-ghost btn-sm" onclick="sendSMS1(${s.id})">ğŸ“±</button>
        <button class="btn btn-err btn-sm" onclick="delStudent(${s.id})">âœ•</button>
      </div>
    </div>`;
  }).join('');
}
function getAttPct(r){const d=Object.keys(attendance);if(!d.length)return 0;return Math.round(d.filter(dd=>attendance[dd][r]).length/d.length*100)}
function getPDays(r){return Object.keys(attendance).filter(d=>attendance[d][r]).length}
function delStudent(id){if(!confirm('Delete this student?'))return;students=students.filter(s=>s.id!==id);save('students',students);displayStudents();toast('ğŸ—‘ï¸ Deleted');}

// â•â• QR CODES â€” FIXED â•â•
function showQR(id){
  const s=students.find(x=>x.id===id);if(!s)return;
  const url=`${BASE_URL}?attendance=${s.rollNumber}`;
  document.getElementById('qrMTitle').textContent=s.name;
  document.getElementById('qrMBody').innerHTML=`
    <div style="text-align:center">
      <div class="qr-wrap">
        <div id="qrc" style="line-height:0"></div>
        <div style="color:#1a1a2e;font-family:'DM Sans',sans-serif">
          <strong>${s.name}</strong><br>
          <span style="font-size:.85em">Roll: ${s.rollNumber} Â· Class ${s.class}</span>
        </div>
      </div>
      <div class="qr-info">ğŸ”— ${url}</div>
      <p style="color:var(--muted);font-size:.8em;margin:10px 0">Scan to auto-mark attendance</p>
      <div class="brow" style="justify-content:center">
        <button class="btn btn-gold" onclick="printQR1('${s.rollNumber}','${s.name.replace(/'/g,'`')}','${s.class}')">ğŸ–¨ï¸ Print</button>
        <button class="btn btn-ghost" onclick="closeM('qrModal')">Close</button>
      </div>
    </div>`;
  openM('qrModal');
  // Wait for DOM, then render QR
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      const el=document.getElementById('qrc');
      if(!el)return;
      el.innerHTML='';
      try{new QRCode(el,{text:url,width:230,height:230,colorDark:'#000000',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.H});}
      catch(ex){el.innerHTML='<div style="color:red;padding:20px;font-size:.85em">QR Error: '+ex.message+'</div>';}
    });
  });
}

function genAllQR(){
  if(!students.length){toast('No students registered');return;}
  document.getElementById('qrMTitle').textContent='All QR Codes';
  document.getElementById('qrMBody').innerHTML=`
    <div style="text-align:center;margin-bottom:18px">
      <button class="btn btn-gold" onclick="window.print()">ğŸ–¨ï¸ Print All</button>
    </div>
    <div id="allQRGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px">
      ${students.map((s,i)=>`
        <div style="background:#fff;border-radius:10px;padding:14px;text-align:center;color:#1a1a2e;break-inside:avoid">
          <div id="aqr${i}" style="margin:0 auto 8px;line-height:0"></div>
          <strong style="font-size:.83em;display:block">${s.name}</strong>
          <span style="font-size:.72em;color:#666">Roll: ${s.rollNumber} Â· Class ${s.class}</span>
        </div>`).join('')}
    </div>`;
  openM('qrModal');
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      students.forEach((s,i)=>{
        const el=document.getElementById('aqr'+i);
        if(!el)return;
        const url=`${BASE_URL}?attendance=${s.rollNumber}`;
        try{new QRCode(el,{text:url,width:150,height:150,colorDark:'#000000',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.H});}
        catch(ex){el.innerHTML='<span style="color:red;font-size:.7em">ERR</span>';}
      });
    });
  });
}

function printQR1(roll,name,cls){
  const url=`${BASE_URL}?attendance=${roll}`;
  const w=window.open('','_blank','width=520,height=620');
  if(!w){alert('Allow pop-ups to print QR');return;}
  w.document.write(`<!DOCTYPE html><html><head><title>QR - ${name}</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
  <style>body{font-family:sans-serif;text-align:center;padding:32px;background:#fff;color:#1a1a2e}
  #qrd{display:inline-block;margin:18px auto;line-height:0}h2{font-size:1.4em;margin-bottom:4px}p{font-size:.88em;color:#666}</style>
  </head><body>
  <h2>Central Public School</h2><h3>${name}</h3>
  <p>Roll: ${roll} Â· Class ${cls}</p>
  <div id="qrd"></div>
  <p style="font-size:.75em;color:#999;word-break:break-all;max-width:300px;margin:0 auto">${url}</p>
  <script>
  window.onload=function(){
    new QRCode(document.getElementById('qrd'),{text:'${url}',width:256,height:256,colorDark:'#000000',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.H});
    setTimeout(function(){window.print();},900);
  };
  <\/script></body></html>`);
}

// â•â• ATTENDANCE â•â•
function markAtt(){
  const roll=document.getElementById('scanIn').value.trim();
  if(!roll)return;
  const s=students.find(x=>x.rollNumber===roll);
  const msg=document.getElementById('attMsg');
  if(!s){
    msg.innerHTML=`<div style="color:var(--err);background:rgba(231,76,60,.1);border-radius:8px;padding:11px">âŒ Roll "${roll}" not found</div>`;
    setTimeout(()=>msg.innerHTML='',3000);return;
  }
  if(!attendance[TODAY])attendance[TODAY]={};
  if(attendance[TODAY][roll]){
    msg.innerHTML=`<div style="color:var(--warn);background:rgba(243,156,18,.1);border-radius:8px;padding:11px">âš ï¸ Already marked: <strong>${s.name}</strong> at ${attendance[TODAY][roll].time}</div>`;
    document.getElementById('scanIn').value='';
    setTimeout(()=>msg.innerHTML='',3000);return;
  }
  const time=new Date().toLocaleTimeString('en-IN');
  attendance[TODAY][roll]={name:s.name,class:s.class,time};
  save('attendance',attendance);
  msg.innerHTML=`<div style="color:var(--ok);background:rgba(46,204,113,.1);border-radius:8px;padding:11px">âœ… <strong>${s.name}</strong> Â· Class ${s.class} Â· ${time}</div>`;
  document.getElementById('scanIn').value='';
  setTimeout(()=>msg.innerHTML='',3000);
  renderTodayAtt();
}
function qrMarkAtt(roll){
  const s=students.find(x=>x.rollNumber===roll);
  if(!s){alert('âŒ Student not found: '+roll);return;}
  if(!attendance[TODAY])attendance[TODAY]={};
  if(attendance[TODAY][roll]){alert(`âš ï¸ Already marked!\n${s.name}\nAt: ${attendance[TODAY][roll].time}`);return;}
  const time=new Date().toLocaleTimeString('en-IN');
  attendance[TODAY][roll]={name:s.name,class:s.class,time};
  save('attendance',attendance);
  alert(`âœ… Attendance Marked!\n${s.name} Â· Class ${s.class}\nTime: ${time}`);
}
function renderTodayAtt(){
  const c=document.getElementById('todayAtt');if(!c)return;
  const day=attendance[TODAY]||{};const present=Object.keys(day);
  if(!present.length){c.innerHTML='<p style="color:var(--muted);text-align:center;padding:20px;font-size:.88em">No attendance marked today</p>';return;}
  c.innerHTML=`<p style="color:var(--muted);font-size:.83em;margin-bottom:12px">${present.length} students present</p>
  <div class="att-grid">${present.map(r=>`<div class="att-card"><h4>${day[r].name}</h4><p>Roll: ${r} Â· Class ${day[r].class}<br>${day[r].time}</p></div>`).join('')}</div>`;
}

// â•â• BILLING â•â•
function loadBillStudents(){
  const cls=document.getElementById('billClass').value;
  const sel=document.getElementById('billStudent');
  sel.innerHTML='<option value="">Choose student</option>';
  if(!cls)return;
  students.filter(s=>s.class===cls).forEach(s=>{sel.appendChild(new Option(`${s.name} â€” ${s.rollNumber}`,s.id));});
}
function startBill(){
  const id=parseInt(document.getElementById('billStudent').value);if(!id)return;
  cb.student=students.find(s=>s.id===id);
  cb.items=[{name:'Monthly Fee',price:cb.student.monthlyFee}];
  const msgs=document.getElementById('chatMsgs');
  msgs.innerHTML=`<div class="msg msg-b"><strong>Bill for ${cb.student.name}</strong><br>Class ${cb.student.class} Â· Roll: ${cb.student.rollNumber}<br>Monthly Fee: â‚¹${cb.student.monthlyFee}<br><em style="color:var(--muted);font-size:.85em">Add more items below</em></div>`;
  refreshPrev();
}
function addItem(){
  const inp=document.getElementById('chatIn').value.trim();
  if(!inp||!cb.student){toast('Select a student first');return;}
  const parts=inp.trim().split(' ');
  const price=parseFloat(parts[parts.length-1]);
  const name=parts.slice(0,-1).join(' ');
  if(!name||isNaN(price)||price<=0){toast('Format: Item Name Price â€” e.g. Books 500');return;}
  cb.items.push({name,price});
  const msgs=document.getElementById('chatMsgs');
  msgs.innerHTML+=`<div class="msg msg-u">${inp}</div><div class="msg msg-b">âœ… Added: ${name} â€” â‚¹${price}</div>`;
  msgs.scrollTop=msgs.scrollHeight;
  document.getElementById('chatIn').value='';
  refreshPrev();
}
function clearBill(){cb={student:null,items:[]};document.getElementById('chatMsgs').innerHTML='<div class="msg msg-b" style="color:var(--muted)">Select a student to start a bill...</div>';document.getElementById('billPreview').innerHTML='';}
function refreshPrev(){
  if(!cb.student)return;
  const total=cb.items.reduce((s,i)=>s+i.price,0);
  const month=document.getElementById('billMonth').value;
  const d=new Date().toLocaleDateString('en-IN');
  document.getElementById('billPreview').innerHTML=buildBillHTML(cb.student,cb.items,total,month,d);
}
function buildBillHTML(st,items,total,month,d){
  return`<div class="bill-print">
    <div class="bp-head"><h2>ğŸ“ CENTRAL PUBLIC SCHOOL</h2>
      <p>Fee Receipt Â· Session ${currentSession.replace('-','â€“')}</p>
      <p style="margin-top:3px;font-size:.82em;color:#777">Date: ${d} Â· Month: <strong>${month}</strong></p></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px;font-size:.9em">
      <p><strong>Student:</strong> ${st.name}</p>
      <p><strong>Roll No:</strong> ${st.rollNumber}</p>
      <p><strong>Class:</strong> ${st.class}</p>
      <p><strong>Parent:</strong> ${st.parentName}</p>
    </div>
    <div>${items.map(i=>`<div class="bp-row"><span>${i.name}</span><span>â‚¹${i.price.toFixed(2)}</span></div>`).join('')}</div>
    <div class="bp-total"><span>Total Amount</span><span>â‚¹${total.toFixed(2)}</span></div>
    <div class="bp-foot">Thank you for your payment Â· Central Public School</div>
  </div>`;
}
function printBill(){
  if(!cb.student){toast('Generate a bill first');return;}
  const total=cb.items.reduce((s,i)=>s+i.price,0);
  const month=document.getElementById('billMonth').value;
  const html=buildBillHTML(cb.student,cb.items,total,month,new Date().toLocaleDateString('en-IN'));
  const pt=document.getElementById('billPrintTarget');
  pt.innerHTML=html;pt.style.display='block';
  window.print();
  setTimeout(()=>{pt.innerHTML='';pt.style.display='none';},2000);
}
function saveBill(){
  if(!cb.student){toast('Generate a bill first');return;}
  const month=document.getElementById('billMonth').value;
  const total=cb.items.reduce((s,i)=>s+i.price,0);
  const bill={
    id:Date.now(),studentId:cb.student.id,studentName:cb.student.name,
    rollNumber:cb.student.rollNumber,class:cb.student.class,
    month,items:[...cb.items],total,
    date:new Date().toLocaleDateString('en-IN'),
    savedAt:new Date().toISOString(),session:currentSession
  };
  bills.push(bill);save('bills',bills);
  toast(`ğŸ’¾ Bill saved â€” ${bill.studentName} Â· ${month}`);
  renderBH();
}

// â•â• BILL HISTORY â•â•
let bhOpen=false;
function toggleBH(){
  bhOpen=!bhOpen;
  document.getElementById('bhPanel').classList.toggle('open',bhOpen);
  document.getElementById('bhBtn').classList.toggle('open',bhOpen);
  if(bhOpen)renderBH();
}
function renderBH(){
  const cls=document.getElementById('bhClass').value;
  const mon=document.getElementById('bhMon').value;
  let f=bills.filter(b=>(!cls||b.class===cls)&&(!mon||b.month===mon));
  const c=document.getElementById('bhContent');
  const s=document.getElementById('bhSum');
  if(!f.length){c.innerHTML='<p style="color:var(--muted);font-size:.83em;text-align:center;padding:38px 0">No bills found</p>';s.innerHTML='';return;}
  const byM={};f.forEach(b=>{if(!byM[b.month])byM[b.month]=[];byM[b.month].push(b);});
  c.innerHTML=MONTHS.filter(m=>byM[m]).map(m=>`
    <div class="bh-month">
      <div class="bh-month-lbl">ğŸ“… ${m}</div>
      ${byM[m].map(b=>`<div class="bh-bc paid">
        <div class="bh-bi">
          <h4>${b.studentName}</h4>
          <p>Class ${b.class} Â· Roll ${b.rollNumber}</p>
          <div class="bh-date">Saved: ${b.date}</div>
          <button class="bh-prbtn" onclick="printHistBill(${b.id})">ğŸ–¨ï¸ Print</button>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700;color:var(--gold);font-size:.93em">â‚¹${b.total.toFixed(0)}</div>
          <button onclick="delBill(${b.id})" style="background:none;border:none;color:var(--err);cursor:pointer;font-size:.72em;margin-top:5px">âœ•</button>
        </div>
      </div>`).join('')}
    </div>`).join('');
  const tot=f.reduce((a,b)=>a+b.total,0);
  s.innerHTML=`<div class="bh-sr"><span style="color:var(--muted)">Bills</span><span>${f.length}</span></div>
  <div class="bh-st"><span>Total Collected</span><span>â‚¹${tot.toFixed(0)}</span></div>`;
}
function delBill(id){if(!confirm('Delete bill?'))return;bills=bills.filter(b=>b.id!==id);save('bills',bills);renderBH();toast('ğŸ—‘ï¸ Bill deleted');}
function printHistBill(id){
  const b=bills.find(x=>x.id===id);if(!b)return;
  const st=students.find(x=>x.id===b.studentId)||{name:b.studentName,rollNumber:b.rollNumber,class:b.class,parentName:'â€”'};
  const html=buildBillHTML(st,b.items,b.total,b.month,b.date);
  const w=window.open('','_blank','width=720,height=820');
  if(!w){alert('Allow pop-ups to print');return;}
  w.document.write(`<!DOCTYPE html><html><head><title>Bill - ${b.studentName}</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
  body{font-family:'DM Sans',sans-serif;background:#fff;padding:30px;color:#1a1a2e}
  .bill-print{max-width:580px;margin:0 auto}
  .bp-head{text-align:center;border-bottom:3px double #1a1a2e;padding-bottom:18px;margin-bottom:18px}
  .bp-head h2{font-family:'Playfair Display',serif;font-size:1.75em;color:#1a1a2e}
  .bp-head p{font-size:.83em;color:#666}
  .bp-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #eee}
  .bp-total{display:flex;justify-content:space-between;font-size:1.25em;font-weight:700;padding:15px 0;border-top:3px double #1a1a2e;margin-top:7px}
  .bp-foot{text-align:center;margin-top:18px;font-size:.78em;color:#999}
  </style></head><body>${html}<script>setTimeout(()=>window.print(),600)<\/script></body></html>`);
}

// â•â• REPORTS â•â•
function showRpt(t){
  document.getElementById('rpt-att').style.display=t==='att'?'block':'none';
  document.getElementById('rpt-coll').style.display=t==='coll'?'block':'none';
  document.getElementById('rpt-att-btn').className='btn btn-'+(t==='att'?'gold':'ghost')+' btn-sm';
  document.getElementById('rpt-coll-btn').className='btn btn-'+(t==='coll'?'gold':'ghost')+' btn-sm';
  if(t==='coll')genColl();
}
function genRpt(){
  const date=document.getElementById('rptDate').value;
  const cls=document.getElementById('rptClass').value;
  if(!date)return;
  const dayA=attendance[date]||{};
  let rel=cls?students.filter(s=>s.class===cls):students;
  const present=rel.filter(s=>dayA[s.rollNumber]);
  const absent=rel.filter(s=>!dayA[s.rollNumber]);
  const pct=rel.length?Math.round(present.length/rel.length*100):0;
  document.getElementById('rptStats').innerHTML=`
    <div class="sc gold"><div class="sc-num">${rel.length}</div><div class="sc-lbl">Total</div></div>
    <div class="sc green"><div class="sc-num">${present.length}</div><div class="sc-lbl">Present</div></div>
    <div class="sc red"><div class="sc-num">${absent.length}</div><div class="sc-lbl">Absent</div></div>
    <div class="sc blue"><div class="sc-num">${pct}%</div><div class="sc-lbl">Rate</div></div>`;
  document.getElementById('rptContent').innerHTML=`
    <h3 style="color:var(--ok);margin-bottom:11px;font-family:'Playfair Display',serif">Present (${present.length})</h3>
    <div class="att-grid">${present.map(s=>`<div class="att-card"><h4>${s.name}</h4><p>Roll: ${s.rollNumber} Â· Class ${s.class}<br>${dayA[s.rollNumber].time}</p></div>`).join('') || '<p style="color:var(--muted)">â€”</p>'}</div>
    <h3 style="color:var(--err);margin:22px 0 11px;font-family:'Playfair Display',serif">Absent (${absent.length})</h3>
    <div class="att-grid">${absent.map(s=>`<div class="att-card absent"><h4>${s.name}</h4><p>Roll: ${s.rollNumber} Â· Class ${s.class}<br>${s.parentName} Â· ${s.phoneNumber}</p></div>`).join('') || '<p style="color:var(--muted)">â€”</p>'}</div>`;
}
function genColl(){
  const mon=document.getElementById('collMonth').value;
  const cls=document.getElementById('collClass').value;
  const f=bills.filter(b=>(!mon||b.month===mon)&&(!cls||b.class===cls));
  const tot=f.reduce((s,b)=>s+b.total,0);
  document.getElementById('collStats').innerHTML=`
    <div class="sc gold"><div class="sc-num">${f.length}</div><div class="sc-lbl">Bills</div></div>
    <div class="sc green"><div class="sc-num">â‚¹${tot.toFixed(0)}</div><div class="sc-lbl">Collected</div></div>
    <div class="sc blue"><div class="sc-num">${[...new Set(f.map(b=>b.class))].length}</div><div class="sc-lbl">Classes</div></div>
    <div class="sc"><div class="sc-num">${f.length?Math.round(tot/f.length):0}</div><div class="sc-lbl">Avg/Bill</div></div>`;
  if(!f.length){document.getElementById('collContent').innerHTML='<p style="text-align:center;color:var(--muted);padding:38px">No data</p>';return;}
  const byM={};MONTHS.forEach(m=>{const mb=f.filter(b=>b.month===m);if(mb.length)byM[m]={count:mb.length,total:mb.reduce((s,b)=>s+b.total,0)};});
  document.getElementById('collContent').innerHTML=`
    <div class="card" style="margin-bottom:16px">
      <h3 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:14px">Monthly Breakdown</h3>
      <table class="mt"><thead><tr><th>Month</th><th>Bills</th><th>Collected</th></tr></thead>
      <tbody>${MONTHS.filter(m=>byM[m]).map(m=>`<tr><td>${m}</td><td>${byM[m].count}</td><td>â‚¹${byM[m].total.toFixed(0)}</td></tr>`).join('')}
      <tr class="tr-tot"><td>TOTAL</td><td>${f.length}</td><td>â‚¹${tot.toFixed(0)}</td></tr></tbody></table>
    </div>
    <div class="card">
      <h3 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:14px">All Bills</h3>
      ${f.map(b=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:7px">
        <div><strong>${b.studentName}</strong><br><span style="font-size:.78em;color:var(--muted)">Class ${b.class} Â· ${b.month} Â· ${b.date}</span></div>
        <div style="display:flex;align-items:center;gap:10px">
          <strong style="color:var(--gold)">â‚¹${b.total.toFixed(0)}</strong>
          <button class="bh-prbtn" onclick="printHistBill(${b.id})">ğŸ–¨ï¸ Print</button>
        </div>
      </div>`).join('')}
    </div>`;
}

// â•â• SMS â•â•
function sendSMS1(id){
  const s=students.find(x=>x.id===id);if(!s)return;
  const msg=prompt(`Send SMS to ${s.parentName} (${s.phoneNumber}):\n\nEnter message:`);
  if(!msg)return;showSMSPrev([s],msg);
}
function showBulkSMS(){
  const msg=prompt('Message to ALL parents:');if(!msg)return;
  showSMSPrev(students.filter(s=>s.phoneNumber),msg);
}
function showSelSMS(){
  document.getElementById('smsMBody').innerHTML=`
    <h3 style="color:var(--gold);margin-bottom:14px">Select Students</h3>
    <div style="display:flex;gap:7px;margin-bottom:10px">
      <button class="btn btn-ghost btn-sm" onclick="document.querySelectorAll('.scb').forEach(c=>c.checked=true)">All</button>
      <button class="btn btn-ghost btn-sm" onclick="document.querySelectorAll('.scb').forEach(c=>c.checked=false)">None</button>
    </div>
    <div class="checklist">${students.filter(s=>s.phoneNumber).map(s=>`<label class="ci">
      <input type="checkbox" class="scb" value="${s.id}">
      <span><strong>${s.name}</strong> Â· ${s.parentName} Â· ${s.phoneNumber} Â· Class ${s.class}</span>
    </label>`).join('')}</div>
    <div class="fg" style="margin-top:14px"><label>Message</label>
      <textarea id="selMsg" class="fc" rows="3" placeholder="Enter message..."></textarea></div>
    <div class="brow">
      <button class="btn btn-gold" onclick="sendSel()">Send â†’</button>
      <button class="btn btn-ghost" onclick="closeM('smsModal')">Cancel</button>
    </div>`;
  openM('smsModal');
}
function sendSel(){
  const ids=[...document.querySelectorAll('.scb:checked')].map(c=>parseInt(c.value));
  const msg=document.getElementById('selMsg').value.trim();
  if(!ids.length||!msg){toast('Select students and enter message');return;}
  closeM('smsModal');
  showSMSPrev(students.filter(s=>ids.includes(s.id)),msg);
}
function showSMSPrev(list,msg){
  document.getElementById('smsMBody').innerHTML=`
    <div style="background:rgba(255,255,255,.05);border-radius:8px;padding:14px;margin-bottom:14px">
      <p style="color:var(--muted);font-size:.79em;margin-bottom:6px">MESSAGE</p>
      <p>${msg}</p>
    </div>
    <p style="color:var(--muted);font-size:.82em;margin-bottom:10px">${list.length} recipient(s)</p>
    <div class="checklist" style="max-height:180px">${list.map(s=>`<div class="ci" style="pointer-events:none"><span>âœ“</span><span>${s.name} Â· ${s.phoneNumber}</span></div>`).join('')}</div>
    <div style="background:rgba(243,156,18,.08);border:1px solid rgba(243,156,18,.28);border-radius:8px;padding:13px;margin-top:14px;font-size:.83em;color:rgba(255,255,255,.7)">
      âš ï¸ Integrate with <strong>MSG91 / Fast2SMS / Twilio</strong> for actual SMS delivery.
    </div>
    <div class="brow">
      <button class="btn btn-gold" onclick="copyNums(${JSON.stringify(list.map(s=>s.phoneNumber))})">ğŸ“‹ Copy Numbers</button>
      <button class="btn btn-ghost" onclick="closeM('smsModal')">Close</button>
    </div>`;
  openM('smsModal');
}
function copyNums(nums){navigator.clipboard.writeText(nums.join(', ')).then(()=>toast('ğŸ“‹ Numbers copied!'));}

// â•â• MODAL HELPERS â•â•
function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.moverlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');});});

// â•â• INIT â•â•
displayStudents();renderBH();renderTodayAtt();
</script>
</body>
</html>