<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Central Public School â€” Management System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--navy:#0f1b2d;--deep:#1a2d4a;--royal:#1e3f6e;--gold:#c9a84c;--gold-light:#e8c96a;--cream:#faf8f3;--white:#fff;--success:#2d9b5a;--danger:#c0392b;--warning:#e67e22;--info:#2471a3;--text-dark:#0f1b2d;--text-mid:#3d5a80;--text-light:#6b8cae;--border:#dde4ed;--shadow:0 4px 24px rgba(15,27,45,.10);--shadow-lg:0 12px 48px rgba(15,27,45,.18)}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--text-dark);min-height:100vh}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.login-box{background:#fff;border-radius:16px;padding:40px;max-width:420px;width:100%;box-shadow:var(--shadow-lg)}
.login-box h1{font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:800;color:var(--navy);text-align:center;margin-bottom:8px}
.login-box p{text-align:center;color:var(--text-light);font-size:.9rem;margin-bottom:30px}
.hdr{background:var(--navy);color:#fff;padding:0 28px;display:flex;align-items:center;justify-content:space-between;height:68px;box-shadow:0 2px 16px rgba(15,27,45,.3);position:sticky;top:0;z-index:200}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:44px;height:44px;background:var(--gold);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo h1{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:800;line-height:1.1}
.logo span{font-size:.68rem;color:var(--gold-light);font-weight:400;letter-spacing:1.5px;text-transform:uppercase;display:block}
.sess-tag{background:rgba(201,168,76,.18);border:1px solid var(--gold);color:var(--gold-light);padding:5px 12px;border-radius:20px;font-size:.75rem;font-weight:500;letter-spacing:.5px}
.app{display:grid;grid-template-columns:210px 1fr;min-height:calc(100vh - 68px)}
.sidebar{background:var(--navy);padding:20px 0;border-right:1px solid rgba(255,255,255,.06)}
.nav-lbl{font-size:.62rem;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text-light);padding:0 18px;margin:14px 0 6px}
.ni{display:flex;align-items:center;gap:10px;padding:11px 18px;cursor:pointer;color:#7a9abf;font-size:.87rem;font-weight:500;border-left:3px solid transparent;transition:all .18s;user-select:none}
.ni:hover{background:rgba(255,255,255,.05);color:#fff}
.ni.active{color:var(--gold-light);background:rgba(201,168,76,.1);border-left-color:var(--gold)}
.ni-ic{font-size:1rem;width:20px;text-align:center}
.mc{padding:28px;overflow-y:auto;max-height:calc(100vh - 68px)}
.page{display:none}.page.active{display:block}
.ph{margin-bottom:24px}
.ph h2{font-family:'Playfair Display',serif;font-size:1.75rem;font-weight:800;color:var(--navy)}
.ph p{color:var(--text-light);font-size:.87rem;margin-top:3px}
.card{background:#fff;border-radius:12px;padding:22px;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:18px}
.ct{font-size:.95rem;font-weight:600;color:var(--navy);margin-bottom:16px;display:flex;align-items:center;gap:7px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.fg{margin-bottom:16px}
.fg label{display:block;margin-bottom:5px;font-size:.75rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg select,.fg textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:.9rem;font-family:'DM Sans',sans-serif;color:var(--text-dark);background:#fff;transition:all .2s;outline:none}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--royal);box-shadow:0 0 0 3px rgba(30,63,110,.08)}
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border:none;border-radius:8px;cursor:pointer;font-size:.85rem;font-weight:600;font-family:'DM Sans',sans-serif;transition:all .18s}
.btn-p{background:var(--royal);color:#fff}.btn-p:hover{background:var(--deep);transform:translateY(-1px);box-shadow:0 4px 12px rgba(30,63,110,.3)}
.btn-g{background:var(--gold);color:var(--navy)}.btn-g:hover{background:var(--gold-light);transform:translateY(-1px)}
.btn-s{background:var(--success);color:#fff}.btn-s:hover{background:#23844a;transform:translateY(-1px)}
.btn-d{background:var(--danger);color:#fff}.btn-d:hover{background:#a93226;transform:translateY(-1px)}
.btn-i{background:var(--info);color:#fff}.btn-i:hover{background:#1a5f88;transform:translateY(-1px)}
.btn-o{background:transparent;border:1.5px solid var(--border);color:var(--text-mid)}.btn-o:hover{border-color:var(--royal);color:var(--royal)}
.btn-sm{padding:6px 12px;font-size:.78rem;border-radius:7px}
.btn-xs{padding:4px 10px;font-size:.73rem;border-radius:6px}
.srow{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.sbox{background:#fff;border-radius:12px;padding:18px 20px;border:1px solid var(--border);box-shadow:var(--shadow)}
.snum{font-family:'Playfair Display',serif;font-size:2rem;font-weight:800;color:var(--navy);line-height:1}
.slbl{font-size:.75rem;color:var(--text-light);margin-top:3px;font-weight:500}
.sic{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;margin-bottom:10px}
.si-b{background:rgba(30,63,110,.1)}.si-g{background:rgba(45,155,90,.1)}.si-r{background:rgba(192,57,43,.1)}.si-gold{background:rgba(201,168,76,.15)}
.sgrid{display:grid;gap:12px}
.sc{background:#fff;border-radius:11px;border:1px solid var(--border);padding:16px 18px;display:flex;align-items:center;gap:16px;box-shadow:var(--shadow);transition:all .18s}
.sc:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}
.av{width:46px;height:46px;border-radius:11px;background:linear-gradient(135deg,var(--royal),var(--deep));display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.1rem;font-weight:700;font-family:'Playfair Display',serif;flex-shrink:0}
.sm{flex:1;min-width:0}
.sm h3{font-size:.93rem;font-weight:700;color:var(--navy)}
.sm .sub{font-size:.77rem;color:var(--text-light);margin-top:3px;display:flex;gap:12px;flex-wrap:wrap}
.bdg{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:.7rem;font-weight:600}
.bdg-c{background:rgba(30,63,110,.1);color:var(--royal)}
.bdg-s{background:rgba(201,168,76,.15);color:#9a6f00}
.bdg-paid{background:rgba(45,155,90,.1);color:var(--success)}
.sa{display:flex;gap:6px;flex-wrap:wrap;flex-shrink:0}
.fbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:flex-end}
.fbar .fg{margin-bottom:0;min-width:140px;flex:1}
.sb{position:relative;flex:2}
.sb input{padding-left:38px!important}
.si{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-light);pointer-events:none}
.modal{position:fixed;inset:0;background:rgba(10,18,30,.75);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter:blur(4px)}
.modal.open{display:flex}
.mbox{background:#fff;border-radius:16px;padding:28px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(10,18,30,.35);animation:mIn .2s ease}
.mbox.mw{max-width:860px}
@keyframes mIn{from{opacity:0;transform:scale(.96) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.mhdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;padding-bottom:14px;border-bottom:1px solid var(--border)}
.mhdr h3{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:800;color:var(--navy)}
.mcl{width:34px;height:34px;border-radius:7px;background:var(--cream);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text-light);transition:all .2s}
.mcl:hover{background:#ffe0dd;color:var(--danger)}
.sin-w{position:relative;margin:18px 0}
.sin-w input{width:100%;padding:14px 18px;font-size:1.05rem;font-family:'DM Mono',monospace;border:2.5px solid var(--royal);border-radius:11px;outline:none;color:var(--navy);transition:all .2s}
.sin-w input:focus{box-shadow:0 0 0 4px rgba(30,63,110,.12)}
.sfeed{padding:12px 16px;border-radius:9px;margin-top:14px;font-size:.92rem;font-weight:500;min-height:54px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:4px}
.sfeed.suc{background:rgba(45,155,90,.1);color:var(--success);border:1px solid rgba(45,155,90,.25)}
.sfeed.err{background:rgba(192,57,43,.1);color:var(--danger);border:1px solid rgba(192,57,43,.2)}
.sfeed.wrn{background:rgba(230,126,34,.1);color:var(--warning);border:1px solid rgba(230,126,34,.2)}
.agrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px}
.ac{padding:11px 14px;border-radius:9px;border:1px solid;display:flex;flex-direction:column;gap:3px}
.ac.pres{background:rgba(45,155,90,.07);border-color:rgba(45,155,90,.25)}
.ac.abs{background:rgba(192,57,43,.05);border-color:rgba(192,57,43,.18)}
.an{font-weight:700;font-size:.87rem;color:var(--navy)}
.as{font-size:.75rem;color:var(--text-light)}
.at{font-family:'DM Mono',monospace;font-size:.77rem;color:var(--text-mid)}
.qrc{display:inline-block;text-align:center;padding:20px 18px;border:2px solid var(--navy);border-radius:12px;background:#fff}
.qrh{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:800;color:var(--navy)}
.qrs{font-size:.72rem;color:var(--text-light);margin:2px 0 10px}
.qrn{font-size:.95rem;font-weight:700;color:var(--navy);margin-top:7px}
.qrroll{font-family:'DM Mono',monospace;font-size:.8rem;color:var(--text-mid)}
.twrap{position:fixed;bottom:24px;right:24px;z-index:3000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--navy);color:#fff;padding:11px 18px;border-radius:9px;font-size:.85rem;font-weight:500;box-shadow:var(--shadow-lg);animation:tIn .25s ease;display:flex;align-items:center;gap:9px;min-width:240px}
@keyframes tIn{from{opacity:0;transform:translateX(28px)}to{opacity:1;transform:translateX(0)}}
.toast.suc{border-left:4px solid var(--success)}.toast.err{border-left:4px solid var(--danger)}.toast.inf{border-left:4px solid var(--info)}
.empty{text-align:center;padding:50px 20px;color:var(--text-light)}
.empty .ei{font-size:2.8rem;margin-bottom:10px}
.tpills{display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap}
.tp{padding:7px 16px;border-radius:20px;font-size:.8rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);color:var(--text-mid);background:#fff;transition:all .18s;font-family:'DM Sans',sans-serif}
.tp.active{background:var(--royal);color:#fff;border-color:var(--royal)}
.tp:hover:not(.active){border-color:var(--royal);color:var(--royal)}
.stab{display:none}.stab.active{display:block}
.sdiv{display:flex;align-items:center;gap:10px;color:var(--text-light);font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin:20px 0 14px}
.sdiv::before,.sdiv::after{content:'';flex:1;height:1px;background:var(--border)}
.crow{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;margin-bottom:16px}
.crow .fg{margin-bottom:0;min-width:150px}
.notice-card{background:#fff;border-radius:11px;border:1px solid var(--border);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
.notice-card h4{color:var(--navy);font-size:.95rem;font-weight:700;margin-bottom:5px}
.notice-card .meta{font-size:.72rem;color:var(--text-light);margin-bottom:8px}
.notice-card .msg{font-size:.85rem;color:var(--text-dark);line-height:1.5}
.stu-check{margin-right:8px;width:18px;height:18px;cursor:pointer}
@media print{body>*:not(#pr){display:none!important}#pr{display:block!important;position:absolute;top:0;left:0;width:100%}.np{display:none!important}}
@media(max-width:860px){.app{grid-template-columns:1fr}.sidebar{display:flex;flex-wrap:wrap;padding:10px;gap:3px}.nav-lbl{display:none}.ni{border-left:none;border-radius:7px;padding:7px 10px;font-size:.78rem}.srow{grid-template-columns:repeat(2,1fr)}.fr{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="loginPage" class="login-wrap">
  <div class="login-box">
    <div class="logo-icon" style="margin:0 auto 16px;width:60px;height:60px;font-size:28px">ğŸ“</div>
    <h1>Central Public School</h1>
    <p>Management System Login</p>
    <form id="loginForm" onsubmit="doLogin(event)">
      <div class="fg">
        <label>Username</label>
        <input type="text" id="loginUser" required placeholder="Enter username">
      </div>
      <div class="fg">
        <label>Password</label>
        <input type="password" id="loginPass" required placeholder="Enter password">
      </div>
      <button type="submit" class="btn btn-p" style="width:100%;justify-content:center">Login</button>
    </form>
    <p style="margin-top:20px;font-size:.78rem;color:var(--text-mid);text-align:center">
      First time setup: Enter any username and password to create your account
    </p>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">
<header class="hdr">
  <div class="logo">
    <div class="logo-icon">ğŸ“</div>
    <div>
      <h1>Central Public School</h1>
      <span>Management System</span>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <span class="sess-tag" id="sessTag">Session 2026â€“27</span>
    <button class="btn btn-d btn-sm" onclick="logout()">Logout</button>
  </div>
</header>

<div class="app">
  <nav class="sidebar">
    <div class="nav-lbl">Main</div>
    <div class="ni active" onclick="goP('dashboard',this)"><span class="ni-ic">ğŸ“Š</span> Dashboard</div>
    <div class="ni" onclick="goP('register',this)"><span class="ni-ic">âœ</span> Register</div>
    <div class="ni" onclick="goP('students',this)"><span class="ni-ic">ğŸ‘¥</span> Students</div>
    <div class="nav-lbl">Operations</div>
    <div class="ni" onclick="goP('attendance',this)"><span class="ni-ic">ğŸ“‹</span> Attendance</div>
    <div class="ni" onclick="goP('billing',this)"><span class="ni-ic">ğŸ’³</span> Billing</div>
    <div class="ni" onclick="goP('notices',this)"><span class="ni-ic">ğŸ“¢</span> Notices</div>
    <div class="ni" onclick="goP('reports',this)"><span class="ni-ic">ğŸ“ˆ</span> Reports</div>
    <div class="nav-lbl">Settings</div>
    <div class="ni" onclick="goP('sessions',this)"><span class="ni-ic">ğŸ“</span> Sessions</div>
    <div class="ni" onclick="goP('settings',this)"><span class="ni-ic">âš™</span> Settings</div>
  </nav>

  <main class="mc">
    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="ph"><h2>Dashboard</h2><p>School overview</p></div>
      <div class="srow" id="dStats"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px">
        <div class="card"><div class="ct">ğŸ“… Today's Attendance</div><div id="dAtt"></div></div>
        <div class="card"><div class="ct">ğŸ’° Recent Bills</div><div id="dBills"></div></div>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="page-register" class="page">
      <div class="ph"><h2>Register Student</h2><p>Add to current session</p></div>
      <div class="card">
        <form id="sForm" onsubmit="regStudent(event)">
          <div class="fr">
            <div class="fg"><label>Student Name *</label><input id="rn" required placeholder="Full name"></div>
            <div class="fg"><label>Class *</label><select id="rc" required onchange="updateRollPreview()"><option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          </div>
          <div class="fr">
            <div class="fg"><label>Date of Birth *</label><input type="date" id="rd" required></div>
            <div class="fg">
              <label>Roll Number *</label>
              <input id="rr" required placeholder="Auto-generated" readonly style="background:#f8f9fa">
              <small style="color:var(--text-light);font-size:.7rem;margin-top:3px;display:block">Auto-assigned for each class</small>
            </div>
          </div>
          <div class="fr">
            <div class="fg"><label>Parent Name *</label><input id="rp" required placeholder="Father/Mother"></div>
            <div class="fg"><label>Phone *</label><input id="rpm" pattern="[0-9]{10}" required placeholder="10 digit mobile"></div>
          </div>
          <div class="fr">
            <div class="fg"><label>Date of Joining *</label><input type="date" id="rj" required></div>
            <div class="fg"><label>Monthly Fee (â‚¹) *</label><input type="number" id="rf" required placeholder="e.g. 1500"></div>
          </div>
          <div class="fg"><label>Address</label><textarea id="ra" rows="2" placeholder="Optional"></textarea></div>
          <div style="display:flex;gap:9px;margin-top:6px">
            <button type="submit" class="btn btn-p">âœ“ Register</button>
            <button type="button" class="btn btn-o" onclick="clrForm()">Clear</button>
          </div>
        </form>
      </div>
    </div>

    <!-- STUDENTS -->
    <div id="page-students" class="page">
      <div class="ph" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div><h2>Students</h2><p><span id="scnt">0</span> total</p></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-o btn-sm" onclick="showDownloadQR()">ğŸ–¼ Download QR Codes</button>
          <button class="btn btn-p btn-sm" onclick="goP('register',document.querySelector('[onclick*=register]'))">+ Add</button>
        </div>
      </div>
      <div class="fbar">
        <div class="sb"><span class="si">ğŸ”</span><input type="text" id="srch" placeholder="Search name, roll..." oninput="renderStudents()"></div>
        <div class="fg"><label>Class</label><select id="fCls" onchange="renderStudents()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        <div class="fg"><label>Session</label><select id="fSess" onchange="renderStudents()"><option value="">All Sessions</option></select></div>
      </div>
      <div id="sGrid" class="sgrid"></div>
    </div>

    <!-- ATTENDANCE -->
    <div id="page-attendance" class="page">
      <div class="ph"><h2>Mark Attendance</h2><p>Scan QR or enter roll number</p></div>
      <div style="max-width:500px;margin:0 auto;text-align:center;padding:16px 0">
        <div style="font-size:3.2rem">ğŸ“·</div>
        <p style="color:var(--text-light);font-size:.88rem;margin:8px 0">Scan QR code or type roll number below</p>
        <div class="sin-w"><input type="text" id="scanIn" placeholder="Roll Number..." onkeydown="if(event.key==='Enter')markAtt()" autocomplete="off"></div>
        <button class="btn btn-p" style="width:100%;justify-content:center;padding:13px" onclick="markAtt()">âœ“ Mark Present</button>
        <div id="sFeed" class="sfeed" style="display:none"></div>
      </div>
      <div class="sdiv">Attendance Log</div>
      <div class="crow">
        <div class="fg"><label>Date</label><input type="date" id="aDate" onchange="renderAttR()"></div>
        <div class="fg"><label>Class</label><select id="aCls" onchange="renderAttR()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        <button class="btn btn-o btn-sm np" onclick="window.print()" style="align-self:flex-end">ğŸ–¼ Print</button>
      </div>
      <div class="srow" id="aStats" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px"></div>
      <div id="aReport"></div>
    </div>

    <!-- BILLING -->
    <div id="page-billing" class="page">
      <div class="ph"><h2>Fee Management</h2><p>Generate, track and print bills</p></div>
      <div class="tpills">
        <div class="tp active" onclick="swBTab('gen',this)">ğŸ“ Generate Bill</div>
        <div class="tp" onclick="swBTab('ov',this)">ğŸ“Š Monthly Overview</div>
        <div class="tp" onclick="swBTab('hist',this)">ğŸ“‚ Bill History</div>
      </div>

      <div id="bt-gen" class="stab active">
        <div class="fr" style="margin-bottom:0">
          <div class="fg"><label>Select Class</label><select id="bCls" onchange="loadBStu()"><option value="">Choose class</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <div class="fg"><label>Select Student</label><select id="bStu" onchange="loadSBill()"><option value="">Choose student</option></select></div>
        </div>
        <div class="fr">
          <div class="fg"><label>Billing Month</label><select id="bMo"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Year</label><select id="bYr"><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option></select></div>
        </div>
        <div id="bPrevW" style="display:none">
          <div id="bPrev"></div>
          <div class="np" style="display:flex;gap:9px;margin-top:14px;justify-content:center">
            <button class="btn btn-s" onclick="saveBill()">ğŸ’¾ Save (Paid)</button>
            <button class="btn btn-p" onclick="printBill()">ğŸ–¼ Print</button>
            <button class="btn btn-g" onclick="sendBillSMS()">ğŸ“± Send SMS</button>
          </div>
        </div>
      </div>

      <div id="bt-ov" class="stab">
        <div class="crow">
          <div class="fg"><label>Month</label><select id="ovMo"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Year</label><select id="ovYr"><option value="2025">2025</option><option value="2026" selected>2026</option><option value="2027">2027</option></select></div>
          <div class="fg"><label>Class</label><select id="ovCls"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <button class="btn btn-p btn-sm" onclick="renderOv()" style="align-self:flex-end">View</button>
        </div>
        <div id="ovList"></div>
      </div>

      <div id="bt-hist" class="stab">
        <div class="crow">
          <div class="fg"><label>Search</label><input type="text" id="hSrch" placeholder="Name or roll..." oninput="renderHist()"></div>
          <div class="fg"><label>Month</label><select id="hMo" onchange="renderHist()"><option value="">All</option><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
          <div class="fg"><label>Class</label><select id="hCls" onchange="renderHist()"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
        </div>
        <div id="hList" class="sgrid"></div>
      </div>
    </div>

    <!-- NOTICES -->
    <div id="page-notices" class="page">
      <div class="ph"><h2>Notice Board</h2><p>Send messages to parents</p></div>
      <div class="card">
        <div class="ct">ğŸ“¢ Send New Notice</div>
        <div class="fg">
          <label>Notice Title</label>
          <input type="text" id="noticeTitle" placeholder="e.g. School Holiday Announcement">
        </div>
        <div class="fg">
          <label>Message</label>
          <textarea id="noticeMsg" rows="4" placeholder="Type your message here..."></textarea>
        </div>
        <div class="fg">
          <label>Send To</label>
          <select id="noticeTo" onchange="noticeTypeChange()">
            <option value="all">All Parents</option>
            <option value="class">Specific Class</option>
            <option value="select">Select Students</option>
          </select>
        </div>
        <div id="noticeClassSelect" class="fg" style="display:none">
          <label>Select Class</label>
          <select id="noticeClass">
            <option value="">Choose class</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
        <div id="noticeStudentSelect" style="display:none">
          <label style="display:block;margin-bottom:8px;font-size:.75rem;font-weight:600;color:var(--text-mid);text-transform:uppercase">Select Students</label>
          <div id="studentCheckList" style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:10px"></div>
        </div>
        <button class="btn btn-p" onclick="sendNotice()">ğŸ“¤ Send Notice</button>
      </div>
      <div class="sdiv">Notice History</div>
      <div id="noticeHistory"></div>
    </div>

    <!-- REPORTS -->
    <div id="page-reports" class="page">
      <div class="ph"><h2>Reports</h2><p>Analytics</p></div>
      <div class="card">
        <div class="ct">ğŸ“Š Attendance Report</div>
        <div class="crow">
          <div class="fg"><label>Date</label><input type="date" id="rDate"></div>
          <div class="fg"><label>Class</label><select id="rCls"><option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div>
          <button class="btn btn-p btn-sm" onclick="renderRpt()" style="align-self:flex-end">Generate</button>
        </div>
        <div id="rCnt"></div>
      </div>
    </div>

    <!-- SESSIONS -->
    <div id="page-sessions" class="page">
      <div class="ph" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
        <div><h2>Session Management</h2><p>Academic year control</p></div>
        <button class="btn btn-p btn-sm" onclick="showNewSession()">+ Create Session</button>
      </div>
      <div id="sessList"></div>
    </div>

    <!-- SETTINGS -->
    <div id="page-settings" class="page">
      <div class="ph"><h2>Settings</h2><p>System configuration</p></div>
      <div class="card">
        <div class="ct">ğŸ” Change Password</div>
        <div class="fg">
          <label>Current Password</label>
          <input type="password" id="currentPass" placeholder="Enter current password">
        </div>
        <div class="fg">
          <label>New Password</label>
          <input type="password" id="newPass" placeholder="Enter new password">
        </div>
        <div class="fg">
          <label>Confirm New Password</label>
          <input type="password" id="confirmPass" placeholder="Confirm new password">
        </div>
        <button class="btn btn-p" onclick="changePassword()">Update Password</button>
      </div>
    </div>

  </main>
</div>
</div>

<!-- MODALS -->
<div id="qrM" class="modal">
  <div class="mbox">
    <div class="mhdr"><h3 id="qrMT">QR Code</h3><button class="mcl" onclick="clsM('qrM')">âœ•</button></div>
    <div id="qrMB"></div>
  </div>
</div>

<div id="downloadQrM" class="modal">
  <div class="mbox">
    <div class="mhdr"><h3>Download QR Codes</h3><button class="mcl" onclick="clsM('downloadQrM')">âœ•</button></div>
    <div class="fg">
      <label>Select Class</label>
      <select id="dlQrCls">
        <option value="">All Classes</option>
        <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
      </select>
    </div>
    <button class="btn btn-p" onclick="generateQRDownload()">Generate QR Codes</button>
  </div>
</div>

<div id="allQrM" class="modal">
  <div class="mbox mw">
    <div class="mhdr"><h3>QR Codes</h3><button class="mcl" onclick="clsM('allQrM')">âœ•</button></div>
    <div class="np" style="text-align:center;margin-bottom:16px"><button class="btn btn-p" onclick="window.print()">ğŸ–¼ Print All</button></div>
    <div id="allQrB"></div>
  </div>
</div>

<div id="newSessionM" class="modal">
  <div class="mbox">
    <div class="mhdr"><h3>Create New Session</h3><button class="mcl" onclick="clsM('newSessionM')">âœ•</button></div>
    <div class="fg">
      <label>Session Name</label>
      <input type="text" id="newSessName" placeholder="e.g. 2027-28">
    </div>
    <p style="font-size:.82rem;color:var(--text-light);margin-bottom:16px">Creating a new session will archive the current session and start fresh.</p>
    <button class="btn btn-p" onclick="createNewSession()">Create Session</button>
  </div>
</div>

<div class="twrap" id="twrap"></div>
<div id="pr" style="display:none"></div>

<script type="module">

/* =========================
   ğŸ”¥ FIREBASE IMPORTS
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  updatePassword
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  setDoc,
  doc,
  getDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* =========================
   ğŸ” FIREBASE CONFIG
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDA67oWl6Kq1kNXLylumXlC7YV5tgrsnBs",
  authDomain: "central-public-school-1cd53.firebaseapp.com",
  projectId: "central-public-school-1cd53",
  storageBucket: "central-public-school-1cd53.firebasestorage.app",
  messagingSenderId: "490014133859",
  appId: "1:490014133859:web:f89fe318d46e3e768c3256"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* =========================
   ğŸŒ GLOBAL STATE
========================= */
let students = [];
let bills = [];
let notices = [];
let currentSession = "";

/* =========================
   ğŸ” AUTH SYSTEM
========================= */
window.doLogin = async function(e){
  e.preventDefault();
  const email = document.getElementById("loginUser").value;
  const pass  = document.getElementById("loginPass").value;

  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(err){
    alert("Invalid email or password");
  }
};

window.logout = async function(){
  await signOut(auth);
};

onAuthStateChanged(auth,(user)=>{
  if(user){
    document.getElementById("loginPage").style.display="none";
    document.getElementById("mainApp").style.display="block";
    initApp();
  }else{
    document.getElementById("loginPage").style.display="flex";
    document.getElementById("mainApp").style.display="none";
  }
});

/* =========================
   ğŸš€ INIT APP
========================= */
async function initApp(){
  await loadSession();
  await loadStudents();
  await loadBills();
  await loadNotices();
}

/* =========================
   ğŸ“ SESSION (settings/system)
========================= */
async function loadSession(){
  const snap = await getDoc(doc(db,"settings","system"));
  if(snap.exists()){
    currentSession = snap.data().currentSession;
    document.getElementById("sessTag").textContent =
      "Session " + currentSession;
  }
}

/* =========================
   ğŸ‘¥ STUDENTS
========================= */
async function loadStudents(){
  const snap = await getDocs(collection(db,"students"));
  students=[];
  snap.forEach(d=>{
    students.push({id:d.id,...d.data()});
  });
}

window.regStudent = async function(e){
  e.preventDefault();

  const student={
    name: rn.value,
    rollNumber: rr.value,
    class: rc.value,
    dob: rd.value,
    parentName: rp.value,
    phoneNumber: rpm.value,
    joiningDate: rj.value,
    monthlyFee: parseFloat(rf.value),
    address: ra.value,
    session: currentSession,
    createdAt: Date.now()
  };

  await addDoc(collection(db,"students"),student);
  alert("Student Added");
  await loadStudents();
};

/* =========================
   ğŸ“‹ ATTENDANCE
========================= */
window.markAtt = async function(){
  const roll = scanIn.value.trim();
  if(!roll) return;

  const student = students.find(s=>s.rollNumber===roll);
  if(!student){
    alert("Student not found");
    return;
  }

  const today = new Date().toISOString().split("T")[0];

  await setDoc(
    doc(db,"attendance",today+"_"+roll),
    {
      rollNumber: roll,
      name: student.name,
      class: student.class,
      date: today,
      time: new Date().toLocaleTimeString("en-IN"),
      session: currentSession
    }
  );

  alert("Attendance Marked");
};

/* =========================
   ğŸ’³ BILLS
========================= */
async function loadBills(){
  const snap = await getDocs(collection(db,"bills"));
  bills=[];
  snap.forEach(d=>{
    bills.push({id:d.id,...d.data()});
  });
}

window.saveBill = async function(){
  if(!cb.student) return alert("Select student");

  const bill={
    studentId: cb.student.id,
    studentName: cb.student.name,
    studentClass: cb.student.class,
    rollNumber: cb.student.rollNumber,
    parentName: cb.student.parentName,
    phone: cb.student.phoneNumber,
    month: parseInt(bMo.value),
    year: parseInt(bYr.value),
    total: cb.items.reduce((a,b)=>a+b.price,0),
    createdAt: Date.now(),
    session: currentSession,
    paid:true
  };

  await addDoc(collection(db,"bills"),bill);
  alert("Bill Saved");
  await loadBills();
};

/* =========================
   ğŸ“¢ NOTICES
========================= */
async function loadNotices(){
  const snap = await getDocs(collection(db,"notices"));
  notices=[];
  snap.forEach(d=>{
    notices.push({id:d.id,...d.data()});
  });
}

window.sendNotice = async function(){
  const notice={
    title: noticeTitle.value,
    message: noticeMsg.value,
    createdAt: Date.now(),
    session: currentSession
  };

  await addDoc(collection(db,"notices"),notice);
  alert("Notice Sent");
  await loadNotices();
};

/* =========================
   ğŸ” CHANGE PASSWORD
========================= */
window.changePassword = async function(){
  const newPass = newPassInput.value;
  await updatePassword(auth.currentUser,newPass);
  alert("Password updated");
};
/* =========================
   ğŸ”§ MAKE UI FUNCTIONS GLOBAL
========================= */

window.goP = goP;
window.swBTab = swBTab;
window.regStudent = regStudent;
window.clrForm = clrForm;
window.markAtt = markAtt;
window.renderStudents = renderStudents;
window.delStu = delStu;
window.qkBill = qkBill;
window.showQR = showQR;
window.prQR = prQR;
window.showDownloadQR = showDownloadQR;
window.generateQRDownload = generateQRDownload;
window.renderAttR = renderAttR;
window.loadBStu = loadBStu;
window.loadSBill = loadSBill;
window.saveBill = saveBill;
window.printBill = printBill;
window.sendBillSMS = sendBillSMS;
window.renderOv = renderOv;
window.renderHist = renderHist;
window.sendNotice = sendNotice;
window.renderNotices = renderNotices;
window.renderRpt = renderRpt;
window.showNewSession = showNewSession;
window.createNewSession = createNewSession;
window.changePassword = changePassword;
window.logout = logout;

</script>

</body>
</html>